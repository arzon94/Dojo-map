// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["dojo/_base/array","dojo/Deferred","../../config","../../tasks/GeometryService","../Polyline","../Polygon","./webMercatorUtils","./spatialReferenceUtils","./jsonUtils"],function(e,n,r,t,i,o,a,s,f){function c(e,n){return Math.ceil((e-n)/(2*n))}function u(e,n){var r,t,i,o=e.paths||e.rings,a=o.length;for(r=0;a>r;r++){var s=o[r];for(i=s.length,t=0;i>t;t++){var f=e.getPoint(r,t);e.setPoint(r,t,f.clone().offset(n,0))}}return e}function h(n,r){if(!(n instanceof i||n instanceof o)){var t="straightLineDensify: the input geometry is neither polyline nor polygon";throw console.error(t),new Error(t)}var a,s=n instanceof i,f=s?n.paths:n.rings,c=[];return e.forEach(f,function(e){c.push(a=[]),a.push([e[0][0],e[0][1]]);var n,t,i,o,s,f,u,h,l,p,g,v;for(s=0;s<e.length-1;s++){if(n=e[s][0],t=e[s][1],i=e[s+1][0],o=e[s+1][1],u=Math.sqrt((i-n)*(i-n)+(o-t)*(o-t)),h=(o-t)/u,l=(i-n)/u,p=u/r,p>1){for(f=1;p-1>=f;f++){var m=f*r;g=l*m+n,v=h*m+t,a.push([g,v])}var x=(u+Math.floor(p-1)*r)/2;g=l*x+n,v=h*x+t,a.push([g,v])}a.push([i,o])}}),s?new i({paths:c,spatialReference:n.spatialReference}):new o({rings:c,spatialReference:n.spatialReference})}function l(e,n,r){var t=1e6;if(n){var i=h(e,t);e=a.webMercatorToGeographic(i,!0)}return r&&(e=u(e,r)),e}function p(e,n,r){var t,i=e.x||e[0];return i>n?(t=c(i,n),e.x?e=e.clone().offset(t*(-2*n),0):e[0]=i+t*(-2*n)):r>i&&(t=c(i,r),e.x?e=e.clone().offset(t*(-2*r),0):e[0]=i+t*(-2*r)),e}function g(n,r){var t=-1;return e.forEach(r.cutIndexes,function(i,o){var a=r.geometries[o],s=a.rings||a.paths;e.forEach(s,function(n,r){e.some(n,function(e){if(e[0]<180)return!0;var t,i,o=0,s=n.length;for(t=0;s>t;t++)i=n[t][0],o=i>o?i:o;o=Number(o.toFixed(9));var f,u=c(o,180),h=-360*u,l=n.length;for(f=0;l>f;f++){var p=a.getPoint(r,f);a.setPoint(r,f,p.clone().offset(h,0))}return!0})}),i===t?a.rings?e.forEach(a.rings,function(e){n[i]=n[i].addRing(e)}):e.forEach(a.paths,function(e){n[i]=n[i].addPath(e)}):(t=i,n[i]=a)}),n}function v(){return y||(y=new t({url:r.geometryServiceUrl})),y}function m(r,t){var h=new n;t||(t=v());var m,x,d,y,w,M,E,R,b=[],P=[],j=0;e.forEach(r,function(n){if(!n)return void b.push(n);if(m||(m=n.spatialReference,x=s.getInfo(m),d=m.isWebMercator,y=d?20037508.342788905:180,w=d?-20037508.342788905:-180,M=d?102100:4326,E=new i({paths:[[[y,w],[y,y]]],spatialReference:{wkid:M}}),R=new i({paths:[[[w,w],[w,y]]],spatialReference:{wkid:M}})),!x)return void b.push(n);var r=f.fromJSON(n.toJSON()),t=n.extent;if("point"===n.type)b.push(p(r,y,w));else if("multipoint"===n.type)r.points=e.map(r.points,function(e){return p(e,y,w)}),b.push(r);else if("extent"===n.type){var a=t.clone()._normalize(null,null,x);b.push(a.rings?new o(a):a)}else if(t){var h=c(t.xmin,w),g=h*(2*y);r=0===g?r:u(r,g),t=t.clone().offset(g,0),t.intersects(E)&&t.xmax!==y?(j=t.xmax>j?t.xmax:j,r=l(r,d),P.push(r),b.push("cut")):t.intersects(R)&&t.xmin!==w?(j=t.xmax*(2*y)>j?t.xmax*(2*y):j,r=l(r,d,360),P.push(r),b.push("cut")):b.push(r)}else b.push(r)});for(var k=new i,S=c(j,y),z=-90,D=S;S>0;){var T=-180+360*S;k.addPath([[T,z],[T,-1*z]]),z=-1*z,S--}return P.length>0&&D>0?t?t.cut(P,k).then(function(n){P=g(P,n);var i=[];e.forEach(b,function(e,n){if("cut"===e){var t=P.shift();r[n].rings&&r[n].rings.length>1&&t.rings.length>=r[n].rings.length?(b[n]="simplify",i.push(t)):b[n]=d===!0?a.geographicToWebMercator(t):t}}),i.length>0?t.simplify(i).then(function(n){e.forEach(b,function(e,r){"simplify"===e&&(b[r]=d===!0?a.geographicToWebMercator(n.shift()):n.shift())}),h.resolve(b)}).otherwise(function(e){h.reject(e)}):h.resolve(b)}).otherwise(function(e){h.reject(e)}):h.reject(new Error("esri.geometry.normalizeCentralMeridian: 'geometryService' argument is missing.")):(e.forEach(b,function(e,n){if("cut"===e){var r=P.shift();b[n]=d===!0?a.geographicToWebMercator(r):r}}),h.resolve(b)),h.promise}function x(e){if(!e)return null;var n=e.extent;if(!n)return null;var r=e.spatialReference&&s.getInfo(e.spatialReference);if(!r)return n;var t=r.valid[0],i=r.valid[1],o=2*i,a=n.width,f=n.xmax,c=n.xmin;if("extent"===e.type||0===a||i>=a||a>o||t>f||c>i)return n;var u;switch(e.type){case"polygon":if(!(e.rings.length>1))return n;u=d(e.rings);break;case"polyline":if(!(e.paths.length>1))return n;u=d(e.paths);break;case"multipoint":u=e.points}for(var h=Math.min,l=Math.max,p=n.clone(),g=0;g<u.length;g++){var v=u[g][0];0>v?(v+=i,c=l(v,c)):(v-=i,f=h(v,f))}return p.xmin=f,p.xmax=c,p.width<a?(p.xmin-=i,p.xmax-=i,p):n}function d(e){for(var n=[],r=0,t=0,i=Math.min,o=Math.max,a=0;a<e.length;a++){for(var s=e[a],f=null,c=0;c<s.length;c++)f=s[c],n.push(f),0===c?(r=f[0],t=r):(r=i(r,f[0]),t=o(t,f[0]));f&&n.push([(r+t)/2,0])}return n}var y;return{_straightLineDensify:h,normalizeCentralMeridian:m,getDenormalizedExtent:x}});