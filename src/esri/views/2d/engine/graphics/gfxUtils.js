// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","../../libs/gl-matrix/mat2d","../../libs/gl-matrix/mat2dExtras","../../../../core/screenUtils","../../../../geometry/Polygon","../../../../symbols/SimpleMarkerSymbol","../../../../symbols/support/gfxUtils"],function(e,t,r,n,i,a,o,l,s){function c(e){return"simple-marker-symbol"===e.type}function u(e){return"picture-marker-symbol"===e.type}function p(e){return"simple-line-symbol"===e.type}function f(e){return"picture-fill-symbol"===e.type}function y(e){return"text-symbol"===e.type}function h(e){return"extent"===e.type}function g(e){return"polygon"===e.type}function d(e){return"polyline"===e.type}function S(e,t){return t.toRgba?(e[0]=t.r,e[1]=t.g,e[2]=t.b,e[3]=t.a):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e}function m(e,t,r){return null!=r&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=r),e}function x(e,t,r){var n=t[0]/t[1];return e[0]=e[1]=1,isNaN(r)||(n>1?(e[0]=r/t[0],e[1]=r/n/t[1]):(e[1]=r/t[1],e[0]=r*n/t[0])),e}function v(e,t,r,o,p,f,h){var g,d,S=p.symbol,m=e.toScreenPoint(F,r,h[0]),v=[m.x,m.y],b=m.x,T=m.y,M=p.heading,_=p.size&&p.size[0];n.identity(R),"number"==typeof _&&(d=isFinite(_)&&_);var L=d&&isFinite(d)&&!isNaN(d);d=L?a.pt2px(d):NaN,f&&i.rotategAt(R,R,f,v),M&&i.rotategAt(R,R,M,v);var Y=a.pt2px(S.xoffset),P=a.pt2px(S.yoffset);if((0!==Y||0!==P)&&n.translate(R,R,[Y,-P]),0!==S.angle&&i.rotategAt(R,R,S.angle,v),c(S)){var z=S.style,O=Math.round;d=L?d:a.pt2px(S.size);var C=void 0;switch(z){case l.STYLE_SQUARE:case l.STYLE_CROSS:case l.STYLE_X:case l.STYLE_DIAMOND:C=isNaN(d)?16:.5*d,g=w(t,o,N(z,b,T,O(b-C),O(b+C),O(T-C),O(T+C)));break;case l.STYLE_PATH:var G=w(t,o,S.path);g=G;var I=G.getBoundingBox(),B=x(n.create(),[I.width,I.height],d);(1!==B[0]||1!==B[3])&&i.scaleAt(R,R,B,v),n.translate(R,R,[-(I.x+.5*I.width)+b,-(I.y+.5*I.height)+T]);break;default:C=isNaN(d)?16:.5*d,g=k(t,o,{cx:b,cy:T,r:C})}}else if(u(S)){var D=L?d:a.pt2px(S.width),U=L?d:a.pt2px(S.height);g=E(t,o,{x:b-.5*D,y:T-.5*U,width:D,height:U,src:S.url})}else if(y(S)){var V=S.font&&S.font.clone();V&&(V.size=L?d:a.pt2px(V.size)),g=A(t,o,{type:"text",text:S.text,x:b,y:T,align:s.getSVGAlign(S),decoration:S.decoration||V&&V.decoration,rotated:S.rotated,kerning:S.kerning}),V&&g.setFont(V);var j=g.getNode(),X=s.getSVGBaseline(S),q=s.getSVGBaselineShift(S);j&&(j.setAttribute("dominant-baseline",X),q&&j.setAttribute("baseline-shift",q))}return g.setTransform(R),g}function b(e,t,r,n,i,a,o){var l=i.symbol,s=r.points,c=n||t.createGroup(),u=[0];c.children[0]&&_(l,c.children[0])&&c.clear();for(var p=0,f=s.length,y=0;f>y;y++)for(var h=s[y],g=o.length,d=0;g>d;d++)u[0]=o[d],c.add(v(e,c,{x:h[0],y:h[1]},c.children[p++],i,a,u));var S=c.children.length;if(s.length*o.length<S)for(var m=s.length*o.length,y=S-1;y>=m;y--)c.children[y].removeShape();return c}function T(e,t,r,n,i){var a=[];if(h(r)&&(r=o.fromExtent(r)),d(r)||g(r)){for(var l=i.length,s=0;l>s;s++)a=a.concat(e.toScreenPath(r,i[s]));n=w(t,n,a)}return n}function M(e,t,r){return t?t.setShape(r):e.createRect(r)}function E(e,t,r){return t?t.setShape(r):e.createImage(r)}function k(e,t,r){return t?t.setShape(r):e.createCircle(r)}function w(e,t,r){var n=Array.isArray(r)?r.join(" "):r;return t?t.setShape(n):e.createPath(n)}function A(e,t,r){return t?t.setShape(r):e.createText(r)}function _(e,t){var r=t&&t.shape&&t.shape.type,n=e&&e.type,i=e&&e.style;return n&&(i=z[n]||i),O[i]&&(i="path"),!(!r||!i||r===i)}function N(e,t,r,n,i,a,o,s){switch(e){case l.STYLE_SQUARE:return["M",n+","+a,i+","+a,i+","+o,n+","+o,"Z"];case l.STYLE_CROSS:return["M",t+","+a,t+","+o,"M",n+","+r,i+","+r];case l.STYLE_X:return["M",n+","+a,i+","+o,"M",n+","+o,i+","+a];case l.STYLE_DIAMOND:return["M",t+","+a,i+","+r,t+","+o,n+","+r,"Z"];case l.STYLE_TARGET:return["M",n+","+a,i+","+a,i+","+o,n+","+o,n+","+a,"M",n-s+","+r,n+","+r,"M",t+","+(a-s),t+","+a,"M",i+s+","+r,i+","+r,"M",t+","+(o+s),t+","+o]}}function L(e,t){var n=t.symbol;if(!u(n)){var i=s.getFill(n);if(c(n)){var a=n.style,o=s.getStroke(n),p=o&&o.color,f=a===l.STYLE_X||a===l.STYLE_CROSS,h=t.opacity,g=t.color||S([0,0,0,0],f?p:i);g&&null!=h&&(g=m([0,0,0,0],g,h)),g&&(f?g!==p&&(o=o?r.mixin({},o):{},o.color=g):g!==i&&(i=g)),e.setFill(i).setStroke(o)}else if(y(n)){var h=t.opacity,g=t.color||S([0,0,0,0],i);g&&null!=h&&(g=m([0,0,0,0],g,h)),g&&g!==i&&(i=g),e.setFill(i)}}}function Y(e,t){for(var r=e.children,n=r.length,i=0;n>i;i++)L(e.children[i],t)}function P(e,t){var n,i=t.symbol,o=t.size,l=t.color,c=t.opacity,u=s.getStroke(i),y=s.getFill(i),h=!1;p(i)?(h=!0,n="none"!==i.style):n=i.outline&&"none"!==i.outline.style;var g,d,x;o&&(x=isFinite(o[0])&&o[0]),null!=o&&(x=a.pt2px(x)),!l&&null==c||f(i)||(h?(g=l||u&&u.color&&S([0,0,0,0],u.color),g&&null!=c&&(g=m(g,g,c))):y&&(d=l||S([0,0,0,0],y),d&&null!=c&&(d=m(d,d,c)))),!n||null==o&&!g?e.setStroke(u):e.setStroke(r.mixin({},u,null!=x?{width:x}:null,g&&{color:g})),e.setFill(d||y),e.rawNode.setAttribute("vector-effect","non-scaling-stroke")}Object.defineProperty(t,"__esModule",{value:!0}),t.getScalingVector=x;var F={x:0,y:0},R=n.create();t.drawPoint=v,t.drawMarkers=b,t.drawShape=T,t.drawRect=M,t.drawImage=E,t.drawCircle=k,t.drawPath=w,t.drawText=A;var z={"picture-marker-symbol":"image","picture-fill-symbol":"path","simple-fill-symbol":"path","simple-line-symbol":"path","text-symbol":"text"},O={square:1,cross:1,x:1,diamond:1,target:1};t.isShapeInvalid=_,t.smsToPath=N,t.stylePoint=L,t.styleMarkers=Y,t.styleShape=P});