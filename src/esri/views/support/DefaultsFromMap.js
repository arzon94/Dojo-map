// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/accessorSupport/decorators","dojo/_base/lang","../../core/lang","../../core/watchUtils","../../core/Accessor","../../core/HandleRegistry","../../geometry/HeightModelInfo"],function(e,t,o,i,n,r,s,a,l,p,h){function c(e){return e.heightModelInfo?e.heightModelInfo:d(e)?s.clone(v):null}function d(e){return null!=e.hasZ?e.hasZ:u(e)}function f(e){return null!=e.layers||u(e)||void 0!==e.heightModelInfo}function u(e){switch(e.type){case"elevation":case"integrated-mesh":case"point-cloud":case"scene":return!0;default:return void 0!==e.hasZ}}var _=y=function(e){function t(t){var o=e.call(this)||this;return o.isSpatialReferenceDone=!1,o.isHeightModelInfoDone=!1,o.isTileInfoDone=!1,o.spatialReference=null,o.extent=null,o.heightModelInfo=null,o.mapCollectionPaths=y.DefaultMapCollectionPaths.slice(),o.tileInfo=null,o._handles=new p,o._waitTask=null,o._isStarted=!1,o}return o(t,e),t.prototype.normalizeCtorArgs=function(e){return e=r.mixin({},e),this._set("view",e.view),delete e.view,e},t.prototype.initialize=function(){var e=this;this.watch("mapCollectionPaths",function(){e._isStarted&&(e.reset(),e.start())})},t.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null,this._isStarted=!1),this._cancelLoading()},t.prototype.reset=function(){this._handles.removeAll(),this._isStarted=!1,this._set("isSpatialReferenceDone",!1),this._set("isHeightModelInfoDone",!1),this._set("isTileInfoDone",!1),this._set("spatialReference",null),this._set("extent",null),this._set("heightModelInfo",null),this._set("tileInfo",null)},t.prototype.start=function(){this._handles.removeAll(),this._isStarted=!0;for(var e=this._updateLayerChange.bind(this),t=0,o=this.mapCollectionPaths;t<o.length;t++){var i=o[t];this._handles.add(a.on(this.view,"map."+i,"change",e,e,e))}},t.prototype.supportedSpatialReferenceForLayer=function(e){return e.spatialReference&&this.view.isSpatialReferenceSupported(e.spatialReference,e)?e.spatialReference:void 0},t.prototype._ownerNameFromCollectionName=function(e){var t=e.lastIndexOf(".");return-1===t?"view":"view."+e.slice(0,t)},t.prototype._ensureLoadedOwnersFromCollectionName=function(e){for(var t,o=this._ownerNameFromCollectionName(e),i=o.split("."),n=0;n<i.length&&(t=this.get(i.slice(0,n+1).join(".")),t);n++)if(t.load&&!t.isFulfilled())return{owner:null,loading:t.load()};return{owner:t}},t.prototype._cancelLoading=function(){this._waitTask=null},t.prototype._updateWhen=function(e){var t=this,o=!0,i=!1,n=e.always(function(){o?i=!0:n===t._waitTask&&t._update()});return o=!1,i||(this._waitTask=n),i},t.prototype._updateLayerChange=function(){this.isSpatialReferenceDone&&!this.spatialReference&&this._set("isSpatialReferenceDone",!1),this._update()},t.prototype._update=function(){var e=this;if(this._cancelLoading(),!this.isSpatialReferenceDone){var t=this._processMapCollections(function(t){return e._processSpatialReferenceSource(t)});t||this._set("isSpatialReferenceDone",!0),this.isSpatialReferenceDone&&!this.spatialReference&&this.defaultSpatialReference&&this._set("spatialReference",this.defaultSpatialReference)}if(null==this.heightModelInfo){var t=!1;this.view.isHeightModelInfoRequired()&&(t=this._processMapCollections(function(t){return e._processHeightModelInfoSource(t)},function(e){return f(e)})),t||this._set("isHeightModelInfoDone",!0)}if(null==this.tileInfo){var t=!1;this.view.isTileInfoRequired()&&(t=this._deriveTileInfo()),t||this._set("isTileInfoDone",!0)}},t.prototype._processMapCollections=function(e,t){for(var o=0,i=this.mapCollectionPaths;o<i.length;o++){var n=i[o],r="map."+n,s=this._ensureLoadedOwnersFromCollectionName(r);if(s.loading&&!this._updateWhen(s.loading))return!0;var a=s.owner;if(!(!a||a.isRejected&&a.isRejected())){var l=this.view.get(r);if(l&&this._processMapCollection(l,e,t))return!0}}return!1},t.prototype._processMapCollection=function(e,t,o){for(var i=0;i<e.length;i++){var n=e.getItemAt(i),r=null!=o&&!o(n);if(!r&&n.load&&!n.isFulfilled()&&!this._updateWhen(n.load()))return!0;if(!r&&(!n.load||n.isResolved())){var s=t(n);if(s)return!0;var a=n;if(a.layers&&this._processMapCollection(a.layers,t))return!0}}return!1},t.prototype._processSpatialReferenceSource=function(e){var t=e.fullExtent,o=this.supportedSpatialReferenceForLayer(e);return!o&&this.extent||!t||this._set("extent",t),o?(this._set("spatialReference",o),this._set("isSpatialReferenceDone",!0),!0):!1},t.prototype._processHeightModelInfoSource=function(e){var t=c(e);return t?(this._set("heightModelInfo",t),this._set("isHeightModelInfoDone",!0),!0):!1},t.prototype._deriveTileInfo=function(){if(!this.isSpatialReferenceDone)return!0;var e=this.get("view.map");if(!e)return!0;var t=e.basemap,o=t&&t.get("baseLayers.0"),i=e.get("layers.0"),n=!1,r=null;return t?t.loaded?o?o.loaded?r=o.tileInfo:(this._updateWhen(o.load()),n=!0):i?i.loaded?r=i.tileInfo:(this._updateWhen(i.load()),n=!0):n=!0:(this._updateWhen(t.load()),n=!0):i&&(i.loaded?r=i.tileInfo:(this._updateWhen(i.load()),n=!0)),r&&!r.spatialReference.equals(this.spatialReference)&&(r=null),n||this._set("tileInfo",r),n},t}(n.declared(l));_.DefaultMapCollectionPaths=["basemap.baseLayers","layers","ground.layers","basemap.referenceLayers"],i([n.property({readOnly:!0})],_.prototype,"isSpatialReferenceDone",void 0),i([n.property({readOnly:!0})],_.prototype,"isHeightModelInfoDone",void 0),i([n.property({readOnly:!0})],_.prototype,"isTileInfoDone",void 0),i([n.property({readOnly:!0})],_.prototype,"view",void 0),i([n.property({readOnly:!0})],_.prototype,"spatialReference",void 0),i([n.property({readOnly:!0})],_.prototype,"extent",void 0),i([n.property({readOnly:!0})],_.prototype,"heightModelInfo",void 0),i([n.property()],_.prototype,"mapCollectionPaths",void 0),i([n.property()],_.prototype,"defaultSpatialReference",void 0),i([n.property({readOnly:!0})],_.prototype,"tileInfo",void 0),_=y=i([n.subclass("esri.views.support.DefaultsFromMap")],_);var y,v=new h({heightModel:"gravity-related-height"});return _});