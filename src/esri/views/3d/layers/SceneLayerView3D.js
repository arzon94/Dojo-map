// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../layers/IntegratedMeshLayer","../../../core/arrayUtils","../../../core/watchUtils","../../../core/promiseUtils","../../../core/Logger","../../../core/Collection","../../../core/lang","dojo/_base/lang","dojox/color/_base","dojo/has","../../layers/LayerView","../../../Graphic","../../../symbols/Symbol3D","../../../tasks/support/Query","./i3s/I3SUtil","./i3s/I3SBinaryReader","./i3s/I3SElevationProvider","./i3s/I3SProjectionUtil","./i3s/I3SQueryEngine","./i3s/Highlights","./i3s/FeatureChangeNotifier","./graphics/graphicUtils","./support/LayerViewUpdatingPercentage","../support/projectionUtils","../support/aaBoundingBox","../webgl-engine/Stage","../webgl-engine/lib/Layer","../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/Object3D","../webgl-engine/lib/Texture","../webgl-engine/materials/Material","./support/attributeUtils","../webgl-engine/lib/Util","../webgl-engine/lib/base64Binary","../lib/glMatrix"],function(e,t,r,i,n,a,o,s,l,d,u,h,c,g,f,p,m,y,_,v,b,I,x,M,O,E,T,A,w,D,C,j,L,F,R,S,P,B,V,N,G){function U(e){return e.getMetadata()}function z(e,t,r,i){var n,a=!1;t.encoding===v.DDS_ENCODING_STRING?n=S.DDS_ENCODING:a=!(V.isPowerOfTwo(e.width)&&V.isPowerOfTwo(e.height));var o=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions}),s=o||t.atlas,l=(r||!s)&&!a,d=s||!t.wrap,u=s&&l&&i;return{mipmap:l,wrapClamp:d,disableAnisotropy:u,encoding:n,noUnpackFlip:!0}}function q(e){return null!=e.featureIds?e.featureIds.length:1}var k=C.ModelContentType,X=d.getLogger("esri.layers.SceneService"),H=!1,Q=!1,Y=!1,J=!1,W=!1,K=[1,1,1,1],Z=[.8,.8,.8],$=[.5,.5,.5],ee=64,te=9,re=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._queryEngine=null,t._controllerCreated=!1,t._highlights=new O(t),t._hasColors=!1,t._hasTextures=!1,t._hasData=!1,t._definitionExpressionErrors=0,t._maxDefinitionExpressionErrors=20,t}return r(t,e),Object.defineProperty(t.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;v.checkSceneLayerValid(this.layer),v.checkSceneLayerCompatibleWithView(this.layer,this.view);var t=this.layer.version,r=!f("trident")||t.major>1||1===t.major&&t.minor>3;this.useCompressedTextures=this.view.has("s3tc")&&r,this._enableAtlasMipMaps=this.view.has("standardDerivatives"),this._disableAtlasAnisotropy=this._enableAtlasMipMaps&&!this.view.has("shaderTextureLOD"),this._initGraphicsController(),this.dbg=!1,this.maxGpuMemory=1e3,this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._colorOverride=null;for(var i=new Uint8Array(256),n=0;n<i.length;n++)i[n]=255;this._whiteTexture=new S(i,"white",{width:8,height:8}),this._stage.add(k.TEXTURE,this._whiteTexture),this._addThisLayerToStage(),this._elevationProvider=new I(this,this._engineLayer),this._layerEventHandles=[s.init(this.layer,"renderer",function(t){return e._rendererChange(t)}),s.watch(this,"fullOpacity",function(t){return e._opacityChange(t)}),s.init(this.layer,"objectIdFilter",function(){return e._filterChange()}),s.init(this,"_controller.parsedDefinitionExpression",function(){return e._filterChange()}),s.init(this.view,"clippingArea",function(){return e._clippingAreaChanged()}),s.init(this,"suspended",function(t){return e.setVisibility(!t)})],this.debugNodeVis=Q,this.debugLODVis=!1},t.prototype.destroy=function(){this._stage.remove(k.TEXTURE,this._whiteTexture.getId()),this._removeThisLayerFromStage();var e=function(e){e.remove()};this._layerEventHandles.forEach(e),this._stage=null,null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._matId2Meta=null,this._texId2Meta=null,this._nodeId2Meta=null},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this._controllerCreated?!(!this._controller||!this._controller.updating):!0},t.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t},t.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},t.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t},t.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},t.prototype.isBundleAlreadyAddedToStage=function(e,t){return this._nodeId2Meta[e.id]&&this._nodeId2Meta[e.id].engineObjectsPerBundle&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle[t]},t.prototype._initGraphicsController=function(){var e=this,t={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:function(t,r){return e.isBundleAlreadyAddedToStage(t,r)},isOverMemory:function(){return e.isOverMemory()},removeNodeData:function(t){return e._removeNodeDataFromStage(t)},removeFeatures:function(t,r){return e._removeFeatures(t,r)},getAddedFeatures:function(t){return e._getAddedFeatures(t)},getAddedNodeIDs:function(){return e._getAddedNodeIDs()},areAllBundlesLoaded:function(t){return e._areAllBundlesLoaded(t)},wholeNodeSwitchEnabled:!0},r={additionalStartNodeLoadingHandler:function(){return e._startNodeLoading()},additionalCancelNodeLoadingHandler:function(){return e.cancelNodeLoading()},getTexturePrefetchFunctions:function(){return{_calcDesiredTextureLOD:function(t,r){return e._calcDesiredTextureLOD(t,r)},_imageIsPartOfTextureBundle:function(t){return e._imageIsPartOfTextureBundle(t)},_matId2Meta:e._matId2Meta,_texId2Meta:e._texId2Meta,useCompressedTextures:function(){return e.useCompressedTextures}}},_nodeDebugVisualizer:this._nodeDebugVisualizer,setPolygonOffset:function(t,r){return e._setPolygonOffset(t,r?1:0)},traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},getLoadedAttributes:function(t){return e.getLoadedAttributes(t)},setAttributeData:function(t,r,i){return e.setAttributeData(t,r,i)}};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){e._controller=t,e._featureChangeNotifier=new E.FeatureChangeNotifier(e,t),t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})}).always(function(){e._controllerCreated=!0,e.notifyChange("updating")})},t.prototype.setMaxGpuMemory=function(e){this.maxGpuMemory=e},t.prototype.setVisibility=function(e){if(this._stage&&this._engineLayer){var t=this._engineLayer.getId(),r=this._stage.getViewContent(),i=r.indexOf(t)>=0;if(!!e===i)return;var n=[t];if(null!=this._nodeDebugVisualizer&&n.push(this._nodeDebugVisualizer.engineLayer.getId()),e){this._stage.addToViewContent(n);var a=this._isIntegratedMesh()?"im":"scene";this.view.elevationProvider.register(a,this._elevationProvider),this._elevationProvider.visibilityChanged()}else this._stage.removeFromViewContent(n),this._elevationProvider.visibilityChanged(),this.view.elevationProvider.unregister(this._elevationProvider)}},t.prototype.getEngineLayer=function(){return this._engineLayer},t.prototype.getStats=function(){var e={nodesInIndex:0,knownFeatures:0,activeMaterials:0,"Total GPU Memory Estimate":this.gpuMemoryEstimate+"MB","Geometry Memory Estimate":this.geoMemoryEstimate+"MB","Texture Memory Estimate":this.texMemoryEstimate+"MB"};if(!this._controller)return e;for(var t=0,r=Object.keys(this._controller.nodeIndex);t<r.length;t++){var i=r[t];e.nodesInIndex++;var n=this._controller.nodeIndex[i];null!=n.features&&(e.knownFeatures+=n.features.length)}return e.activeMaterials=Object.keys(this._matId2Meta).length,e},t.prototype._addThisLayerToStage=function(){var e=this._stage;this._initTexture=new S(null,"i3sInitTexture"),e.add(k.TEXTURE,this._initTexture);var t=this.layer.id,r=new j(t,{},t);this._engineLayer=r,e.add(k.LAYER,r),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),Q&&(this._nodeDebugVisualizer=v.makeNodeDebugVisualizer(e,this.view.renderCoordsHelper,t),window._nodeDebugVisualizer=this._nodeDebugVisualizer)},t.prototype._removeThisLayerFromStage=function(){if(this.cancelNodeLoading(),null!=this._engineLayer){var e=this._stage;if(e.remove(k.TEXTURE,this._initTexture.getId()),null!=this._controller)for(var t in this._controller.nodeIndex)if(this._controller.nodeIndex.hasOwnProperty(t)){var r=this._controller.nodeIndex[t];this._removeNodeDataFromStage(r),delete this._controller.nodeIndex[t]}V.assert(V.objectEmpty(this._nodeId2Meta)),V.assert(V.objectEmpty(this._matId2Meta)),V.assert(V.objectEmpty(this._texId2Meta)),e.remove(k.LAYER,this._engineLayer.getId()),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=void 0,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._engineLayer=void 0,this.gpuMemoryEstimate=0}},t.prototype._startNodeLoading=function(){this._updateAllTextureLOD()},t.prototype.cancelNodeLoading=function(){null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.clear(),this._requestedTexImageIds={}},t.prototype._isAllHidden=function(e){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0;r<t.length;r++)if(!t[r].isAllHidden())return!1;return!0},t.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta[e.id];return t&&1===t.engineObjects.length?U(t.engineObjects[0]).loadedAttributes:void 0},t.prototype.setAttributeData=function(e,t,r){var i=this._nodeId2Meta[e.id];if(i&&1===i.engineObjects.length){var n=i.engineObjects[0],a=U(n);a.loadedAttributes=t,a.attributeData=r,this._setObjectSymbology(n),this._applyFilters(e),this._elevationProvider.visibilityChanged(n)}},t.prototype._createUnitTestData=function(e){var t=this.view.navigation.targetCamera,r=[],i={viewParams:{eye:t.eye,center:t.center,up:t.up,viewMatrix:t.viewMatrix,projectionMatrix:t.projectionMatrix,fovX:t.fovX,viewport:t.viewport,perPixelRatio:t.perPixelRatio},visibleObjects:r},n=e.getAll("objects");for(var a in n){var o=n[a];if(o.getParentLayer()===this._engineLayer){var s=U(o),l=s.features,d=s.i3sNode,u=l.map(function(e){return e.id});u.sort();var h={featureIDs:u,nodeId:d};i.visibleObjects.push(h)}}return console.debug(""+i.visibleObjects.length),JSON.stringify(i)},t.prototype.isOverMemory=function(){if(this.gpuMemoryEstimate>this.maxGpuMemory&&this.gpuMemoryEstimate!==this.warnGpuMemoryEstimate){this.warnGpuMemoryEstimate=this.gpuMemoryEstimate;var e=function(e){return e.toLocaleString(void 0,{maximumFractionDigits:1})+" Mb"};X.warn("GPU Memory Limit exceeded!\nLimit: "+e(this.maxGpuMemory)+" Current: "+e(this.gpuMemoryEstimate)+"\n(Textures: "+e(this.texMemoryEstimate)+" Geometry: "+e(this.geoMemoryEstimate)+")")}return this.gpuMemoryEstimate>this.maxGpuMemory},t.prototype._getAddedFeatures=function(e){var t=this._nodeId2Meta[e];if(null==t)return null;for(var r=[],i=this._nodeId2Meta[e].engineObjects,n=0;n<i.length;n++){var a=i[n];r=r.concat(U(a).features)}return r},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)},t.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var i=this.fullOpacity,n=1-V.clamp(V.fallbackIfUndefined(t.transparency,0),0,1),a=1>n||1>i||e&&h.endsWith(e.channels,"a")||t.useVertexColorAlpha===!0||r;return{opacity:n,layerOpacity:i,transparent:a}},t.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null!=e.doubleSided?e.doubleSided:!0},t.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},t.prototype._createEngineMaterial=function(e,t,r,i,n,a){var o,s;null!=e&&(s=this._texId2Meta[t],o=s&&s.engineTex?s.engineTex.getId():this._initTexture.getId());var l,d,u=r.params,h=V.fallbackIfUndefined(u.diffuse,Z);null!=e&&(d=v.getAppropriateTextureEncoding(e.encoding,this.useCompressedTextures),l=d>-1?e.encoding[d]:e.encoding),"standard"!==r.type&&X.warn("Unknown material type '"+r.type+"', must be 'standard'"),void 0===u.reflectivity&&X.warn("Material parameter 'reflectivity' is missing.");var g=this._isIntegratedMesh(),f={ambient:this._colorOverride||h,diffuse:this._colorOverride||h,specular:V.fallbackIfUndefined(u.specular,$),shininess:V.fallbackIfUndefined(u.shininess,ee),atlasRegions:u.vertexRegions,textureId:o&&this._colorOverride?this._whiteTexture.getId():o,vertexColors:this._hasVertexColors(),symbolColors:this._hasSymbolColors(),flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(u),cullFace:this._calcEngineMaterialCullFaceParams(u),writeStencil:g,receiveSSAO:!g,groundNormalShading:g};if(!g){var p=this._calcEngineMaterialTransparencyParams(e,u);c.mixin(f,p)}var m=new P(f,i);if(m.metadata={i3sMatId:i,i3sTexId:t,i3sTex:e,i3sMatParams:u},null!=e){s?s.usedByEngineMats.push(m):(s={id:t,featureMBS:[],usedByEngineMats:[m],images:e.images,encoding:l,encodingIdx:d,atlas:e.atlas===!0,wrap:"none"!==e.wrap[0]||"none"!==e.wrap[1]},this._texId2Meta[t]=s);for(var y=0;y<n.length;y++){var _=n[y];s.featureMBS.push(_.engineMBS)}if(void 0!==a[t]){if(null==s.engineTex){var b=a[t],I=b.data,x=z(I,s,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);s.engineTex=new S(I,s.id,x),this._stage.add(k.TEXTURE,s.engineTex),s.desiredLOD=a[t].desiredLOD,s.curLOD=s.desiredLOD,this.memEstimateTextureAdded(s.engineTex)}for(var M=s.engineTex.getId(),O=0;O<s.usedByEngineMats.length;O++){var E=s.usedByEngineMats[O];null==this._colorOverride&&E.setParameterValues({textureId:M}),E.metadata.originalTextureId=M}a[t].createdTextureForDomImage(),delete a[t]}else this._updateTextureLOD(s)}return this._matId2Meta[i]||(this._matId2Meta[i]={}),this._matId2Meta[i][t]={engineMat:m,refCount:1},Y&&console.debug("new mat "+m.getId()),m},t.prototype._createVertexArrays=function(e,t){for(var r=e.params.vertexAttributes,i={},n=0,a=Object.keys(r);n<a.length;n++){var o=a[n];if("classification"!==o){var s=r[o],l=b.valueType2TypedArrayClassMap[s.valueType];V.assert(null!=l,"unsupported vertex attribute value type: "+s.valueType),i[o]={data:new l(t,s.byteOffset,s.count*s.valuesPerElement),size:s.valuesPerElement}}}var d=Array.isArray(r.position)?r.position.length/3:r.position.count;if(this._hasVertexColors()&&null==i[V.VertexAttrConstants.COLOR]){var u=new Uint8Array(4*d);i[V.VertexAttrConstants.COLOR]={data:u,size:4};for(var h=0;h<u.length;h++)u[h]=255}if(this._hasSymbolColors()){var u=new Uint8Array(4*d);i[V.VertexAttrConstants.SYMBOLCOLOR]={data:u,size:4}}if(null==i[V.VertexAttrConstants.NORMAL]){var u=new Float32Array(3*d);i[V.VertexAttrConstants.NORMAL]={data:u,size:3}}return i},t.prototype._hasNonWhiteColors=function(e){if("color"in e)for(var t=e.color.data,r=0;r<t.length;r++)if(255!==t[r])return!0;return!1},t.prototype._createEngineMats=function(e,t,r,i,n){for(var a=e.params.components.length,o=new Array(a),s=0;a>s;s++){var l=e.params.components[s],d=l.materialID,u=r.materialDefinitions[d];null!=u.href&&(u=i[u.hrefConcat].materialDefinitions[d]),V.assert(void 0!==u,"geometry wants unknown material "+d);var h=l.textureID||"none",c=void 0;"none"!==h&&((null==r.textureDefinitions||null==r.textureDefinitions[h])&&X.warn("textureDefinitions missing in shared resource"),c=r.textureDefinitions[h]);var g=void 0;if(this._matId2Meta[d]&&this._matId2Meta[d][h]){var f=this._matId2Meta[d][h];g=f.engineMat,f.refCount++,Y&&console.debug("reused mat "+g.getId()+", increased refcount "+f.refCount)}else g=this._createEngineMaterial(c,h,u,d,t,n);o[s]=g}return o},t.prototype._areAllBundlesLoaded=function(e){if(null==this._nodeId2Meta[e.id]||null==this._nodeId2Meta[e.id].engineObjectsPerBundle)return!1;for(var t=0;t<e.featureData.length;t++)if(null==this._nodeId2Meta[e.id].engineObjectsPerBundle[t])return!1;return!0},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._findGraphicNodeAndIndex=function(e){for(var t=B.attributeLookup(e.attributes,this._getObjectIdField()),r=0,i=Object.keys(this._nodeId2Meta);r<i.length;r++)for(var n=i[r],a=this._nodeId2Meta[n].engineObjects,o=0;o<a.length;o++){var s=a[o],l=U(s),d=l.featureIds.indexOf(t);if(-1!==d)return{node:this._controller.nodeIndex[n],nodeId:n,bundleNr:o,index:d}}return null},t.prototype._getGraphicIndices=function(e,t,r){var i=this._nodeId2Meta[e.id].engineObjects;if(!i||!i[t])return[];for(var n=U(i[t]),a=[],o=this._getObjectIdField(),s=0,l=r;s<l.length;s++){var d=l[s],u=B.attributeLookup(d.attributes,o),h=n.featureIds.indexOf(u);-1!==h&&a.push(h)}return a},t.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(null!=t){var r=this._nodeId2Meta[t.nodeId].engineObjects[t.bundleNr],i=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(w.bufferToBuffer(i,this.view.renderSpatialReference,0,i,this.view.spatialReference,0,8)){var n=D.create(D.NEGATIVE_INFINITY);return D.expandBuffer(n,i,0,8),l.resolve({boundingBox:n,screenSpaceObjects:[]})}}return l.reject()},t.prototype.whenGraphicAttributes=function(e,t){var r=this,i=function(){var t=r._findGraphicNodeAndIndex(e);return{node:t.node,indices:[t.index]}};return v.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,i).then(function(e){return e[0]})},t.prototype.getGraphicsFromStageObject=function(e,t){if(this.layer instanceof a)return l.reject();var r=U(e),i=e.getFaceRangeIndexFromTriangleNr(t);if(null!=i&&null!=r.featureIds&&i<r.featureIds.length){var n=this._createGraphic(i,r);return l.resolve(n)}return l.reject()},t.prototype._addBundle=function(e,t,r,i,n,a,o){if(!this._hasTextures&&null!=e.textureData&&e.textureData.length>0&&(this._hasTextures=!0),this._hasData=!0,this.debugNodeVis===!0&&null!=this._nodeDebugVisualizer){var s="grey";switch(e.level){case 1:s="red";break;case 2:s="green";break;case 3:s="blue";break;case 4:s="yellow";break;case 5:s="magenta";break;case 6:s="brown"}this._nodeDebugVisualizer.show(e,this._controller.crsIndex,s)}var l=this._stage,d={};d[k.OBJECT]={},d[k.GEOMETRY]={},d[k.MATERIAL]={},d[k.TEXTURE]={};var u=this._engineLayer,h=u.getId(),c=i[e.sharedResource.hrefConcat];if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[o])return this._applyFilters(e),void(null!=n&&n.done());if(!this.isOverMemory()){if(null==this._nodeId2Meta[e.id]&&(this._nodeId2Meta[e.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[e.id].engineObjectsPerBundle[o]=[],W&&null==this.allUnitTestData&&(this.allUnitTestData={}),null==t)return void(null!=n&&n.done());for(var g=0,f=0;f<t.length;f++){var p=t[f],m=p.faceRanges,y=p.componentOffsets,_=p.geometries,b=p.featureIds,I=p.features,M=i[e.geometryData[o].hrefConcat];V.assert(M instanceof ArrayBuffer,"I3S: geometry data is not an ArrayBuffer"),null==M._isReprojected&&(M._isReprojected={});for(var O=e.id+"|"+I[0].id.toString(),E=[],T=[],A=[],w=void 0,D=function(t){var r=_[t];Y&&console.debug("adding geometry "+t);var n=C._createVertexArrays(r,M);!C._hasColors&&C._hasNonWhiteColors(n)&&(C._hasColors=!0);var o=new F(n,F.DefaultIndices,y||F.DefaultOffsets),s=C._createEngineMats(r,I,c,i,a),l=void 0;W&&(l={},l.inputPositions=N.encode(new Uint8Array(n.position.data.buffer)));var u=M._isReprojected[r.id],h=C._controller.crsIndex,g=C.view.renderSpatialReference,f=C._controller.isMeshPyramid?x.ReprojectionTypes.PER_VERTEX:x.ReprojectionTypes.BOUNDINGBOX;if(w=x.reprojectPoints(f,n.position.data,e.mbs,u,h,C._controller.crsVertex,g),M._isReprojected[r.id]=!0,C._controller.isMeshPyramid){var p={normals:o.vertexAttributes.normal.data,positions:o.vertexAttributes.position.data,normalInd:o.indices.normal,positionInd:o.indices.position},m=C.layer.normalReferenceFrame||"none",b=function(t,r){var i=e.mbs;x.reprojectNormalsPerVertex(t,i,h,r,g)};v.processNormals(p,m,b)}W&&(l.perVertexReprojectedPositions=N.encode(new Uint8Array(n.position.data.buffer)),l.matrices=w,l.mbs=e.mbs,l.crsIndex=C._controller.crsIndex,l.crsVertex=C._controller.crsVertex,l.crsEngine=C.view.renderSpatialReference);var D=w.localTrafo;null!=r.transformation&&(D=G.mat4d.create(r.transformation),G.mat4d.multiply(w.localTrafo,D,D));for(var j=0;j<s.length;j++){var R=s[j];d[k.MATERIAL][R.getId()]=R}var S=new L(o,O+"_"+t);C.memEstimateGeometryAdded(S.getData()),d[k.GEOMETRY][S.getId()]=S,E[t]=S,T[t]=D,A[t]=s,W&&(C.allUnitTestData[S.getId()]=l)},C=this,j=0;j<_.length;++j)D(j);var S={i3sNode:e.id,ceLayer:h,features:I,faceRanges:m,featureIds:b,attributeData:r?r.attributeData:null,loadedAttributes:r?r.loadedAttributes:null,layerId:this.layer.id};g+=q(S);var P=new R({idHint:e.id,name:O,geometries:E,materials:A,transformations:T,castShadow:!0,metadata:S}),B=G.mat4d.create();G.mat4d.identity(B),G.mat4d.multiply(B,w.globalTrafo,B),P.setObjectTransformation(B),this._nodeId2Meta[e.id].engineObjectsPerBundle[o].push(P),this._nodeId2Meta[e.id].engineObjects.push(P),d[k.OBJECT][P.getId()]=P,this._setObjectSymbology(P),this._applyFilters(e),this._highlights.objectCreated(P),this._elevationProvider.objectCreated(P)}if(J){for(var I="",z=this._nodeId2Meta[e.id].engineObjectsPerBundle[o],X=0;X<z.length;X++)for(var Q=U(z[X]).features,K=0;K<Q.length;K++)I+="f "+Q[K].id+" rf "+Q[K].rootFeature+", ";console.debug("_addNodeDataToStage node "+e.id+" bundle "+o+" features "+I)}if(H){var Z=function(e){return Object.keys(e).length};console.log("objs: "+Z(d[k.OBJECT])+" geoms: "+Z(d[k.GEOMETRY])+" mats: "+Z(d[k.MATERIAL])+" texts: "+Z(d[k.TEXTURE]))}l.beginMod();var $=d[k.OBJECT];for(var ee in $)$.hasOwnProperty(ee)&&u.addObject($[ee]);for(var te in d)if(d.hasOwnProperty(te)){var re=d[te];for(var ie in re)if(re.hasOwnProperty(ie)){if(null!=l.get(te,ie))continue;l.add(te,re[ie])}}l.endMod(),null!=n&&n.done(),this.notifyChange("hasTexturesOrVertexColors"),this._featureChangeNotifier.notify(g,0)}},t.prototype._clippingAreaChanged=function(){var e=this,t=[];if(w.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null,this._updateFilters(),this._controller){var r=this._controller.nodeIndex;r&&Object.keys(this._nodeId2Meta).forEach(function(t){return e._applyFilters(r[t])}),this._controller.updateClippingArea(this.view.clippingArea)}},t.prototype._filterChange=function(){if(this._updateFilters(),this._controller){var e=this._controller.nodeIndex;if(e)for(var t=0,r=Object.keys(this._nodeId2Meta);t<r.length;t++){var i=r[t];this._applyFilters(e[i])}}},t.prototype._updateFilters=function(){var e=this,t=[];if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),i="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t,n){return e._objectIdFilter(r,i,n)})}if(this._controller&&this._controller.parsedDefinitionExpression&&this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var n=this._controller.parsedDefinitionExpression,a=this._controller.definitionExpressionFields;t.push(function(t,r){return e._sqlFilter(t,n,a,r)})}this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,e._clippingArea,r)}),this._filters=t},t.prototype._sqlFilter=function(e,t,r,i){var n={},a=new m(null,null,n);a.layer=this.layer;for(var o=0,s=0,l=function(e){for(var l=U(e),u=l.featureIds,h=l.attributeData,c=r.every(function(e){return null!=h[e]}),g=0;g<u.length&&o<i.length;g++)if(i[o]===u[g]){var f=!0;if(c){for(var p=0,m=r;p<m.length;p++){var y=m[p];n[y]=v.getCachedAttributeValue(h[y],g)}f=d._evaluateClause(t,a)}f&&(i[s]=i[o],s++),o++}},d=this,u=0,h=this._nodeId2Meta[e.id].engineObjects;u<h.length;u++){var c=h[u];l(c)}i.length=s},t.prototype._evaluateClause=function(e,t){try{return e.testFeature(t)}catch(r){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&X.error("Error while evaluating definitionExpression: "+r),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&X.error("Further errors are ignored"),!1}},t.prototype._objectIdFilter=function(e,t,r){for(var i=0,n=0;i<r.length;){var a=o.binaryIndexOf(e,r[i])>=0;a===t&&(r[n]=r[i],n++),i++}r.length=n},t.prototype._boundingboxFilter=function(e,t,r){var i=[0,0,0,0];w.mbsToMbs(e.mbs,this._controller.crsIndex,i,this.view.renderSpatialReference);var n=null!=t?v.intersectBoundingBoxWithMbs(t,i):2;if(2!==n)for(var a=0,o=0,s=this._nodeId2Meta[e.id].engineObjects;o<s.length;o++){var l=s[o],d=U(l).featureIds;if(0!==n){var u=l.getObjectTransformation(),h=l.getGeometryRecords()[0].getShaderTransformation();if(G.mat4d.multiply(u,h),0===u[1]&&0===u[2]&&0===u[3]&&0===u[4]&&0===u[6]&&0===u[7]&&0===u[8]&&0===u[9]&&0===u[11]&&1===u[15])for(var c=(t[0]-u[12])/u[0],g=(t[1]-u[13])/u[5],f=(t[2]-u[14])/u[10],p=(t[3]-u[12])/u[0],m=(t[4]-u[13])/u[5],y=(t[5]-u[14])/u[10],_=l.getGeometryRecords()[0].geometry.getData(),b=_.getFaces()[0].indices.position,I=_.getVertexAttr().position.data,x=U(l).faceRanges,M=void 0,O=void 0,E=void 0,T=void 0,A=void 0,D=void 0,C=0;C<x.length&&a<r.length;C+=1)if(r[a]===d[C]){var j=x[C],L=j[0],F=j[1];M=O=E=Number.MAX_VALUE,T=A=D=-Number.MAX_VALUE;for(var R=L;F>=R;R+=1)for(var S=0;3>S;S+=1){var P=3*b[3*R+S],B=I[P],V=I[P+1],N=I[P+2];M=Math.min(B,M),O=Math.min(V,O),E=Math.min(N,E),T=Math.max(B,T),A=Math.max(V,A),D=Math.max(N,D)}var z=M>p||c>T||O>m||g>A||E>y||f>D;z?r.splice(a,1):a++}}else{for(var q=0,C=0;C<d.length&&a+q<r.length;C+=1)r[a+q]===d[C]&&q++;r.splice(a,q)}}},t.prototype._applyFilters=function(e){if(this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0,i=t;r<i.length;r++){var n=i[r];n.unhideAllComponents()}if(0!==this._filters.length){for(var a=[],o=0,s=t;o<s.length;o++){var n=s[o];a=a.concat(U(n).featureIds)}for(var l=a.length,d=0;d<this._filters.length;d++)this._filters[d](e,a);if(a.length!==l)for(var u=0,h=0,c=t;h<c.length;h++)for(var n=c[h],g=n.getGeometryRecords()[0],f=U(n).featureIds,p=0;p<f.length;p+=1){var m=f[p];u>=a.length||a[u]!==m?n.setComponentVisibility(g,p,!1):u++}}}},t.prototype._hideFeatures=function(e,t){for(var r=0,i=this._nodeId2Meta[e.id].engineObjects;r<i.length;r++)for(var n=i[r],a=n.getGeometryRecords()[0],o=U(n).features,s=n.hasComponents(),l=0,d=t;l<d.length;l++)for(var u=d[l],h=0;h<o.length;h++)u===o[h].id&&(s?n.setComponentVisibility(a,h,!1):n.hideAllComponents())},t.prototype._removeFeatures=function(e,t){null!=this._nodeId2Meta[e.id]&&(this._hideFeatures(e,t),this._isAllHidden(e)===!0&&(J&&console.debug("all hidden for node "+e.id+". removing."),this._removeNodeDataFromStage(e)))},t.prototype._removeNodeDataFromStage=function(e){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._stage,r=this._engineLayer,i=0,n=this._nodeId2Meta[e.id].engineObjects,a=0;a<n.length;++a){var o=n[a];this._highlights.objectDeleted(o),this._elevationProvider.objectDeleted(o),i+=q(U(o)),r.removeObject(o);for(var s=o.getGeometryRecords(),l=0;l<s.length;l++){var d=s[l];this.memEstimateGeometryRemoved(d.geometry.getData()),t.remove(k.GEOMETRY,d.geometry.getId());for(var u=0;u<d.materials.length;u++){var h=d.materials[u],c=h.getId(),g=h.metadata.i3sMatId,f=h.metadata.i3sTexId||"none",p=this._matId2Meta[g][f];V.assert(p.refCount>0),p.refCount--,Y&&console.debug("decreased refcount material "+c+" "+("geometry "+l+", count "+p.refCount)),0===p.refCount&&this._removeMaterial(c,f,g,h,t)}}t.remove(k.OBJECT,o.getId())}delete this._nodeId2Meta[e.id],this._featureChangeNotifier.notify(0,i)}},t.prototype._removeMaterial=function(e,t,r,i,n){if(n.remove(k.MATERIAL,e),"none"!==t){var a=this._texId2Meta[t],o=a.usedByEngineMats,s=o.indexOf(i);if(V.assert(s>-1),o[s]=o[o.length-1],o.pop(),o.length<1){var l=a.engineTex;l&&l!==this._initTexture&&(this.memEstimateTextureRemoved(l),n.remove(k.TEXTURE,a.engineTex.getId())),a.engineTex=void 0,a.desiredLOD=-1,a.curLOD=-1,delete this._texId2Meta[t]}}delete this._matId2Meta[r][t],V.objectEmpty(this._matId2Meta[r])&&delete this._matId2Meta[r]},t.prototype._updateAllTextureLOD=function(){for(var e in this._texId2Meta)if(this._texId2Meta.hasOwnProperty(e)){var t=this._texId2Meta[e];this._updateTextureLOD(t)}},t.prototype._calcDesiredTextureLOD=function(e,t){for(var r,i=0,n=0,a=e;n<a.length;n++){var o=a[n],s=G.vec3.dist(o,this._controller.camPos),l=2*o[3],d=l/s*this._controller.screenSizeFactor;d>i&&(i=d)}for(i/=te,r=t.length-1;r>0&&t[r].size<i;)r--;return r},t.prototype._updateTextureLOD=function(e){var t=this;e.desiredLOD=this._calcDesiredTextureLOD(e.featureMBS,e.images);var r=e.curLOD!==e.desiredLOD&&(e.curLOD<0||!e.curLOD||0===e.desiredLOD||e.desiredLOD>e.curLOD||e.desiredLOD<e.curLOD-1);if(r){if(0===e.images.length)return;var i=e.images[e.desiredLOD],n=e.encodingIdx>-1?i.hrefConcat[e.encodingIdx]:i.hrefConcat;if(!this._requestedTexImageIds[i.id]){var a={metadata:{texMeta:e,image:i}};this._requestedTexImageIds[i.id]=!0,this._imageIsPartOfTextureBundle(i)?this._controller.streamDataSupplier.request(n,"binary",a).then(this._extractTextureImageFromBlob.bind(this)):this._controller.streamDataSupplier.request(n,"image",a).then(function(e,r,i,n){t._textureImageLoaded(e,r,n.image,n.texMeta)})}}if(e.engineTex||(e.engineTex=this._initTexture,e.curLOD=-1),this.debugLODVis)for(var o=g.fromHsv(e.desiredLOD/e.images.length*270,100,100).toRgb().map(function(e){return e/255}),s=0;s<e.usedByEngineMats.length;s++){var l=e.usedByEngineMats[s],d={ambient:o,diffuse:o};l.setParameterValues(d)}},t.prototype._extractTextureImageFromBlob=function(e,t,r,i){var n=i.texMeta;if(n.desiredLOD<0||i.image.size>n.images[n.desiredLOD].size)return void delete this._requestedTexImageIds[i.image.id];var a=this;V.assert("binary"===r);var o="";try{var s=0,l=0;n.encodingIdx>-1?(s=i.image.byteOffset[n.encodingIdx],l=i.image.length[n.encodingIdx]):(s=i.image.byteOffset,l=i.image.length);var d=new Uint8Array(t,s,l),u=new Blob([d],{type:n.encoding});o=window.URL.createObjectURL(u)}catch(h){o="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII=",X.error("error loading texture "+e+" "+h)}var c=new Image;c.onerror=function(){window.URL.revokeObjectURL(o),c.src="",c.onerror=void 0,c.onload=void 0},c.onload=function(){a._controller.queueAnimationFrameFunctionCall(a._textureImageLoaded,a,[e,c,i.image,i.texMeta,o],void 0,1),window.URL.revokeObjectURL(o),c.src="",c.onerror=void 0,c.onload=void 0},c.src=o},t.prototype._textureImageLoaded=function(e,t,r,i){if(delete this._requestedTexImageIds[r.id],!(i.desiredLOD<0)){var n=i.images[i.desiredLOD],a=i.images[i.curLOD];if((!this.isOverMemory()||!(null==a||r.size>a.size))&&(!a||r.size>a.size&&r.size<=n.size||r.size<a.size&&r.size>=n.size)){var o=i.engineTex;o&&o!==this._initTexture&&(this.memEstimateTextureRemoved(o),this._stage.remove(k.TEXTURE,i.engineTex.getId()));var s=z(t,i,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);i.engineTex=new S(t,i.id,s),this._stage.add(k.TEXTURE,i.engineTex),i.curLOD=i.desiredLOD,this.memEstimateTextureAdded(i.engineTex);for(var l=i.engineTex.getId(),d=0;d<i.usedByEngineMats.length;d++){var u=i.usedByEngineMats[d];null==this._colorOverride&&u.setParameterValues({textureId:l}),u.metadata.originalTextureId=l}if(r!==n&&(i.curLOD=i.images.indexOf(r),V.assert(i.curLOD>-1),!this._requestedTexImageIds[n.id])){var h={metadata:{texMeta:i,image:n}};this._requestedTexImageIds[n.id]=!0,this._controller.streamDataSupplier.request(n.hrefConcat,"binary",h).then(this._extractTextureImageFromBlob.bind(this))}}}},t.prototype._imageIsPartOfTextureBundle=function(e){return!this._controller.isMeshPyramid},t.prototype._setPolygonOffset=function(e,t){
if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle)for(var r={polygonOffset:t},i=0;i<this._nodeId2Meta[e.id].engineObjectsPerBundle.length;i++)for(var n=this._nodeId2Meta[e.id].engineObjectsPerBundle[i],a=0;a<n.length;a++)for(var o=n[a].getGeometryRecords(),s=0;s<o.length;s++)for(var l=o[s].materials,d=0;d<l.length;d++)l[d].setParameterValues(r)},t.prototype._rendererChange=function(e){this._currentRenderer=e,e&&(e.colorInfo||e.sizeInfo)&&X.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.")},t.prototype._getRenderingInfo=function(e){var t=this._currentRenderer,r=t&&t.getSymbol(e);if(!(r instanceof y))return null;var i,n,a={symbol:r};if(t&&t.visualVariables)for(var o=t.getVisualVariableValues(e),s=0;s<o.length;s++){var l=o[s],d=l.variable.type;"color"===d?i=l.value:"opacity"===d&&(n=l.value)}return i&&(a.color=[i.r/255,i.g/255,i.b/255]),null!=n?a.opacity=n:i&&null!=i.a&&(a.opacity=i.a),a},t.prototype._getSymbolFillColor=function(e){for(var t=0,r=e.symbolLayers.items;t<r.length;t++){var i=r[t];if("fill"===i.type){var n=i.material,a=null!=n?n.color:null;if(null!=a)return[a.r/255,a.g/255,a.b/255,a.a]}}return null},t.prototype._getSymbolFillColorMixMode=function(e){for(var t=0,r=e.symbolLayers.items;t<r.length;t++){var i=r[t];if("fill"===i.type){var n=i.material,a=null!=n?n.colorMixMode:null;if(null!=a)return a}}return null},t.prototype._hasSymbolColors=function(){return!this._isIntegratedMesh()},t.prototype._isIntegratedMesh=function(){return this.layer instanceof a},t.prototype._hasVertexColors=function(){return null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color)},t.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors()){for(var t=U(e),r=t.faceRanges?t.faceRanges.length:1,i=new m(null,null,{}),n=i.attributes,a=this.layer.objectIdField,o=this._currentRenderer&&this._currentRenderer.requiredFields,s=e.geometryRecords[0].geometry.data.vertexAttributes,l=s[V.VertexAttrConstants.SYMBOLCOLOR].data,d=!1,u=new Uint8Array(4),h=0;r>h;h++){if(null!=a&&null!=t.featureIds&&(n[a]=t.featureIds[h]),null!=o&&null!=t.attributeData)for(var c=0,g=o;c<g.length;c++){var f=g[c];t.attributeData[f]&&(n[f]=v.getCachedAttributeValue(t.attributeData[f],h))}var p=this._getRenderingInfo(i),y=null!=t.faceRanges?t.faceRanges[h]:null;if(p){var _=this._getSymbolFillColorMixMode(p.symbol),b=p.color,I=p.opacity;if(null==b||null==I){var x=this._getSymbolFillColor(p.symbol);b=T.overrideColor(b,I,x,x&&x[3],K)}else b=T.overrideColor(b,I,null,null,K);b[3]<1&&(d=!0),v.encodeSymbolColor(b,_,u)}else v.encodeSymbolColor(null,null,u);this._setFaceRangeColor(y,l,u)}e.geometryColorAttrsUpdated(0);for(var M=e.getGeometryRecords(),O=0;O<M.length;O++)for(var E=M[O],A=0;A<E.materials.length;A++){var w=E.materials[A],D=w.getParams().transparent,C=w.getParams().opacity;w.metadata.symbolIsTransparent=d;var j=this._calcEngineMaterialTransparencyParams(w.metadata.i3sTex,w.metadata.i3sMatParams,w.metadata.symbolIsTransparent);(D!==j.transparent||C!==j.opacity)&&w.setParameterValues({transparent:j.transparent,opacity:j.opacity})}}},t.prototype._setFaceRangeColor=function(e,t,r){for(var i=12*e[0],n=12*e[1]+12,a=i;n>a;a+=4)t[a+0]=r[0],t[a+1]=r[1],t[a+2]=r[2],t[a+3]=r[3]},t.prototype._opacityChange=function(e){for(var t in this._matId2Meta)for(var r in this._matId2Meta[t]){var i=this._matId2Meta[t][r].engineMat,n=i.getParams(),a=this._calcEngineMaterialTransparencyParams(i.metadata.i3sTex,i.metadata.i3sMatParams,i.metadata.symbolIsTransparent);(n.transparent!==a.transparent||n.layerOpacity!==a.layerOpacity)&&i.setParameterValues(a)}},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,object:null,bbCorners:new Float64Array(24)};return new M({forAll:function(r,i){var n=function(i,n,a){t.id=i,t.index=n,t.object=a,e._boundingBoxCornerPoints(t.index,t.object,t.bbCorners),r(t)};e._forAllFeatures(n,i)},createGraphic:function(t){return e._createGraphic(t.index,U(t.object))},requestFields:function(t,r,i){var n=function(){var i=e._getGraphicIndices(t.node,t.bundleNr,r);return{node:t.node,indices:i}};return v.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),i,n)},createExtentBuilder:function(){return e._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},t.prototype._createExtentBuilder=function(){var e=this.view.renderSpatialReference,t=this.view.spatialReference,r=D.create(D.NEGATIVE_INFINITY),i=new Float64Array(24);return{add:function(n){w.bufferToBuffer(n.bbCorners,e,0,i,t,0,8)&&D.expandBuffer(r,i,0,8)},getExtent:function(){return D.toExtent(r,t)}}},t.prototype._forAllFeatures=function(e,t,r){for(var i=0,n=Object.keys(this._nodeId2Meta);i<n.length;i++)for(var a=n[i],o=this._nodeId2Meta[a].engineObjects,s=0;s<o.length;s++){var l=o[s];this._forAllFeaturesOfObject(l,e,r),t&&t({node:this._controller.nodeIndex[a],bundleNr:s})}},t.prototype._forAllFeaturesOfObject=function(e,t,r){for(var i=U(e).featureIds,n=e.getGeometryRecords()[0],a=0;a<i.length;a++)if(r||e.getComponentVisibility(n,a)){var o=i[a];t(o,a,e,n)}},t.prototype._createGraphic=function(e,t){var r={};r[this._getObjectIdField()]=t.featureIds[e];for(var i=0,n=Object.keys(t.attributeData);i<n.length;i++){var a=n[i];r[a]=v.getCachedAttributeValue(t.attributeData[a],e)}var o=new m(null,null,r);return o.layer=this.layer,o},t.prototype._boundingBoxCornerPoints=function(e,t,r){for(var i=t.geometries[0].getComponentAABB(e,ne),n=0;8>n;++n)ie[0]=1&n?i[0]:i[3],ie[1]=2&n?i[1]:i[4],ie[2]=4&n?i[2]:i[5],G.mat4d.multiplyVec3(t.objectTransformation,ie),r[3*n]=ie[0],r[3*n+1]=ie[1],r[3*n+2]=ie[2];return r},t.prototype.highlight=function(e,t){var r=this,i=this._highlights;if(e instanceof _){var n=i.acquireSet(t),a=n.set,o=n.handle;return this.queryObjectIds(e).then(function(e){return i.setFeatureIds(a,e)}),o}if("number"==typeof e)return this.highlight([e],t);if(e instanceof m)return this.highlight([e],t);if(e instanceof u&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof m){var s=e,l=s.map(function(e){return B.attributeLookup(e.attributes,r._getObjectIdField())}),d=i.acquireSet(t),h=d.set,o=d.handle;return i.setFeatureIds(h,l),o}if("number"==typeof e[0]){var l=e,c=i.acquireSet(t),h=c.set,o=c.handle;return i.setFeatureIds(h,l),o}}return{remove:function(){}}},t}(n.declared(p,A));i([n.property()],re.prototype,"layer",void 0),i([n.property()],re.prototype,"view",void 0),i([n.property()],re.prototype,"_controller",void 0),i([n.property({dependsOn:["_controller.updating"]})],re.prototype,"updating",void 0),i([n.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],re.prototype,"updatingPercentageValue",void 0),i([n.property({readOnly:!0})],re.prototype,"hasTexturesOrVertexColors",null),re=i([n.subclass("esri.views.3d.layers.SceneLayerView3D")],re);var ie=[0,0,0],ne=[0,0,0,0,0,0];return re});