// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/_base/lang","../../../../Color","../../../../core/screenUtils","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./graphicUtils","../support/FastSymbolUpdates","./objectResourceUtils","../../lib/glMatrix","../../../../symbols/ObjectSymbol3DLayer","../../support/aaBoundingBox","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/materials/Material"],function(e,t,r,i,a,o,s,n,l,c,p,h,u,d,m,y,_,f,g,v){var b=d.mat4d,M=d.vec3d,S=[1,1,1],P=[1,1,1,1],x=[0,0,0],O=[-.5,-.5,-.5,.5,.5,.5],E=[-.5,-.5,0,.5,.5,1],C=[-.5,-.5,0,.5,.5,.5],U={sphere:O,cube:O,cylinder:E,cone:E,"inverted-cone":E,tetrahedron:C,diamond:O},R=[_.ModelContentType.MATERIAL,_.ModelContentType.TEXTURE,_.ModelContentType.GEOMETRY],z=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){var e=this.symbol,t=this._getStageIdHint();if(!this._isPropertyDriven("size")){var r=p.validateSymbolLayerSize(this.symbol);if(r)return this._logWarning(r),void this.reject()}if(e.resource&&e.resource.href)this._prepareModelResources(e.resource.href,t);else{var i=e.resource?e.resource.primitive:"sphere";this._preparePrimitiveResources(i,t)}},t.prototype._preparePrimitiveResources=function(e,t){var r=this.symbol;if("sphere"===e)this._geometryData=g.createPolySphereGeometry(.5,2,!0);else if("cube"===e)this._geometryData=g.createBoxGeometry(1);else if("cylinder"===e)this._geometryData=g.createCylinderGeometry(1,.5,32,[0,0,1],[0,0,.5]);else if("cone"===e)this._geometryData=g.createConeGeometry(1,.5,15,!1),g.cgToGIS(this._geometryData);else if("inverted-cone"===e)this._geometryData=g.createConeGeometry(1,.5,15,!0),g.cgToGIS(this._geometryData);else if("tetrahedron"===e)this._geometryData=g.createTetrahedronGeometry(1),g.cgToGIS(this._geometryData);else{if("diamond"!==e)return this._logWarning("Unknown object symbol primitive: "+e),void this.reject();this._geometryData=g.createDiamondGeometry(1),g.cgToGIS(this._geometryData)}this._geometry=new f(this._geometryData,t),this._context.stage.add(_.ModelContentType.GEOMETRY,this._geometry),this._resourceBoundingBox=U[e],this._resourceSize=y.size(this._resourceBoundingBox),this._symbolSize=p.computeSizeWithResourceSize(this._resourceSize,r);var s=this._getMaterialOpacity(),n={specular:[0,0,0],shininess:3,opacity:s,transparent:1>s||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:S,diffuse:S},l=this.symbolContainer;if("point-symbol-3d"===l.type&&l.verticalOffset){var c=l.verticalOffset,u=c.screenLength,d=c.minWorldLength,m=c.maxWorldLength;n.verticalOffset={screenLength:o.pt2px(u),minWorldLength:d||0,maxWorldLength:null!=m?m:1/0},n.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(n.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._isPropertyDriven("color"))n.externalColor=P;else{var b=r.material?a.toUnitRGBA(r.material.color):P;n.externalColor=b}r.material&&r.material.colorMixMode&&(n.colorMixMode=r.material.colorMixMode),this._fastUpdates=h.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(i.mixin(n,this._fastUpdates.materialParameters),n.instanced.push("featureAttribute")):this._hasPerInstanceColor()&&n.instanced.push("color"),this._material=new v(n,t+"_objectmat"),this._context.stage.add(_.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype._prepareModelResources=function(e,t){var r=this,a=["transformation"],s={instanced:a},n={materialParamsMixin:s,idHint:t,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=h.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(i.mixin(n.materialParamsMixin,this._fastUpdates.materialParameters),a.push("featureAttribute")):this._hasPerInstanceColor()&&a.push("color");var l=this.symbolContainer;if("point-symbol-3d"===l.type&&l.verticalOffset){var c=l.verticalOffset,d=c.screenLength,m=c.minWorldLength,f=c.maxWorldLength;n.materialParamsMixin.verticalOffset={screenLength:o.pt2px(d),minWorldLength:m||0,maxWorldLength:null!=f?f:1/0},n.materialParamsMixin.castShadows=!1}this._symbolLoaderPromise=u.fetch(e,n),this._symbolLoaderPromise.then(function(e){if(r._symbolLoaderPromise=null,!r.isRejected()){var t=r._context,i=e.stageResources,a=t.stage,o=r.symbol.material,s=r._getExternalColorParameters(o),n=r._getMaterialOpacity(),l=r._isPropertyDriven("opacity"),c=i[_.ModelContentType.MATERIAL];e.originalMaterialOpacities=new Array(c.length),c.forEach(function(r,i){var a=r.getParameterValues();r.setParameterValues(s),e.originalMaterialOpacities[i]=a.opacity,a.opacity*=n,a.transparent=a.opacity<1,r.setParameterValues({opacity:a.opacity,transparent:a.transparent||l}),t.screenSizePerspectiveEnabled&&(a.screenSizePerspective=t.sharedResources.screenSizePerspectiveSettings,r.setParameterValues({screenSizePerspective:a.screenSizePerspective}))}),R.forEach(function(e){for(var t=i[e],r=0;t&&r<t.length;r++)a.add(e,t[r])}),r._resourceBoundingBox=u.computeBoundingBox(e),r._resourceSize=y.size(r._resourceBoundingBox),r._pivotOffset=e.pivotOffset,r._symbolSize=p.computeSizeWithResourceSize(r._resourceSize,r.symbol),r._i3sModel=e,h.updateFastSymbolUpdatesState(r._fastUpdates,r._context.renderer,r._fastVisualVariableConvertOptions())&&c.forEach(function(e){return e.setParameterValues(r._fastUpdates.materialParameters)}),r.resolve()}},function(){r._symbolLoaderPromise=null,r.isFulfilled()||r.reject()})},t.prototype._forEachMaterial=function(e){if(this._i3sModel){var t=this._i3sModel.stageResources[_.ModelContentType.MATERIAL];t.forEach(e)}else e(this._material)},t.prototype._getExternalColorParameters=function(e){var t={};return e&&e.colorMixMode&&(t.colorMixMode=e.colorMixMode),this._isPropertyDriven("color")?t.externalColor=P:e&&e.color?t.externalColor=a.toUnitRGBA(e.color):(t.externalColor=P,t.colorMixMode="ignore"),t},t.prototype.destroy=function(){this.isFulfilled()||this.reject(),this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var e=this._context.stage;if(this._i3sModel){var t=this._i3sModel.stageResources;R.forEach(function(r){for(var i=t[r],a=0;i&&a<i.length;a++)e.remove(r,i[a].getId())})}else this._material&&e.remove(_.ModelContentType.MATERIAL,this._material.getId()),this._geometry&&e.remove(_.ModelContentType.GEOMETRY,this._geometry.getId())},t.prototype._getGeometry=function(e){var t=e.geometry;return"polyline"===t.type?c.placePointOnPolyline(t):"polygon"===t.type?c.placePointOnPolygon(t):"extent"===t.type?t.center:"point"!==t.type?(this._logWarning("unsupported geometry type for object symbol: "+t.type),null):t},t.prototype.createGraphics3DGraphic=function(e,t){var r=this._getGeometry(e);if(null===r)return null;var i="graphic"+e.uid,a=this.getGraphicElevationInfo(e);return this._createAs3DShape(e,r,t,a,i,e.uid)},t.prototype.layerPropertyChanged=function(e,t,r){var i=this;if("opacity"===e){var a=this._isPropertyDriven("opacity");if(this._i3sModel){var o=this._getMaterialOpacity(),s=this._i3sModel.stageResources[_.ModelContentType.MATERIAL];s.forEach(function(e,t){var r=i._i3sModel.originalMaterialOpacities[t],s=r*o;e.setParameterValues({opacity:s,transparent:1>s||a})})}else{var n=this._getMaterialOpacity();this._material.setParameterValues({opacity:n,transparent:1>n||a})}return!0}if("elevationInfo"===e){this._updateElevationInfo();for(var l in t){var p=t[l],h=r(p);if(h){var u=p.graphic,d=this.getGraphicElevationInfo(u);h.needsElevationUpdates=c.needsElevationUpdates3D(d.mode),h.elevationInfo.set(d)}}return!0}return!1},t.prototype.applyRendererDiff=function(e,t,r,i){var a=this;for(var o in e.diff)switch(o){case"visualVariables":if(!h.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._forEachMaterial(function(e){return e.setParameterValues(a._fastUpdates.materialParameters)});break;default:return!1}return!0},t.prototype._createAs3DShape=function(e,t,r,i,a,o){var s,u=this,d=null,m=null,y=this._getFastUpdateAttrValues(e);y&&(d=d||{},d.featureAttribute=y,m=function(e){return h.evaluateModelTransform(u._fastUpdates.materialParameters,d.featureAttribute,e)}),!this._fastUpdates.enabled&&this._hasPerInstanceColor()&&(d=d||{},d.color=p.mixinColorAndOpacity(r.color,r.opacity));var f=this._context.layer.id,g=b.identity();if(this._applyObjectRotation(r,g),this._applyObjectRotation(this.symbol,g),this._applyObjectScale(r,g),this._applyAnchor(g),this._i3sModel){for(var v=this._i3sModel.stageResources[_.ModelContentType.GEOMETRY],M=this._i3sModel.materialsByComponent,S=new Array(v.length),P=0;P<g.length;P++)S[P]=g;s=c.createStageObjectForPoint.call(this,t,v,M,S,d,i,a,f,o,null,m)}else s=c.createStageObjectForPoint.call(this,t,[this._geometry],[[this._material]],[g],d,i,a,f,o,null,m);if(null===s)return null;if(this._fastUpdates.enabled){var x=h.getMaterialParams(this._fastUpdates.visualVariables,this._fastVisualVariableConvertOptions());this._forEachMaterial(function(e){return e.setParameterValues(x)})}s.object.setCastShadow(!0);var O=l.perObjectElevationAligner,E=new n(this,s.object,null,null,null,O,i,n.VisibilityModes.REMOVE_OBJECT);return E.alignedTerrainElevation=s.terrainElevation,E.needsElevationUpdates=c.needsElevationUpdates3D(i.mode),c.extendPointGraphicElevationInfo(E,t,this._context.elevationProvider),E},t.prototype._applyObjectScale=function(e,t){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var r=this._isPropertyDriven("size")&&e.size?e.size:this._symbolSize,i=p.computeObjectScale(r,this._symbolSize,this._resourceSize,this._context.renderCoordsHelper.unitInMeters);(1!==i[0]||1!==i[1]||1!==i[2])&&b.scale(t,i)}},t.prototype._applyObjectRotation=function(e,t){return this._fastUpdates.enabled&&this._fastUpdates.customTransformation&&e instanceof m?void 0:p.computeObjectRotation(e.heading,e.tilt,e.roll,t)},t.prototype._computeAnchor=function(){switch(this.symbol.anchor){case"center":return M.scale(y.center(this._resourceBoundingBox),-1);case"bottom":var e=y.center(this._resourceBoundingBox);return[-e[0],-e[1],-this._resourceBoundingBox[2]];case"origin":default:return this._pivotOffset?M.scale(this._pivotOffset,-1,new Array(3)):x}},t.prototype._applyAnchor=function(e){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var t=this._computeAnchor();t&&b.translate(e,t)}},t.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")},t.prototype._supportsShaderVisualVariables=function(){return this._context.stage.has("angleInstancedArrays")?!0:!1},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._resourceBoundingBox?y.size(this._resourceBoundingBox):S,t=this._resourceBoundingBox?this._computeAnchor():x,r=this._context.renderCoordsHelper.unitInMeters,i=p.computeObjectScale(this._symbolSize,this._symbolSize,this._resourceSize,r),a=[this.symbol.tilt||0,this.symbol.roll||0,this.symbol.heading||0];return{modelSize:e,symbolSize:this._symbolSize||S,unitInMeters:r,transformation:{anchor:t,scale:i,rotation:a}}},t}(s);return z.PRIMITIVE_BOUNDING_BOX=U,z});