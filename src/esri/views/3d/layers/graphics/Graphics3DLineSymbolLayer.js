// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DDrapedGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./lineUtils","../../../../core/screenUtils","../../../../geometry/Polygon","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/RenderGeometry","./graphicUtils"],function(e,t,r,i,n,a,o,s,l,h,p,u,g,y,c,d,v){var m=u.vec3d,_=u.mat4d,f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){var e=this.symbol,t=this._isPropertyDriven("size")||this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),r={idHint:this._getStageIdHint(),width:this._getWidth(e),color:this._getMaterialOpacityAndColor()};if(!this._isPropertyDriven("size")){var i=v.validateSymbolLayerSize(r.width);if(i)return this._logWarning(i),void this.reject()}if(t||r.width>=1.5)this._isPropertyDriven("size")&&(r.width=0),this._isNativeLineMaterial=!1,this._material=l.createRibbonMaterial(r);else{if(!(r.width>0))return void this.reject();this._isNativeLineMaterial=!0,this._material=l.createNativeMaterial(r)}this._context.stage.add(g.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype._getWidth=function(e){return null!=e.size?h.pt2px(e.size):1},t.prototype.destroy=function(){this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(g.ModelContentType.MATERIAL,this._material.getId()),this._material=null)},t.prototype.createGraphics3DGraphic=function(e,t){var r=e.geometry;if("polyline"!==r.type&&"polygon"!==r.type&&"extent"!==r.type)return this._logWarning("unsupported geometry type for line symbol: "+r.type),null;var i="polygon"===r.type||"extent"===r.type?"rings":"paths",n="graphic"+e.uid,a=this._getVertexOpacityAndColor(t,Float32Array,255),o=0;t.size&&this._isPropertyDriven("size")&&(o=s.getSingleSizeDriver(t.size),o=h.pt2px(o));var l=this.getGraphicElevationInfo(e);return"on-the-ground"===l.mode?this._createAsOverlay(e,i,a,o,l,n):this._createAs3DShape(e,i,a,o,l,n,e.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){if(this._isNativeLineMaterial){var i=this._material.getColor();i[3]=this._getMaterialOpacity(),this._material.setColor(i)}else{var n=this._material.getParameterValues();n.color[3]=this._getMaterialOpacity(),this._material.setParameterValues({color:n.color})}return!0}if("elevationInfo"===e){var a=this._elevationInfo.mode;this._updateElevationInfo();var o=this._elevationInfo.mode;if(null==a||null==o)return!1;if("on-the-ground"===a&&"on-the-ground"===o)return!0;if(a!==o&&("on-the-ground"===a||"on-the-ground"===o))return!1;var l=s.needsElevationUpdates2D(o);for(var h in t){var p=t[h],u=r(p);if(u&&!u.isDraped()){var g=p.graphic;u.needsElevationUpdates=l,u.elevationInfo.set(this.getGraphicElevationInfo(g))}}return!0}return!1},t.prototype._getOutlineGeometry=function(e,t){return e._outlineSegments?l.createOutlineGeometryFromSegments(t,e._outlineSegments):t},t.prototype._getGeometry=function(e){var t=e.geometry;return"extent"===t.type&&(t=p.fromExtent(t)),t},t.prototype._createAs3DShape=function(e,t,r,i,a,h,p){var u=this._getGeometry(e),g=u.hasZ,d=u[t],v=this._getOutlineGeometry(u,d);if(v.length>0){for(var f=[],x=[],E=[],D=m.create(),b=new Array(6),G=s.getGeometryVertexData3D(v,g,u.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,a),w=G.geometryData.outlines,S=G.eleVertexData,A=G.vertexData,M=0;M<w.length;++M){var P=w[M],O=P.index,R=P.count;if(!this._context.clippingExtent||(s.computeBoundingBox(S,O,R,b),!s.boundingBoxClipped(b,this._context.clippingExtent))){s.chooseOrigin(A,O,R,D),s.subtractCoordinates(A,O,R,D);var C=new Float64Array(S.buffer,3*O*S.BYTES_PER_ELEMENT,3*R),I=new Float64Array(A.buffer,3*O*A.BYTES_PER_ELEMENT,3*R),L=l.createPolylineGeometry(I,C,"rings"===t,r,i),T=new c(L,h+"path"+M);T.singleUse=!0,f.push(T),x.push([this._material]);var z=_.identity();_.translate(z,D,z),E.push(z)}}if(f.length>0){var B=this._context.layer.id,N=new y({geometries:f,materials:x,transformations:E,castShadow:!1,metadata:{layerId:B,graphicId:p},idHint:h}),U=o.perVertexElevationAligner,V=new n(this,N,f,null,null,U,a);return V.alignedTerrainElevation=G.terrainElevation,V.needsElevationUpdates=s.needsElevationUpdates2D(a.mode),V}}return null},t.prototype._createAsOverlay=function(e,t,r,i,n,o){var h=this._getGeometry(e);this._material.setRenderPriority(this._symbolLayerOrder);var p=h[t],u=this._getOutlineGeometry(h,p);if(u.length>0){for(var g=[],y=new Array(6),c=m.create(),v=s.getGeometryVertexDataDraped(u,h.spatialReference,this._context.overlaySR),f=v.vertexData,x=v.geometryData.outlines,E=0;E<x.length;++E){var D=x[E],b=D.index,G=D.count;if(s.computeBoundingBox(f,b,G,y),!s.boundingBoxClipped(y,this._context.clippingExtent)){s.chooseOrigin(f,b,G,c),s.subtractCoordinates(f,b,G,c),s.setZ(f,b,G,this._getDrapedZ());var w=new Float64Array(f.buffer,3*b*f.BYTES_PER_ELEMENT,3*G),S=_.identity();_.translate(S,c,S);var A=l.createPolylineGeometry(w,null,"rings"===t,r,i),M=new d(A);M.material=this._material,M.center=[.5*(y[0]+y[3]),.5*(y[1]+y[4]),0],M.bsRadius=.5*Math.sqrt((y[3]-y[0])*(y[3]-y[0])+(y[4]-y[1])*(y[4]-y[1])),M.transformation=S,M.name=o,M.uniqueName=o+"#"+A.id,g.push(M)}}return new a(this,g,null,null,y,n)}return null},t}(i);return f});