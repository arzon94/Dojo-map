// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DSymbolCommonCode","../../../../geometry/Polygon","../../../../geometry/Point","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/materials/Material","../../webgl-engine/lib/Util","./earcut/earcut","./graphicUtils"],function(e,t,r,a,n,i,o,s,l,p,c,h,u,g,y,d,f,v){function m(e,t,r,a,n,i,o,s,l,p,c,h,u,g){var y=r.length/3,d=0,f=!0;f&&(c+=2*a.count),_(e,t,a.index,a.count,r,0,y,n,i,o,s,l,p,c,h,u,g),l+=2*a.count,c+=2*y,f&&(c-=2*a.count+2*y),x(n,i,s,o,d,a.pathLengths[0],a.count,l,p,c,h),l+=4*a.pathLengths[0],c+=2*a.pathLengths[0],d+=a.pathLengths[0];for(var v=1;v<a.pathLengths.length;++v)x(n,i,s,o,d,a.pathLengths[v],a.count,l,p,c,h),l+=4*a.pathLengths[v],c+=2*a.pathLengths[v],d+=a.pathLengths[v]}function _(e,t,r,a,n,i,o,s,l,p,c,h,u,g,y,d,f){w.set(d,D);for(var v=y>0?1:-1,m=3*r,_=h,E=3*_,x=h+a,b=3*x,S=0;a>S;++S)f&&(D[0]=e[m+0],D[1]=e[m+1],D[2]=e[m+2],w.normalize(D)),s[E+0]=e[m+0],s[E+1]=e[m+1],s[E+2]=e[m+2],l[E+0]=t[m+0],l[E+1]=t[m+1],l[E+2]=t[m+2],p[E+0]=-v*D[0],p[E+1]=-v*D[1],p[E+2]=-v*D[2],c[_]=0,s[b+0]=e[m+0]+y*D[0],s[b+1]=e[m+1]+y*D[1],s[b+2]=e[m+2]+y*D[2],l[b+0]=t[m+0],l[b+1]=t[m+1],l[b+2]=t[m+2],p[b+0]=v*D[0],p[b+1]=v*D[1],p[b+2]=v*D[2],c[x]=y,E+=3,b+=3,m+=3,_+=1,x+=1;m=3*i,E=3*g,b=3*(g+o);var A=!1;A===!1&&(E=3*(g+o),b=3*g);var I=P,L=z;0>y&&(I=z,L=P);for(var S=0;o>S;++S)u[E+0]=n[m+I[0]],u[E+1]=n[m+I[1]],u[E+2]=n[m+I[2]],u[b+0]=n[m+L[0]]+a,u[b+1]=n[m+L[1]]+a,u[b+2]=n[m+L[2]]+a,E+=3,b+=3,m+=3}function E(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function x(e,t,r,a,n,i,o,s,l,p,c){var h=n,u=n+1,g=n+o,y=n+o+1,d=s,f=s+1,v=s+2*i,m=s+2*i+1;0>c&&(h=n+o+1,y=n),p*=3;for(var _=0;i>_;++_)_===i-1&&(c>0?(u=n,y=n+o):(u=n,h=n+o)),b(e,h,u,g,O),E(e,t,a,r,O,d,h),E(e,t,a,r,O,f,u),E(e,t,a,r,O,v,g),E(e,t,a,r,O,m,y),l[p++]=d,l[p++]=v,l[p++]=m,l[p++]=d,l[p++]=m,l[p++]=f,h++,u++,g++,y++,d+=2,f+=2,v+=2,m+=2}function b(e,t,r,a,n){t*=3,r*=3,a*=3,w.set3(e[t++],e[t++],e[t++],C),w.set3(e[r++],e[r++],e[r++],G),w.set3(e[a++],e[a++],e[a++],U),w.subtract(G,C,F),w.subtract(U,C,N),w.cross(N,F,n),w.normalize(n,n)}function S(e,t,r,a){var n=a.setAltitude;M.spatialReference=r.spatialReference;for(var o=e.getGeometryRecords(),s=o.length,l="absolute-height"!==t.mode,p=0,c=0;s>c;c++){var h=o[c].geometry,u=o[c].transformation;V[0]=u[12],V[1]=u[13],V[2]=u[14],h.invalidateBoundingInfo();for(var g=h.getData().getVertexAttr(),y=g[A.POSITION].data,d=g[A.SIZE].data,f=g.mapPos.data,v=y.length/3,m=0,_=0,E=!1,x=0,b=0;v>b;b++){M.x=f[_],M.y=f[_+1],M.z=f[_+2],B[0]=y[m],B[1]=y[m+1],B[2]=y[m+2];var S=i.computeElevation(r,M,t,l?R:null);l&&(x+=R.terrainElevation),L[0]=y[m]+V[0],L[1]=y[m+1]+V[1],L[2]=y[m+2]+V[2],n(S+d[m/3],L,0),y[m]=L[0]-V[0],y[m+1]=L[1]-V[1],y[m+2]=L[2]-V[2];var w=.01/a.unitInMeters;(Math.abs(B[0]-y[m])>w||Math.abs(B[1]-y[m+1])>w||Math.abs(B[2]-y[m+2])>w)&&(E=!0),_+=3,m+=3}E&&e.geometryVertexAttrsUpdated(c),p+=x/v}return p/s}var A=d.VertexAttrConstants,w=p.vec3d,I=p.mat4d,L=w.create(),D=w.create(),P=[0,2,1],z=[0,1,2],M=new s,R={verticalDistanceToGround:0,terrainElevation:0},T=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=v.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),a=w.create(r),n=r[3],i={diffuse:a,ambient:a,opacity:n,transparent:1>n||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new y(i,t+"_3dlinemat"),this._context.stage.add(c.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(c.ModelContentType.MATERIAL,this._material.getId())},t.prototype.createGraphics3DGraphic=function(e,t){var r=e.geometry;if("polygon"!==r.type&&"extent"!==r.type)return this._logWarning("unsupported geometry type for extrude symbol: "+r.type),null;var a="polygon"===r.type||"extent"===r.type?"rings":"paths",n="graphic"+e.uid,i=this._getVertexOpacityAndColor(t,Float32Array,255),o=this.getGraphicElevationInfo(e);return this._createAs3DShape(e,a,t,i,o,n,e.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){var a=this._getMaterialOpacity(),n=1>a||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:a,transparent:n}),!0}if("elevationInfo"===e){this._updateElevationInfo();for(var o in t){var s=t[o],l=r(s);if(l){var p=s.graphic,c=this.getGraphicElevationInfo(p);l.needsElevationUpdates=i.needsElevationUpdates3D(c.mode),l.elevationInfo.set(c)}}return!0}return!1},t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?i.getSingleSizeDriver(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,a,s,p,c){var g=e.geometry;"extent"===g.type&&(g=o.fromExtent(g));var y=g[t],d=g.hasZ,v=y.length;if(v>0){var _=[],E=[],x=[],b=w.create(),A=new Array(6),L=this._context.renderSpatialReference===l.SphericalRenderSpatialReference,D=this._getExtrusionSize(r),P=w.create();L||this._context.renderCoordsHelper.worldUpAtPosition(null,P);for(var z=i.getGeometryVertexData3D(y,d,g.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,s),M=z.geometryData.polygons,R=z.eleVertexData,T=z.vertexData,O=T.length/3,C=new Float64Array(3*O*6),G=new Float64Array(3*O*6),U=new Float64Array(3*O*6),F=new Float64Array(1*O*6),N=0,B=function(e){var t=M[e],r=t.count,n=t.index;if(V._context.clippingExtent&&(i.computeBoundingBox(R,n,r,A),i.boundingBoxClipped(A,V._context.clippingExtent)))return"continue";var o=new Float64Array(R.buffer,3*n*C.BYTES_PER_ELEMENT,3*r),s=t.holeIndices.map(function(e){return e-n}),l=f(o,s,3);if(l.length>0){i.chooseOrigin(T,n,r,b);var c=3*r*2+2*l.length,h=new Uint32Array(c),g=6*r,y=new Float64Array(C.buffer,3*N*C.BYTES_PER_ELEMENT,3*g),d=new Float64Array(G.buffer,3*N*G.BYTES_PER_ELEMENT,3*g),v=new Float64Array(U.buffer,3*N*U.BYTES_PER_ELEMENT,3*g),S=new Float64Array(F.buffer,1*N*F.BYTES_PER_ELEMENT,1*g);m(T,R,l,t,y,v,d,S,0,h,0,D,P,L),i.subtractCoordinates(y,0,g,b),N+=6*r;var w=V._createExtrudeGeometry(h,{positions:y,elevation:v,normals:d,heights:S},a),z=new u(w,p+"path"+e);z.singleUse=!0,_.push(z),E.push([V._material]);var O=I.identity();I.translate(O,b,O),x.push(O)}},V=this,H=0;H<M.length;++H)B(H);if(_.length>0){var Y=this._context.layer.id,j=new h({geometries:_,materials:E,transformations:x,castShadow:!0,metadata:{layerId:Y,graphicId:c},idHint:p}),W=S,Z=new n(this,j,_,null,null,W,s);return Z.alignedTerrainElevation=z.terrainElevation,Z.needsElevationUpdates=i.needsElevationUpdates3D(s.mode),Z}return null}return this._logWarning("no paths found for extrusion symbol"),null},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;a>o;o++)i[o]=0;var s={},l={};return s[A.POSITION]=n,s[A.NORMAL]=n,s[A.COLOR]=i,l[A.POSITION]={size:3,data:t.positions},l[A.NORMAL]={size:3,data:t.normals},l[A.COLOR]={size:4,data:r},l[A.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new g(l,s)},t}(a),O=w.create(),C=w.create(),G=w.create(),U=w.create(),F=w.create(),N=w.create(),B=w.create(),V=w.create();return T});