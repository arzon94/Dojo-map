// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/asyncUtils","../../../../core/ObjectPool","../../support/aaBoundingBox","../../support/aaBoundingRect"],function(i,t,r,e,a,n,o,s){function h(i,t){for(var r=new Array(i),e=0;e<r.length;e++)r[e]=new Array(t);return r}var c=new n(Array,function(i){return o.set(i,o.ZERO)},null,10,5),l=s.create(),p=function(){function i(i,t,r){this.addedToSpatialIndex=!1,this._labelGraphics=[],this._auxiliaryGraphics=[],this._visibilityFlags=h(2,3),this.graphics3DSymbol=t,this.graphic=i,this._graphics=r}return i.prototype.initialize=function(i,t){var r=this;this._layer=i,this._stage=t,this.forEachSymbolLayerGraphic(function(e){e.initialize(i,t),e.setVisibility(r.isVisible())})},i.prototype.destroy=function(){this.forEachRenderedGraphic(function(i){return i.destroy()}),this._graphics.length=0,this._labelGraphics.length=0,this._auxiliaryGraphics.length=0},i.prototype.clearLabelGraphics=function(){this.forEachLabelGraphic(function(i){return i.destroy()}),this._labelGraphics.length=0},i.prototype.addLabelGraphic=function(i,t,r){this._labelGraphics.push(i),i.initialize(t,r),i.setVisibility(this.isVisible(1))},i.prototype.addAuxiliaryGraphic=function(i){this._auxiliaryGraphics.push(i),this._layer&&(i.initialize(this._layer,this._stage),i.setVisibility(this.isVisible()))},i.prototype.isDraped=function(){var i=!1;return this.forEachSymbolLayerGraphic(function(t){t.isDraped()&&(i=!0)}),i},i.prototype.setDrawOrder=function(i,t,r){var e=this;r[this.graphics3DSymbol.symbol.id]=!0,this.forEachSymbolLayerGraphic(function(a,n){var o=i+(1-(1+n)/e._graphics.length);a.setDrawOrder(o,t,r)})},i.prototype.areVisibilityFlagsSet=function(i,t,r){void 0===r&&(r=0);var e=this._visibilityFlags[r];if(null!=i)return e[i];for(var a=!0,n=0;n<e.length;n++)if(n!==t){var o=e[n];a=a&&(null==o||o===!0)}return a},i.prototype.isVisible=function(i){void 0===i&&(i=0);for(var t=!0,r=0;i>=r;r++)for(var e=this._visibilityFlags[r],a=0;a<e.length;a++){var n=e[a];t=t&&(null==n||n===!0)}return t},i.prototype.setVisibilityFlag=function(i,t,r){void 0===r&&(r=0);var e=this.isVisible(r);this._visibilityFlags[r][i]=t;var a=this.isVisible(r);if(e!==a){if(1===r)this.forEachLabelGraphic(function(i){return i.setVisibility(a)});else{this.forEachSymbolLayerGraphic(function(i){return i.setVisibility(a)});var n=this.isVisible(1);this.forEachLabelGraphic(function(i){return i.setVisibility(n)})}return!0}return!1},i.prototype.getBSRadius=function(){var i=0;return this.forEachSymbolLayerGraphic(function(t){i=Math.max(i,t.getBSRadius())}),i},i.prototype.getCenterObjectSpace=function(){return this._graphics[0].getCenterObjectSpace()},i.prototype.getProjectedBoundingBox=function(i,t,n,h){return e(this,void 0,void 0,function(){var p=this;return r(this,function(u){switch(u.label){case 0:return h||(h={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),h.boundingBox?o.set(h.boundingBox,o.NEGATIVE_INFINITY):h.boundingBox=o.create(o.NEGATIVE_INFINITY),h.requiresDrapedElevation=!1,[4,a.forEach(this._graphics,function(a){return e(p,void 0,void 0,function(){var e,s,l;return r(this,function(r){switch(r.label){case 0:return a?(e=a.isDraped()?t:i,s=c.acquire(),[4,a.getProjectedBoundingBox(e,n,s,h.screenSpaceObjects)]):[2];case 1:return l=r.sent(),isFinite(l[2])&&isFinite(l[5])||(h.requiresDrapedElevation=!0),l&&o.expand(h.boundingBox,s),c.release(s),[2]}})})})];case 1:return u.sent(),o.allFinite(h.boundingBox)||s.allFinite(o.toRect(h.boundingBox,l))?[2,h]:[2,null]}})})},i.prototype.needsElevationUpdates=function(){for(var i=0,t=this._graphics;i<t.length;i++){var r=t[i];if(r&&r.needsElevationUpdates)return!0}for(var e=0,a=this._labelGraphics;e<a.length;e++){var r=a[e];if(r&&r.needsElevationUpdates)return!0}return!1},i.prototype.alignWithElevation=function(i,t){this.forEachRenderedGraphic(function(r){return r.alignWithElevation(i,t)})},i.prototype.addHighlight=function(i,t){this.forEachSymbolLayerGraphic(function(r){return r.addHighlight(i,t)})},i.prototype.removeHighlight=function(i){this.forEachSymbolLayerGraphic(function(t){return t.removeHighlight(i)})},i.prototype.forEachGraphicList=function(i,t){i.forEach(function(i,r){return i&&t(i,r)})},i.prototype.forEachSymbolLayerGraphic=function(i){this.forEachGraphicList(this._graphics,i),this.forEachGraphicList(this._auxiliaryGraphics,i)},i.prototype.forEachLabelGraphic=function(i){this.forEachGraphicList(this._labelGraphics,i)},i.prototype.forEachRenderedGraphic=function(i){this.forEachSymbolLayerGraphic(i),this.forEachLabelGraphic(i)},i}();return p});