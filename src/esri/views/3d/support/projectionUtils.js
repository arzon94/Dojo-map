// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["../../../geometry/SpatialReference","../../../geometry/Point","./mathUtils","./earthUtils","../lib/glMatrix","../webgl-engine/lib/BufferVectorMath"],function(e,n,r,t,a,i){var u,f,l,o,c=a.vec3d,s=a.mat4d,m=i.Vec3Compact,h=c.create(),x=c.create(),M=c.create(),N=r.deg2rad(1),R=r.rad2deg(1),v=new e({wkt:'      GEOCCS["Spherical geocentric",        DATUM["Not specified",          SPHEROID["Sphere",'+t.earthRadius+',0]],        PRIMEM["Greenwich",0.0,          AUTHORITY["EPSG","8901"]],        UNIT["m",1.0],        AXIS["Geocentric X",OTHER],        AXIS["Geocentric Y",EAST],        AXIS["Geocentric Z",NORTH]      ]    '}),E={SphericalRenderSpatialReference:v,vectorToVector:function(e,n,r,t){return 2===e.length?(h[0]=e[0],h[1]=e[1],h[2]=0,e=h):e===r&&(c.set(e,h),e=h),this.bufferToBuffer(e,n,0,r,t,0,1)},pointToVector:function(e,n,r){h[0]=e.x,h[1]=e.y;var t=e.z;return h[2]=void 0!==t?t:0,this.bufferToBuffer(h,e.spatialReference,0,n,r,0,1)},vectorToPoint:function(e,r,t,a){var i;return"esri.SpatialReference"===t.declaredClass?(a=t,i=new n({spatialReference:a})):(i=t,a=a||i.spatialReference),this.bufferToBuffer(e,r,0,h,a,0,1)?(i.x=h[0],i.y=h[1],i.z=h[2],i.spatialReference=a,i):null},xyzToVector:function(e,n,r,t,a,i){return h[0]=e,h[1]=n,h[2]=r,this.bufferToBuffer(h,t,0,a,i,0,1)},bufferToBuffer:function(e,n,r,t,a,i,c){c=c||1,u!==n&&(f=T(n),u=n),l!==a&&(o=T(a),l=a);var s,m,h=r+3*c;if(f!==o||f===S.UNKNOWN&&!n.equals(a)){if(!(f>S.UNKNOWN&&o>S.UNKNOWN))return!1;var M;if(o!==S.WGS84){var N=B[o];if(f!==S.WGS84)for(M=I[f],s=r,m=i;h>s;s+=3,m+=3)M(e,s,x,0,n.wkid),N(x,0,t,m);else for(s=r,m=i;h>s;s+=3,m+=3)N(e,s,t,m)}else for(M=I[f],s=r,m=i;h>s;s+=3,m+=3)M(e,s,t,m,n.wkid)}else if(t!==e||r!==i)for(s=r,m=i;h>s;s++,m++)t[m]=e[s];return!0},computeLinearTransformation:function(e,n,r,t){var a=T(e),i=T(t);if(a===i&&(a!==S.UNKNOWN||e.equals(t)))return s.identity(r),s.translate(r,n),!0;if(i===S.ENGINE_SPHR){var u=I[a];if(u){u(n,0,x,0,e.wkid),W(x,0,M,0);var f=N*x[0],l=N*x[1],o=Math.sin(f),c=Math.cos(f),m=Math.sin(l),h=Math.cos(l),R=r;return R[0]=-o,R[4]=-m*c,R[8]=h*c,R[12]=M[0],R[1]=c,R[5]=-m*o,R[9]=h*o,R[13]=M[1],R[2]=0,R[6]=h,R[10]=m,R[14]=M[2],R[3]=0,R[7]=0,R[11]=0,R[15]=1,!0}}else if(i===S.WEBMERC&&(a===S.WGS84||a===S.ENGINE_SPHR)){I[a](n,0,x,0,e.wkid);var v=N*x[1];G(x,0,M,0),s.identity(r),s.translate(r,M);var E=1/Math.cos(v);return s.scale(r,[E,E,1]),!0}return!1},mbsToMbs:function(e,n,r,t){var a=T(n),i=T(t);if(a===i&&(a!==S.UNKNOWN||n.equals(t)))return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],!0;if(i===S.ENGINE_SPHR){var u=I[a];if(u)return u(e,0,x,0,n.wkid),W(x,0,r,0),r[3]=e[3],!0}else if(i===S.WEBMERC&&(a===S.WGS84||a===S.ENGINE_SPHR)){I[a](e,0,x,0,n.wkid);var f=N*x[1];if(f=Math.abs(f)+Math.asin(e[3]/(d+e[2])),G(x,0,r,0),f>.9999*Math.PI)r[3]=Number.MAX_VALUE;else{var l=1/Math.cos(f);r[3]=l*e[3]}return!0}return!1},extentToBoundingBox:function(e,n,r){if(null==e)return!1;var t=!0;return h[0]=null!=e.xmin?e.xmin:0,h[1]=null!=e.ymin?e.ymin:0,h[2]=null!=e.zmin?e.zmin:0,t=t&&this.bufferToBuffer(h,e.spatialReference,0,n,r,0,1),h[0]=null!=e.xmax?e.xmax:0,h[1]=null!=e.ymax?e.ymax:0,h[2]=null!=e.zmax?e.zmax:0,t=t&&this.bufferToBuffer(h,e.spatialReference,0,n,r,3,1),null==e.xmin&&(n[0]=-(1/0)),null==e.ymin&&(n[1]=-(1/0)),null==e.zmin&&(n[2]=-(1/0)),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),t},extentToBoundingRect:function(e,n,r){if(null==e)return!1;var t=!0;return h[0]=null!=e.xmin?e.xmin:0,h[1]=null!=e.ymin?e.ymin:0,h[2]=null!=e.zmin?e.zmin:0,t=t&&this.bufferToBuffer(h,e.spatialReference,0,h,r,0,1),n[0]=h[0],n[1]=h[1],h[0]=null!=e.xmax?e.xmax:0,h[1]=null!=e.ymax?e.ymax:0,h[2]=null!=e.zmax?e.zmax:0,t=t&&this.bufferToBuffer(h,e.spatialReference,0,h,r,0,1),n[2]=h[0],n[3]=h[1],null==e.xmin&&(n[0]=-(1/0)),null==e.ymin&&(n[1]=-(1/0)),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),t},webMercator:{x2lon:function(e){return e/d},y2lat:function(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/d))},lon2x:function(e){return e*d},lat2y:function(e){var n=Math.sin(e);return d/2*Math.log((1+n)/(1-n))}}},d=t.earthRadius,S={UNKNOWN:0,ENGINE_SPHR:1,WGS84:2,WEBMERC:3},T=function(e){var n;return n=e===v?S.ENGINE_SPHR:e.isWGS84?S.WGS84:e.isWebMercator?S.WEBMERC:S.UNKNOWN},p=function(e,n,r,t){r[t++]=e[n++],r[t++]=e[n++],r[t]=e[n]},y=function(e,n,r,t){r[t++]=R*(e[n++]/d),r[t++]=R*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/d))),r[t]=e[n]},G=function(e,n,t,a){var i=.4999999*Math.PI,u=N*e[n+1];u=r.clamp(u,-i,i);var f=Math.sin(u);t[a++]=N*e[n]*d,t[a++]=d/2*Math.log((1+f)/(1-f)),t[a]=e[n+2]},W=function(e,n,r,t){var a=d+e[n+2],i=N*e[n+1],u=N*e[n],f=Math.cos(i);r[t++]=Math.cos(u)*f*a,r[t++]=Math.sin(u)*f*a,r[t]=Math.sin(i)*a},b=function(e,n,t,a){var i=m.length(e,n),u=r.asin(e[n+2]/i),f=Math.cos(u),l=(e[n+1]>0?1:-1)*r.acos(e[n]/(f*i));t[a++]=R*l,t[a++]=R*u,t[a]=i-d},B=[void 0,W,p,G],I=[void 0,b,p,y];return E});