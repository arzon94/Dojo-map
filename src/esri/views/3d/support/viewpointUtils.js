// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["../../../geometry/SpatialReference","../../../geometry/Geometry","../../../geometry/Point","../../../geometry/Extent","../../../geometry/support/webMercatorUtils","../../../core/Error","../../../core/promiseUtils","../../../Camera","../../../Viewpoint","../../../Graphic","../lib/glMatrix","./mathUtils","./projectionUtils","./cameraUtils","./aaBoundingBox","./aaBoundingRect","./intersectionUtils"],function(e,t,n,a,r,i,o,c,l,s,u,m,f,g,p,d,v){function h(e){return 360-m.cyclicalDeg.normalize(e)}function y(e){return m.cyclicalDeg.normalize(360-e)}function x(t,a,i){var o;if(!a)return null;var l,s=t.spatialReference||e.WGS84;if(a.camera){if(l=a.get("camera.position.spatialReference"),!r.canProject(l,s))return null;if(o=a.camera.clone(),!l.equals(s)){var u=r.project(o.position,s);o.position=u}return o}if(l=a.get("targetGeometry.spatialReference"),l&&!r.canProject(l,s))return null;var m=t.navigation.currentCamera;v=g.internalToExternal(t,m);var p={noReset:!1};if(null!=a.rotation&&(v.heading=h(a.rotation),p.noReset=!0),null!=i&&(v.tilt=i),a.targetGeometry instanceof n){var d,v,y=a.targetGeometry,x=a.targetGeometry.clone();d=null!=a.scale?g.scaleToDistance(t,a.scale,y.latitude):m.distance,o=g.eyeHeadingTiltForCenterPointAtDistance(t,v.heading,v.tilt,x,d,p);var T=f.vectorToPoint(o.eye,t.renderSpatialReference,s);return new c(T,o.heading,o.tilt,v.fov)}var R=a.targetGeometry.extent;return g.fromExtent(t,R,v,p)}function T(e,t,n){return null!=e[t]?e[t]:null!=n?"function"==typeof n?n():n:void 0}function R(e,t,n,a){var r=n.scale;return null==r&&null!=n.zoom&&(r=g.zoomToScale(e,n.zoom)),null==r&&null!=n.distance&&(t=t.center||t,r=g.distanceToScale(e,n.distance,t.latitude)),null==r&&a&&(r="function"==typeof a?a():a),r}function G(e,t,n){var a=t.heading;return null==a&&null!=t.rotation&&(a=h(t.rotation)),null==a&&n&&(a="function"==typeof n?n():n),a}function b(t,a,r,i,o){if(!(a&&r.position||a&&r.direction||r.position&&r.direction))return!1;var c=t.spatialReference||e.WGS84,l=t.renderSpatialReference,s=r.direction;if(a&&r.position&&(s=null),r.position&&f.pointToVector(r.position,Y,l),a&&f.pointToVector(a,q,l),s){var u=r.position||a,m=new n(u);m.x+=s[0],m.y+=s[1],s.length>2&&(m.z+=s[2]),f.pointToVector(m,L,l),_.subtract(L,r.position?Y:q)}if(r.position&&s)o.camera.position=new n(r.position),g.directionToHeadingTilt(t,Y,L,i.up,o.camera),_.add(Y,L,q),t.navigation.getCenterIntersectTerrain(Y,q,q),o.targetGeometry=f.vectorToPoint(q,l,c),o.scale=g.distanceToScale(t,_.dist(Y,q),o.targetGeometry.latitude);else if(a&&s){o.targetGeometry=new n(a),o.scale=R(t,o.targetGeometry,r,function(){return g.computeScale(t,i)});var p=g.scaleToDistance(t,o.scale,a.latitude);_.scale(L,p/_.length(L),Y),_.add(Y,q),o.camera.position=f.vectorToPoint(Y,l,c),g.directionToHeadingTilt(t,Y,L,i.up,o.camera)}else o.targetGeometry=new n(a),o.camera.position=new n(r.position),_.subtract(q,Y,L),g.directionToHeadingTilt(t,Y,L,i.up,o.camera),o.scale=g.distanceToScale(t,_.dist(Y,q),o.targetGeometry.latitude);return o.rotation=y(o.camera.heading),!0}function w(e,t){var n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=h(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function S(t,n,a){var r=t.spatialReference||e.WGS84;return n=n||g.externalToInternal(t,a.camera),a.targetGeometry=f.vectorToPoint(n.center,t.renderSpatialReference,r),a.scale=g.computeScale(t,n),a.rotation=y(a.camera.heading),a}function E(e,t,n){return n||(n=new l({camera:new c})),g.internalToExternal(e,t,n.camera),S(e,t,n)}function z(e,t,n){return n||(n=new l),n.camera=t.clone(),S(e,null,n)}function I(e,t,a){if(t){var r=[];if(!t.hasZ&&e.basemapTerrain){var i;i=t.isInstanceOf(n)?t:t.centroid||t.center,i?k[2]=e.basemapTerrain.getElevation(i)||0:k[2]=0}ne[t.declaredClass](t,function(e){r.push(e[0],e[1],e[2])},k);var o=r.length/3;if(0!==o){var c=new Array(r.length);if(f.bufferToBuffer(r,t.spatialReference,0,c,e.spatialReference,0,o)){t.hasZ&&(a.hasZ=!0);for(var l=0;l<c.length;l+=3)t.hasZ?(k[0]=c[l+0],k[1]=c[l+1],k[2]=c[l+2]):(k[0]=c[l+0],k[1]=c[l+1]),p.expand(a.boundingBox,k)}}}}function M(e,t,n){var a=e.whenViewForGraphic(t);return a.then(function(e){return e&&e.whenGraphicBounds?e.whenGraphicBounds(t):void 0}).then(function(e){var t=e.boundingBox;p.expand(n.boundingBox,t),e.screenSpaceObjects&&e.screenSpaceObjects.forEach(function(e){n.screenSpaceObjects.push(e)}),isFinite(t[2])&&(n.hasZ=!0)}).otherwise(function(){I(e,t.geometry,n)})}function C(n,a,r){if(Array.isArray(a)&&2===a.length&&"number"==typeof a[0]&&"number"==typeof a[1])ee.x=a[0],ee.y=a[1],ee.z=void 0,ee.spatialReference=e.WGS84,I(n,ee,r);else{if(a&&a.forEach)return o.eachAlways(a.map(function(e){return C(n,e,r)}));if(a instanceof t)I(n,a,r);else if(a instanceof s)return M(n,a,r)}return o.resolve()}function P(e,t,n,a){if(t.camera)return A(e,n,t.camera,a);a.scale=t.scale,a.rotation=t.rotation,a.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,a.camera=null,null!=n.heading?a.rotation=y(n.heading):null!=n.rotation&&(a.rotation=n.rotation);var r=R(e,a.targetGeometry,n);return null!=r&&(a.scale=r),a.camera=x(e,a,n.tilt),a}function A(e,t,n,a){a.camera=n.clone(),a.camera.fov=e.camera.fov;var i=e.spatialReference,o=a.camera.position.spatialReference;if(!r.canProject(o,i))return null;if(!o.equals(i)){var c=r.project(a.camera.position,i);a.camera.position=c}return S(e,null,a)}function B(e,t,n,a){if(!n)return null;a.targetGeometry=n.clone();var r=e.navigation.getCameraIntersectTerrain();if(b(e,a.targetGeometry,t,r,a))return a;g.internalToExternal(e,r,a.camera);var i={noReset:!1};return w(a.camera,t)&&(i.noReset=!0),a.scale=R(e,a.targetGeometry,t),null==a.scale&&(f.pointToVector(n,k,e.renderSpatialReference),v.frustumPoint(r.frustumPlanes,k)?a.scale=g.distanceToScale(e,_.dist(r.eye,k),n.latitude):a.scale=g.computeScale(e,r)),g.fromCenterScale(e,a.targetGeometry,a.scale,a.camera,i,a.camera)?a:null}function F(e,t,a){var r=e.navigation.getCameraIntersectTerrain();if(b(e,null,t,r,a))return a;if(t.position)return _.set(r.viewForward,L),g.directionToHeadingTilt(e,r.eye,L,r.up,X),a.camera.position=new n(t.position),a.camera.heading=G(e,t,X.heading),a.camera.tilt=T(t,"tilt",X.tilt),S(e,null,a);var i=f.vectorToPoint(r.center,e.renderSpatialReference,ee,e.spatialReference);return B(e,t,i,a)}function V(e,t,n,a){a.targetGeometry=n.clone();var r=e.navigation.getCameraIntersectTerrain();g.internalToExternal(e,r,a.camera);var i={noReset:!1};return w(a.camera,t)&&(i.noReset=!0),g.fromExtent(e,n,a.camera,i,a.camera)?a:null}function Z(e,t,n,a,r){var i=0;n.hasZ?i=n.z:e.basemapTerrain&&(i=e.basemapTerrain.getElevation(n)),_.set3(n.x,n.y,i,k),f.computeLinearTransformation(e.spatialReference,k,J,e.renderSpatialReference),W.toMat3(J,K),H.transpose(K),p.set(Q,p.NEGATIVE_INFINITY);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var l=o[c],s=a[l[2]];isFinite(s)||(s=i),_.set3(a[l[0]],a[l[1]],s,k),f.vectorToVector(k,e.spatialReference,k,e.renderSpatialReference),p.expand(Q,H.multiplyVec3(K,k))}var u=p.width(Q),m=p.height(Q),g=p.depth(Q),d=1/Math.tan(t.fovX/2),v=1/Math.tan(t.fovY/2),h=Math.sqrt(u*u+g*g),y=.5*h*Math.max(v,d)+.5*m,x=.5*m*v+.5*Math.max(u,g),T=Math.max(y,x);return T/r}function j(e,t,n,a,r,i){i.targetGeometry=n.clone();var o=e.navigation.getCameraIntersectTerrain(),c=Z(e,o,n,a,r);g.internalToExternal(e,o,i.camera);var l={noReset:!1};return w(i.camera,t)&&(l.noReset=!0),i.scale=g.distanceToScale(e,c,i.targetGeometry.latitude),g.fromCenterScale(e,i.targetGeometry,i.scale,i.camera,l,i.camera)?i:null}function N(e,t){if(!t||!e.spatialReference)return null;var n={};if(null!=t.declaredClass||Array.isArray(t))n.target=t;else{for(var a in t)n[a]=t[a];t.center&&!n.target&&(n.target=t.center)}return n}function O(e){return e&&(e.rotation=y(e.camera.heading)),o.resolve(e)}function U(e,t){var n=ae.DEFAULT_FRAME_COVERAGE;if(!t.length)return n;for(var a=Number.NEGATIVE_INFINITY,r=0;r<t.length;r++){var i=t[r].screenSpaceBoundingRect;a=Math.max(a,Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2]),Math.abs(i[3]))}var o=Math.min(e.width,e.height),c=a/o*2;return n-c}function D(e,t){var n=N(e,t);if(!n)return o.reject(new i("viewpointutils-create:no-target","Missing target for creating viewpoint"));var r=new l({camera:new c({fov:e.camera.fov})}),s=null!=n.scale||null!=n.zoom||null!=n.distance;if(n.target instanceof l)return O(P(e,n.target,n,r));if(n.target instanceof c)return O(A(e,n,n.target,r));if(n.target instanceof a){var u=n.target.xmin===n.target.xmax||n.target.ymin===n.target.ymax;return O(s||u?B(e,n,n.target.center,r):V(e,n,n.target,r))}var m={boundingBox:p.create(p.NEGATIVE_INFINITY),spatialReference:e.spatialReference,hasZ:!1,screenSpaceObjects:[]};return C(e,n.target,m).then(function(){if(isFinite(m.boundingBox[0])){p.center(m.boundingBox,k),ee.x=k[0],ee.y=k[1],ee.z=k[2],ee.spatialReference=e.spatialReference;var t;return isFinite(ee.z)&&m.hasZ?t=p.isPoint(m.boundingBox):(ee.z=void 0,t=d.isPoint(p.toRect(m.boundingBox,$))),s||t?B(e,n,ee,r):j(e,n,ee,m.boundingBox,U(e,m.screenSpaceObjects),r)}return F(e,n,r)}).then(function(e){return O(e)})}var _=u.vec3d,H=u.mat3d,W=u.mat4d,Y=_.create(),q=_.create(),L=_.create(),X={heading:0,tilt:0},k=_.create(),J=W.create(),K=H.create(),Q=p.create(),$=d.create(),ee=new n,te=function(e,t,n){for(var a=e.hasZ,r=0;r<e.rings.length;r++)for(var i=e.rings[r],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],a&&(n[2]=i[o][2]),t(n)},ne={"esri.geometry.Point":function(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n)},"esri.geometry.Polygon":te,"esri.geometry.Circle":te,"esri.geometry.Polyline":function(e,t,n){for(var a=e.hasZ,r=0;r<e.paths.length;r++)for(var i=e.paths[r],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],a&&(n[2]=i[o][2]),t(n)},"esri.geometry.Multipoint":function(e,t,n){for(var a=e.points,r=e.hasZ,i=0;i<a.length;i++)n[0]=a[i][0],n[1]=a[i][1],r&&(n[2]=a[i][2]),t(n)},"esri.geometry.Extent":function(e,t,n){e.hasZ?(t(_.set3(e.xmin,e.ymin,e.zmin,n)),t(_.set3(e.xmax,e.ymin,e.zmin,n)),t(_.set3(e.xmin,e.ymax,e.zmin,n)),t(_.set3(e.xmax,e.ymax,e.zmin,n)),t(_.set3(e.xmin,e.ymin,e.zmax,n)),t(_.set3(e.xmax,e.ymin,e.zmax,n)),t(_.set3(e.xmin,e.ymax,e.zmax,n)),t(_.set3(e.xmax,e.ymax,e.zmax,n))):(t(_.set3(e.xmin,e.ymin,n[2],n)),t(_.set3(e.xmax,e.ymin,n[2],n)),t(_.set3(e.xmin,e.ymax,n[2],n)),t(_.set3(e.xmax,e.ymax,n[2],n)))}},ae={create:D,rotationToHeading:h,headingToRotation:y,toCamera:x,fromCamera:z,fromInternalCamera:E,DEFAULT_FRAME_COVERAGE:.66};return ae});