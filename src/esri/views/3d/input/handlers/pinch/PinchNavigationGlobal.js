// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../lib/glMatrix","../../util","./PinchNavigationBase","./MomentumNavigationGlobal"],function(e,t,a,i,n,r,o){Object.defineProperty(t,"__esModule",{value:!0});var s;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(s=t.PanMode||(t.PanMode={}));var h=i.vec3d.create(),c={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI},p=function(e){function t(t,a){var r=e.call(this,t,a)||this;return r.view=t,r._rotation={axis:i.vec3d.create(),valueSmooth:new n.ExponentialFalloff(.05)},r._panning={axis:i.vec3d.create(),plane:{distance:0,normal:i.vec3d.create()},planarCenterScene:i.vec3d.create()},r._scaling={valueSmooth:new n.ExponentialFalloff(.05),centerScreen:i.vec2.create()},r._beginScenePoints={points:[],center:i.vec3d.create()},r._panMode=s.Horizontal,r._navigationSphereRadius=0,r._tmpN=i.vec3d.create(),r._tmp2d=i.vec2.create(),r._tmpPickPointScreen=i.vec2.create(),r._tmpPickPointScene=i.vec3d.create(),r._tmpCurrentPoints=[],r._tmpCurrentCenter=i.vec3d.create(),r._tmpD=i.vec3d.create(),r._horizonPointScreen=i.vec3d.create(),r._horizonPointScene=i.vec3d.create(),r._momentumNavigation=new o.MomentumNavigationGlobal(r,a),r}return a(t,e),Object.defineProperty(t.prototype,"momentum",{get:function(){return this._momentumNavigation},enumerable:!0,configurable:!0}),t.prototype.onNavigationBegin=function(e){var t=this._tmpPickPointScreen,a=this._tmpPickPointScene,n=this._helper;this._rotation.valueSmooth.reset(),this._scaling.valueSmooth.reset(),i.vec2.set2(e.data.currentState.center.x,this.view.height-e.data.currentState.center.y,t),n.picker.pickPointInScreen(t,a)?this._navigationSphereRadius=i.vec3d.length(a):(this._navigationSphereRadius=Math.max(i.vec3d.length(this.beginCamera.center),.9*n.earthUtils.earthRadius),this._helper.spherical.makeRenderCoordSpherePoint(this._navigationSphereRadius,this.beginCamera,t,a)),this._panMode=s.Horizontal;var r=this.view.renderCoordsHelper.getAltitude(this.beginCamera.eye);if(r<c.ELEVATION_THRESHOLD)if(this._navigationSphereRadius>i.vec3d.length(this.beginCamera.eye))this._panMode=s.Vertical;else{i.vec3d.normalize(a,this._tmpN);var o=Math.abs(.5*Math.PI-Math.acos(i.vec3d.dot(this.beginCamera.viewForward,this._tmpN)));o<c.ANGLE_THRESHOLD&&(this._panMode=s.Vertical)}if(this._panMode===s.Horizontal)this._computeSpherePoints(e,"startEvent",this._navigationSphereRadius,this.beginCamera,this._beginScenePoints.points),n.spherical.computePointCenter(this._beginScenePoints.points,this._navigationSphereRadius,this._beginScenePoints.center);else{i.vec3d.set(this.beginCamera.viewForward,this._panning.plane.normal),i.vec3d.normalize(this._panning.plane.normal),i.vec3d.negate(this._panning.plane.normal);var h=i.vec3d.dot(a,this._panning.plane.normal),p=this._horizonPointScreen;i.vec3d.set3(t[0],this.view.height,0,p);var l=this._horizonPointScene,m=i.vec3d.length(this.beginCamera.eye),v=this._navigationSphereRadius;v=v>m?m-100:v,this._helper.spherical.makeRenderCoordSpherePoint(v,this.beginCamera,p,l),this.beginCamera.projectPoint(l,p);var d=.9*p[1];t[1]=Math.min(t[1],d),n.picker.pickPointInScreen(t,a)&&(h=i.vec3d.dot(a,this._panning.plane.normal)),this._panning.plane.distance=h,i.vec2.set2(e.data.currentState.center.x,this.view.height-e.data.currentState.center.y,this._tmp2d),this._helper.planar.intersectPlaneFromScreenPoint(this._panning.plane,this.beginCamera,this._tmp2d,this._panning.planarCenterScene)}},t.prototype.onNavigationUpdate=function(e,t){var a=this._helper,n=e.data.pointers.length,r=n>1;if(this._panMode===s.Horizontal){var o=this._navigationSphereRadius;if(r){var c=e.data.startState.radius/e.data.currentState.radius,p=.001875*Math.min(Math.max(e.data.currentState.radius,40),120);this._scaling.valueSmooth.gain=p,this._scaling.valueSmooth.update(c),a.spherical.applyZoom(o,this.view,t,this._scaling.valueSmooth.value),i.vec2.set2(e.data.currentState.center.x,this.view.height-e.data.currentState.center.y,this._scaling.centerScreen),this.momentum.addScaleValue(e.timestamp,this._scaling.valueSmooth.value)}var l=this._tmpCurrentPoints,m=this._tmpCurrentCenter;this._computeSpherePoints(e,"currentEvent",o,t,l),a.spherical.computePointCenter(l,o,m);var v=this._panning.axis,d=a.spherical.rotationFromPoints(o,this._beginScenePoints.center,m,v);a.applyRotation(t,h,v,d);var u=this._tmp2d;if(i.vec2.set2(e.data.currentState.center.x,this.view.height-e.data.currentState.center.y,u),this.momentum.addPanValue(e.timestamp,u,m,v),r){var _=this._rotation.axis,l=this._tmpCurrentPoints,S=h;i.vec3d.normalize(this._beginScenePoints.center,_),this._computeSpherePoints(e,"currentEvent",o,t,l);var g=0;if(2===n)g=a.rotationFromPointsAroundAxis(l[0],this._beginScenePoints.points[0],_);else{for(var P=0;n>P;P++)g+=a.rotationFromPointsAroundAxis(l[P],this._beginScenePoints.points[P],_);g/=n}var C=this._rotation.valueSmooth.value,b=g-C;b=a.normalizeRotationDelta(b),g=C+b;var p=.00125*Math.min(Math.max(e.data.currentState.radius,40),120);this._rotation.valueSmooth.gain=p,this._rotation.valueSmooth.update(g);var M=this._rotation.valueSmooth.value;this.momentum.addRotationValue(e.timestamp,M),a.applyRotation(t,S,_,M)}}else{var f=this._panning.plane;if(r){var c=e.data.startState.radius/e.data.currentState.radius,p=.001875*Math.min(Math.max(e.data.currentState.radius,40),120);this._scaling.valueSmooth.gain=p,this._scaling.valueSmooth.update(c),this.momentum.addScaleValue(e.timestamp,this._scaling.valueSmooth.value),this.momentum.setVerticalParameters(f,this._panning.planarCenterScene),a.planar.applyZoom(f,this.view,t,this._panning.planarCenterScene,this._scaling.valueSmooth.value)}var m=this._tmpCurrentCenter;i.vec2.set2(e.data.currentState.center.x,this.view.height-e.data.currentState.center.y,this._tmp2d),this._helper.planar.intersectPlaneFromScreenPoint(f,t,this._tmp2d,m);var R=this._tmpD;i.vec3d.subtract(m,this._panning.planarCenterScene,R),i.vec3d.subtract(t.eye,R),i.vec3d.subtract(t.center,R),t.markViewDirty();var u=this._tmp2d;if(i.vec2.set2(e.data.currentState.center.x,this.view.height-e.data.currentState.center.y,u),this.momentum.addPanValue(e.timestamp,u,m,R),r){var _=this._rotation.axis;i.vec3d.set(this._panning.planarCenterScene,_);var g=e.data.currentState.angle,C=this._rotation.valueSmooth.value,b=g-C;b=a.normalizeRotationDelta(b),g=C+b;var p=.00125*Math.min(Math.max(e.data.currentState.radius,40),120);this._rotation.valueSmooth.gain=p,this._rotation.valueSmooth.update(g);var M=this._rotation.valueSmooth.value;this.momentum.addRotationValue(e.timestamp,M),a.applyRotation(t,h,_,M)}}t.markViewDirty()},t.prototype.onNavigationEnd=function(e){this._panMode===s.Horizontal?this.momentum.setParameters(this._navigationSphereRadius,this._scaling.centerScreen,this._beginScenePoints.center,this._panMode):this.momentum.setParameters(this._navigationSphereRadius,this._scaling.centerScreen,this._panning.planarCenterScene,this._panMode)},t.prototype._computeSpherePoints=function(e,t,a,n,r){r.length=e.data.pointers.length;for(var o=this._tmp2d,s=0;s<r.length;s++){var h=e.data.pointers[s];o[0]=h[t].x,o[1]=this.view.height-h[t].y,void 0===r[s]&&(r[s]=i.vec3d.create()),this._helper.spherical.makeRenderCoordSpherePoint(a,n,o,r[s])}return r},t}(r.PinchNavigationBase);t.PinchNavigationGlobal=p});