// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["./terrainUtils","./tileUtils","./TerrainConst","./UpsampleInfo","./ElevationData","./TilePerLayerInfo","../support/mathUtils","../lib/glMatrix","../../../core/arrayUtils"],function(e,t,i,n,a,r,s,l,o){var h=l.vec3d,p=l.vec2d,d=l.vec4d,u=l.mat4d,g=e.weakAssert,f=h.create(),c=d.create(),y=d.create(),v=.1,A=h.create(),E={},m=i.LayerClass.LAYER_CLASS_COUNT,T=i.LayerClass.MAP,L=i.LayerClass.ELEVATION,I=i.TileUpdateTypes,U=function(e,t,i){this.lij=[0,0,0],this.extent=d.create(),this.extentWGS84Rad=d.create(),this.centerAtSeaLevel=h.create(),this.center=h.create(),this.tileUp=A,this.elevationBounds=p.create(),this.children=[null,null,null,null],this.layerInfo=new Array(m),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this._maxTesselation=0};return U.prototype.init=function(e,t,n,a){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],a.getExtent(e[0],e[1],e[2],this.extent,this.extentWGS84Rad),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this.edgeLen=0,this.radius=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?p.set(t.elevationBounds,this.elevationBounds):p.set2(0,0,this.elevationBounds),this.parent=t;for(var s=0;4>s;s++)this.children[s]=null;this.pendingUpdates=0,this.renderData=null,this.screenDepth=0,this.renderOrder=0,this.visible=!1,this.parentSurface=n;for(var l=0;m>l;l++)if(n){var o,h=n.numLayers(l);this.layerInfo[l]?(o=this.layerInfo[l],o.length=h):(o=new Array(h),this.layerInfo[l]=o);for(var d=0;h>d;d++)o[d]=r.makeEmptyLayerInfo(l,o[d]),l==L&&this.findElevationBoundsForLayer(d,-1)}else this.layerInfo[l]=null;this.computeElevationBounds(),this._maxTesselation=Math.min(a.pixelSize[0],i.MAX_TILE_TESSELATION)},U.prototype.dispose=function(){for(var e=0;m>e;e++)for(var t=this.layerInfo[e],i=0;i<t.length;i++){var a=t[i];a.upsampleFromTile&&(n.Pool.release(a.upsampleFromTile),a.upsampleFromTile=null)}},U.prototype.releaseLayerResources=function(){for(var e=this.layerInfo[i.LayerClass.MAP],t=0;t<e.length;t++){var n=e[t];n.releaseResources()}},U.prototype.updateScreenDepth=function(e){h.set(this.center,y),y[3]=1,u.multiplyVec4(e,y,y),this.screenDepth=y[2]/y[3]},U.prototype.shouldSplit=function(e,t){var i=this.lij[0];if(1>i)return I.SPLIT;h.subtract(this.center,t,f);var n=h.length(f),a=e[0],r=e[2],l=a*n*2,o=r*n*2,p=this.edgeLen/l,d=this.edgeLen/o,u=e[1],g=e[3],y=e[4],A=e[5];if(u>p)return this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],I.VSPLITMERGE):I.NONE;if(i>=y){var E=i+Math.ceil(-s.log2(u/p));return E!==this.vlevel?(this.vlevel=E,I.VSPLITMERGE):I.NONE}if(i>6&&(h.scale(this.tileUp,h.dot(this.tileUp,f),c),h.subtract(c,f),h.length2(c)>this.radius*this.radius)){h.scale(c,this.radius/h.length(c)),h.add(c,this.center),h.subtract(t,c,c);var m=this.elevationBounds[1]-this.elevationBounds[0],T=Math.min(1,(Math.abs(h.dot(c,this.tileUp))+.5*m+this.curvatureHeight)/h.length(c)),L=v/A;if(L*g>T*d)return I.NONE}return I.SPLIT},U.prototype.decodeElevationData=function(e){var t;if(e instanceof ArrayBuffer)try{t=a.createFromLERC(this.lij,this.extent,e,i.noDataValueOpt)}catch(n){console.warn("Error decoding %s: %s",e.url,n.message)}else t=a.createFromFetchTileResult(this.lij,this.extent,e);return t},U.prototype.getWGS84Extent=function(){return this.extentWGS84Rad.map(s.rad2deg)},U.prototype.load=function(e){for(var t=0;m>t;t++)this.layerInfo[t]&&this._createOrUpdateAgents(0,t);e.loadTile(this)},U.prototype.unload=function(e){this.renderData&&e.unloadTile(this);for(var t=0;m>t;t++)for(var n=this.layerInfo[t],a=0;a<n.length;a++){var r=n[a];if(r.loadingAgent&&r.loadingAgent!==E){r.loadingAgent.dispose();var s=this.parentSurface.agentTypeByLayerIndex(a,t);s.Pool.release(r.loadingAgent),r.loadingAgent=null}r.pendingUpdates=0}this.pendingUpdates&=~i.TileUpdateTypes.UPDATE_GEOMETRY,this.pendingUpdates&=~i.TileUpdateTypes.UPDATE_TEXTURE},U.prototype.updateClippingStatus=function(e){o.equals(e,this.clippingArea)||(e?(this.intersectsClippingArea=this.intersectsExtent(e),this.isWithinClippingArea=this.isWithinExtent(e)):(this.intersectsClippingArea=!0,this.isWithinClippingArea=!0),this.clippingArea=e,this.renderData&&this.updateGeometry())},U.prototype.updateVisibility=function(e,t,i){var n=i||this.isVisible(e,t)&&this.intersectsClippingArea;if(n!==this.visible){this.visible=n;for(var a=0,r=this.layerInfo[a],s=0;s<r.length;s++){var l=r[s];l.loadingAgent&&l.loadingAgent!==E&&l.loadingAgent.setSuspension(!n)}}return n},U.prototype.getLayerInfo=function(e,t){return this.layerInfo[t][e]},U.prototype.hasLayerData=function(e,t){var i=this.layerInfo[t][e];return i&&i.data},U.prototype.tileDataAvailable=function(e,t,i){var n=this.layerInfo[i][t].tilemap;return n?"unavailable"!==n.getAvailability(e.lij[1],e.lij[2]):!0},U.prototype.requestLayerData=function(e,t,n){i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),t,e,n.tile.lij.toString());var a=this.layerInfo[t][e];if(a.waitingAgents.indexOf(n)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),!0;if(a.data)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),a.waitingAgents.push(n),setTimeout(n.dataArrived.bind(n,this),0),!0;if(a.pendingUpdates&I.DECODE_ELEVATION)return a.waitingAgents.push(n),!0;if(a.waitingAgents.push(n),!a.requestPromise){var r=this.parentSurface.requestTileData(this,e,t);if(r.isFulfilled())return!1;var s=function(){a.requestPromise===r&&(a.requestPromise=null)};return a.requestPromise=r,r.then(s,s),!!r}return!0},U.prototype.descendants=function(e){e||(e=[]);for(var t=0;4>t;t++){var i=this.children[t];i&&(i.descendants(e),e.unshift(this.children[t]))}return e},U.prototype.isLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]==e[2]},U.prototype.findByLij=function(e){if(this.isLij(e))return this;for(var t=0;4>t;t++){var i=this.children[t];if(i){var n=i.findByLij(e);if(n)return n}}return null},U.prototype.unrequestLayerData=function(t,n,a){i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),n,t,a.tile.lij.toString());var r=this.layerInfo[n][t],s=r.waitingAgents,l=s.indexOf(a);if(g(l>-1,"agent has not requested this piece of map data"),s[l]=s[s.length-1],s.length--,s.length<1){var o=r.requestPromise,h=!1;if(n===T){var p=this.parentSurface.layerViewByIndex(t,T);h=e.isVectorTileLayerView(p)}h||g(o||r.rawData,"no pending operations on layerInfo that agents were waiting for"),o&&!o.isFulfilled()&&(o.cancel(),r.requestPromise=null),i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),n,t)}},U.prototype.dataArrived=function(e,t,i){var n=this.layerInfo[t][e];n.data=i;for(var a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataArrived(this);n.waitingAgents.length=0},U.prototype.dataMissing=function(e,t,i){i.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),t,e);for(var n=this.layerInfo[t][e],a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataMissing(this);n.waitingAgents.length=0},U.prototype.updateTexture=function(e){this.renderData&&(e?this.parentSurface._renderer.updateTileTexture(this):(this.pendingUpdates=this.pendingUpdates|i.TileUpdateTypes.UPDATE_TEXTURE,this.parentSurface._pendingUpdates=!0))},U.prototype.reinitializeLayer=function(e,t){var i=this.layerInfo[t],n=i[e];n.loadingAgent&&n.loadingAgent!==E&&n.loadingAgent.dispose(),r.makeEmptyLayerInfo(t,n),this.restartAgents(t)},U.prototype.computeElevationBounds=function(){p.set2(Number.MAX_VALUE,-Number.MAX_VALUE,this.elevationBounds);for(var e=this.layerInfo[L],t=!1,i=0;i<e.length;i++){var n=e[i];n.elevationBounds&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],n.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],n.elevationBounds[1]),t=!0)}t||p.set2(0,0,this.elevationBounds),this.updateRadiusAndCenter()},U.prototype.updateRadiusAndCenter=function(){var e=.5*(this.elevationBounds[0]+this.elevationBounds[1]);h.scale(this.tileUp,e,c),h.add(this.centerAtSeaLevel,c,this.center)},U.prototype.findElevationBoundsForLayer=function(e,n){var a=this.layerInfo[L][e];if(!a.elevationBounds||a.elevationBounds[2]<n){var r=this.parentSurface.layerViewByIndex(e,L);if(t.fallsWithinLayer(this,r,!1)){var s=c,l=!1;if(a.data)p.set(a.data.bounds,s),s[2]=this.lij[0],l=!0;else{for(var o=this.parent,d=0,u=null,g=a.data;o&&(!g||d<i.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&(d=this.vlevel-o.lij[0],u=g||u,g=o.layerInfo[L][e].data,!(!g&&u&&d>=i.ELEVATION_DESIRED_RESOLUTION_LEVEL));)o=o.parent;g=g||u,g&&(g.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],s),s[0]!==1/0&&(s[2]=g.level,l=!0))}l&&(a.elevationBounds?h.set(s,a.elevationBounds):a.elevationBounds=[s[0],s[1],s[2]])}}},U.prototype.updateGeometry=function(){this.pendingUpdates=this.pendingUpdates|i.TileUpdateTypes.UPDATE_GEOMETRY,this.parentSurface._pendingUpdates=!0},U.prototype.modifyLayers=function(e,t,i){for(var n=t.length,a=this.layerInfo[i],s=new Array(n),l=0;l<a.length;l++){var o=a[l];if(o.loadingAgent&&o.loadingAgent!==E){o.loadingAgent.dispose();var h=this.parentSurface.agentTypeByLayerIndex(l,i);h.Pool.release(o.loadingAgent),o.loadingAgent=null}o.waitingAgents.length=0}if(i===T)for(var p=0;p<a.length;p++)if(void 0===e[p]){var d=a[p];d.releaseResources()}for(l=0;n>l;l++){var u=t[l];s[l]=u>-1?a[u]:r.makeEmptyLayerInfo(i)}this.layerInfo[i]=s},U.prototype.restartAgents=function(e){if(this.renderData)if(this._createOrUpdateAgents(0,e),e===L){this.updateGeometry();for(var t=this.layerInfo[e],n=0;n<t.length;n++)t[n].pendingUpdates|=i.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface._pendingUpdates=!0}else this.updateTexture(!0)},U.prototype.updateAgents=function(e){if(this.renderData){for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.loadingAgent===E&&(n.loadingAgent=null)}this._createOrUpdateAgents(0,e)}},U.prototype.agentDone=function(e,t){var i=this.layerInfo[t],n=i[e];n.loadingAgent=E,n.data||n.upsampleFromTile||e<i.length-1&&this._createOrUpdateAgents(e+1,t)},U.prototype._createOrUpdateAgents=function(e,i){var n;n=i===L?!1:!this.visible;for(var a=e,r=this.layerInfo[i];a<r.length;){var s=r[a],l=!1,o=this.parentSurface.layerViewByIndex(a,i);if(null!==s.loadingAgent&&s.loadingAgent!==E)l=s.loadingAgent.update();else if(s.loadingAgent!==E&&t.fallsWithinLayer(this,o,!1)){var h=this.parentSurface.agentTypeByLayerIndex(a,i),p=h.Pool.acquire();l=p.init(this,a,i,n),l?s.loadingAgent=p:(p.dispose(),h.Pool.release(p),s.loadingAgent=E)}if(l&&!o.isTransparent)break;a++}},U.prototype.geometryState=function(e){var t,n,a,r=this._getElevationInfo(e?e.samplerData:null),l=this.lij[0],h=!1;if(r.samplerData){t=this.vlevel-l,n=Math.max(l-r.maxTileLevel,i.ELEVATION_DESIRED_RESOLUTION_LEVEL-t);var p=this._maxTesselation;a=s.clamp((p>>n)+1,2,p+1)}else a=8>l?this._numSubdivisionsAtLevel[l]+1:2;var d=this.clippingArea;return(!this.intersectsClippingArea||this.isWithinClippingArea)&&(d=null),e?(e.numVertsPerRow!==a&&(e.numVertsPerRow=a,h=!0),r.changed&&(e.samplerData=r.samplerData,h=!0),o.equals(e.clippingArea,d)||(e.clippingArea=d,h=!0),e.needsUpdate=h):e={numVertsPerRow:a,samplerData:r.samplerData,needsUpdate:!0,clippingArea:d},e},U.prototype._getElevationInfo=function(e){for(var i=this.layerInfo[L],n=i.length,a=new Array(n),r=0,s=0,l=!1,o=0;n>o;o++){var h=i[o];if(h.upsampleFromTile){var p=h.upsampleFromTile.tile,d=p.layerInfo[L][o].data;e&&e[r]===d.samplerData||(l=!0),a[r++]=d.samplerData,s=Math.max(s,p.lij[0])}else if(h.data){var u=this.parentSurface.layerViewByIndex(o,L);t.fallsWithinLayer(this,u,!1)&&(e&&e[r]===h.data.samplerData||(l=!0),a[r++]=h.data.samplerData,s=this.lij[0])}}return e&&e.length!==r&&(l=!0),r>0?a.length=r:a=null,{changed:l,samplerData:a,maxTileLevel:s}},U.prototype.isWithinExtent=function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},U.prototype.intersectsExtent=function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},U});