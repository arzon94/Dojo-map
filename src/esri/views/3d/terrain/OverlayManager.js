// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/on","../../../core/Logger","../../../core/Accessor","../../../core/accessorSupport/decorators","../lib/glMatrix","../support/mathUtils","../support/earthUtils","../support/projectionUtils","../support/aaBoundingRect","../webgl-engine/Stage","../webgl-engine/lib/Texture"],function(e,t,i,r,a,s,n,o,l,h,y,c,v,d,p){function _(e,t){for(var i=1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]),r=0;4>r;r++)if(Math.abs(t[r]-e[r])>i)return!0;return!1}var u=l.vec2d,g=l.vec3d,f=l.vec4d,x=2048,w=3.5,C=10,m={width:0,height:0,pixelRatio:0,views:null},S=[{viewport:f.create(),extent:f.create()}],T=[S[0],{viewport:f.create(),extent:f.create()}],R=f.create(),O=g.create(),E=[f.create(),f.create()],M=[[0,-1,2,1],[0,-2,2,0],[-1,-2,1,0],[-2,-2,0,0],[-2,-1,0,1],[-2,0,0,2],[-1,0,1,2],[0,0,2,2]],I=s.getLogger("esri.views.3d.OverlayManager"),H=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._overlaySR=null,t._renderSR=null,t._overlaySREqualsRenderSR=!0,t._connectedLayers={},t._scale=0,t._dirty=!1,t._isSpherical=!1,t.opacity=0,t}return i(t,e),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._stage=this.view._stage,this._renderer=this._stage.getTextureGraphicsRenderer(),this._renderer.onHasHighlightsChanged=function(){return e.onHasHighlightsChanged()},this._initialEmptyTexture=new p(new Uint8Array([0,0,0,0]),"overlayEmpty",{width:1,height:1,wrapClamp:!0}),this._stage.add(d.ModelContentType.TEXTURE,this._initialEmptyTexture)},t.prototype.destroy=function(){for(var e in this._connectedLayers)this.unregisterLayerView(this._connectedLayers[e].layerView);this._disposeOverlays(),this._stage.remove(d.ModelContentType.TEXTURE,this._initialEmptyTexture.getId())},t.prototype.onHasHighlightsChanged=function(){this.setOverlayDirty(),this.notifyChange("hasHighlights")},t.prototype.hasOverlays=function(){return!!this._overlays},t.prototype.setSpatialReference=function(e,t){this._overlaySR=e,e?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._isSpherical=t,t?this._longitudeCyclical=e.isWebMercator?new h.Cyclical(-20037508.342788905,20037508.342788905):new h.Cyclical(-180,180):this._longitudeCyclical=null):(this._disposeOverlays(),this._longitudeCyclical=null)},t.prototype.registerLayerView=function(e){var t=this,i=e.layer.uid;if(this._connectedLayers[i])return void I.warn("[OverlayManager#registerLayerView]: Layer "+i+" is already connected");var r=a(e,"draped-data-change",function(){return t.setOverlayDirty()});if(this._connectedLayers[i]={eventHandles:[r],layerView:e},e.setDrapingExtent&&this._overlays)for(var s=0;s<this._overlays.length;s++)e.setDrapingExtent(s,this._overlays[s].extent,this._overlaySR,x);this.setOverlayDirty()},t.prototype.unregisterLayerView=function(e){for(var t in this._connectedLayers){var i=this._connectedLayers[t];if(i.layerView===e){if(i.eventHandles)for(var r=0;r<i.eventHandles.length;r++)i.eventHandles[r].remove();delete this._connectedLayers[t],this.setOverlayDirty(),e.destroyed||(e._overlayUpdating=!1,e._evaluateUpdatingState())}}},t.prototype.onElevationChange=function(e){var t=e.spatialReference,i=e.extent,r=this.view.navigation.currentCamera,a=r.center,s=this.view.renderCoordsHelper,n=O;s.fromRenderCoords(a,n,t),i[0]<=n[0]&&i[1]<=n[1]&&i[2]>n[0]&&i[3]>n[1]&&this.setOverlayDirty()},t.prototype.setOverlayDirty=function(){this._dirty||(this._setOverlayUpdating(!0),this._dirty=!0)},t.prototype._setOverlayUpdating=function(e){for(var t in this._connectedLayers){var i=this._connectedLayers[t].layerView;(!e||!i.suspended&&i.hasDraped)&&(i._overlayUpdating=e,i._evaluateUpdatingState())}var r=this.view._graphicsView;r&&(r._overlayUpdating=e,r._evaluateUpdatingState())},t.prototype.updateOverlay=function(){if(this._overlaySR){var e=this._computeOverlayExtents();if(e){this._overlays||this._initOverlays();for(var t=0;t<this._overlays.length;t++)if(_(e[t],this._overlays[t].extent)){f.set(e[t],this._overlays[t].extent);for(var i in this._connectedLayers){var r=this._connectedLayers[i].layerView;r.setDrapingExtent&&r.setDrapingExtent(t,e[t],this._overlaySR,x)}}this._setOverlayUpdating(!1),this._drawOverlays(),this.terrainSurface._updateTileOverlayParams(),this._dirty=!1}}},t.prototype.overlaysNeedUpdate=function(){return this._dirty&&this._overlaySR},t.prototype.updateOpacity=function(e){var t=1;if(this._overlays){var i=this._scale,r=this.view.renderCoordsHelper.getAltitude(e);i>r*w&&(t=(r-i/C)/(i/w-i/C),t=Math.sqrt(h.clamp(t,0,1)))}return t},t.prototype.setOverlayParamsOfTile=function(e,t,i){var r=e.extent,a=-1;if(this._rectInsideRect(r,this._overlays[0].extent)?a=0:this._rectanglesOverlap(r,this._overlays[1].extent)&&(a=1),a>=0){var s=this._overlays[a].extent;t.overlayTexScale[0]=(r[2]-r[0])/(s[2]-s[0]),t.overlayTexScale[1]=(r[3]-r[1])/(s[3]-s[1]);var n=r[0];if(this._longitudeCyclical){n=this._longitudeCyclical.minimalMonotonic(s[0],n);var o=this._longitudeCyclical.minimalMonotonic(s[0],r[2]);n>o&&(n=o-(r[2]-r[0]))}u.set2((n-s[0])/(s[2]-s[0]),(r[1]-s[1])/(s[3]-s[1]),t.overlayTexOffset),this._overlays[a].valid?t.overlayTexId=this._overlays[a].texture.getId():t.overlayTexId=this._initialEmptyTexture.getId(),this._overlays[a].highlightValid?t.highlightOverlayTexId=this._overlays[a].highlightTexture.getId():t.highlightOverlayTexId=this._initialEmptyTexture.getId(),void 0!==i?t.overlayOpacity=i:t.overlayOpacity=1}else t.overlayTexId=null,t.highlightOverlayTexId=null},t.prototype.overlayPixelSizeInMapUnits=function(e){var t;return this._overlays&&(this._overlays[0]&&this._pointIsInExtent(e,this._overlays[0].extent)?t=this._overlays[0].extent:this._overlays[1]&&(t=this._overlays[1].extent)),t?(t[2]-t[0])/x:0},t.prototype._createEmptyOverlay=function(){var e=new p(null,"overlay",{wrapClamp:!0,mipmap:!0});this._stage.add(d.ModelContentType.TEXTURE,e);var t=new p(null,"highlightOverlay",{wrapClamp:!0,mipmap:!0});return this._stage.add(d.ModelContentType.TEXTURE,t),{extent:f.create(),texture:e,valid:!1,highlightTexture:t,highlightValid:!1}},t.prototype._initOverlays=function(){this._overlays=[this._createEmptyOverlay(),this._createEmptyOverlay()]},t.prototype._disposeOverlays=function(){if(this._overlays){var e=this._stage;this._overlays.forEach(function(t){e.remove(d.ModelContentType.TEXTURE,t.texture.getId()),e.remove(d.ModelContentType.TEXTURE,t.highlightTexture.getId())}),this._overlays=null}},t.prototype._computeOverlayExtents=function(){var e=this.view.navigation.currentCamera,t=this.terrainSurface.extent,i=g.create();g.set(e.center,i),this._scale=this.view.renderCoordsHelper.getAltitude(e.eye);var r=c.vectorToPoint(i,this._renderSR,this.terrainSurface.spatialReference),a=this.terrainSurface.getElevation(r);a?this.view.renderCoordsHelper.setAltitude(a,i):this.view.navigation.getCenterIntersectManifold(e.eye,e.center,i);var s=g.dist(e.eye,i),n=e.angleOfElevation;if(!isNaN(n)){this._overlaySREqualsRenderSR||c.vectorToVector(i,this._renderSR,i,this._overlaySR);var o=.5*x*e.perPixelRatio*s*2,l=!1,v=1/0;this._isSpherical&&(this._overlaySR.isWebMercator?(o/=Math.cos(c.webMercator.y2lat(i[1])),v=this.terrainSurface.extent[3],v*=.999):(l=!0,o/=y.metersPerDegree,v=90),o>=v&&(o=v,i[1]=0,this._overlaySR.isWebMercator&&(i[0]=0)));var d=1;l&&(d=1/Math.max(.2,Math.cos(Math.abs(h.deg2rad(i[1])))),o*d>180&&(d=180/o));var p=o*d,_=E[0];_[0]=i[0]-p,_[1]=i[1]-o,_[2]=i[0]+p,_[3]=i[1]+o,this._isSpherical&&this._shiftExtentToFitBounds(_,1/0,v);var w=E[1];if(f.set(_,w),6*p>t[2]-t[0])f.set(t,w);else if(n>.25*Math.PI)w[0]-=p,w[1]-=o,w[2]+=p,w[3]+=o;else{c.vectorToVector(e.eye,this._renderSR,O,this._overlaySR),u.subtract(i,O,R);var C=-Math.atan2(R[1],R[0])+.125*Math.PI;0>C&&(C+=2*Math.PI);var m=Math.floor(C/(.25*Math.PI));f.scale(M[m],2*o,R),R[0]*=d,R[2]*=d,f.add(w,R,w)}return this._isSpherical&&(w[0]=this._longitudeCyclical.clamp(w[0]),w[2]=this._longitudeCyclical.clamp(w[2]),w[1]=Math.max(w[1],-v),w[3]=Math.min(w[3],v)),this.opacity=1,E}},t.prototype._drawOverlays=function(){for(var e=this._overlays[0].extent[2]-this._overlays[0].extent[0],t=this._renderer,i=0;i<this._overlays.length;i++){var r=this._overlays[i].extent,a=this._longitudeCyclical?r[2]>this._longitudeCyclical.max:!1,s=this._longitudeCyclical?r[0]<this._longitudeCyclical.min:!1;if(a||s){m.views=T;var n=void 0;n=a?this._longitudeCyclical.max-r[0]:this._longitudeCyclical.min-r[0];var o=Math.round(n/(r[2]-r[0])*x),l=m.views[0];f.set4(0,0,o,x,l.viewport),f.set4(r[0],r[1],this._longitudeCyclical.max,r[3],l.extent),a||(l.extent[0]+=this._longitudeCyclical.range);var h=m.views[1];f.set4(o,0,x-o,x,h.viewport),f.set4(this._longitudeCyclical.min,r[1],r[2],r[3],h.extent),a&&(h.extent[2]-=this._longitudeCyclical.range)}else m.views=S,f.set(r,m.views[0].extent),f.set4(0,0,x,x,m.views[0].viewport);m.width=x,m.height=x,m.pixelRatio=e/(r[2]-r[0]),this._overlays[i].valid=t.draw(this._overlays[i].texture,m),this._overlays[i].highlightValid=t.drawHighlights(this._overlays[i].highlightTexture,m)}},t.prototype._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2]))&&!(e[1]>t[3]||e[3]<t[1]):!(e[0]>t[2]||e[2]<t[0]||e[1]>t[3]||e[3]<t[1])},t.prototype._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:e[0]>t[0]&&e[2]<t[2]&&e[1]>t[1]&&e[3]<t[3]},t.prototype._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]},t.prototype._shiftExtentToFitBounds=function(e,t,i){var r=0,a=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?a=e[1]+i:e[3]>i&&(a=i-e[3]),v.offset(e,r,a)},t}(o.declared(n));return r([o.property()],H.prototype,"view",void 0),r([o.property()],H.prototype,"terrainSurface",void 0),r([o.property({type:Boolean})],H.prototype,"hasHighlights",null),H=r([o.subclass("esri.views.3d.terrain.OverlayManager")],H)});