// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["./GeometryData","./BufferVectorMath","./Util","./gl-matrix"],function(r,e,a,t){function n(r,e,a,t,n){return Math.abs(c.dot(e,r))>n?!1:(c.cross(r,e,a),c.normalize(a),c.cross(a,r,t),c.normalize(t),!0)}function o(r,e,a,t,o,i,l){return n(r,e,o,i,l)||n(r,a,o,i,l)||n(r,t,o,i,l)}function i(){var e,a,t=.5,n=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],o=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],i=[0,0,1,0,1,1,0,1],l=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],s=new Array(36);for(e=0;6>e;e++)for(a=0;6>a;a++)s[6*e+a]=e;var c=new Array(36);for(e=0;6>e;e++)c[6*e+0]=0,c[6*e+1]=1,c[6*e+2]=2,c[6*e+3]=2,c[6*e+4]=3,c[6*e+5]=0;return function(e){var a;Array.isArray(e)||(e=[e,e,e]);var t=new Float32Array(24);for(a=0;8>a;a++)t[3*a]=n[a][0]*e[0],t[3*a+1]=n[a][1]*e[1],t[3*a+2]=n[a][2]*e[2];var v={};v[y.POSITION]=new Uint32Array(l),v[y.NORMAL]=new Uint32Array(s),v[y.UV0]=new Uint32Array(c);var A={};return A[y.POSITION]={size:3,data:t},A[y.NORMAL]={size:3,data:new Float32Array(o)},A[y.UV0]={size:2,data:new Float32Array(i)},new r(A,v)}}function l(){var e=.5,a=[[-e,0,-e],[e,0,-e],[e,0,e],[-e,0,e],[0,-e,0],[0,e,0]],t=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],n=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],o=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];return function(e){var i;Array.isArray(e)||(e=[e,e,e]);var l=new Float32Array(18);for(i=0;6>i;i++)l[3*i]=a[i][0]*e[0],l[3*i+1]=a[i][1]*e[1],l[3*i+2]=a[i][2]*e[2];var s={};s[y.POSITION]=new Uint32Array(n),s[y.NORMAL]=new Uint32Array(o);var c={};return c[y.POSITION]={size:3,data:l},c[y.NORMAL]={size:3,data:new Float32Array(t)},new r(c,s)}}function s(){var e=.5,a=0,t=c.createFrom(-e,a,-e),n=c.createFrom(e,a,-e),o=c.createFrom(0,a,e),i=c.createFrom(0,a+e,0),l=c.create(),s=c.create(),v=c.create(),A=c.create(),h=c.create();c.subtract(t,i,l),c.subtract(t,n,s),c.cross(l,s,v),c.normalize(v,v),c.subtract(n,i,l),c.subtract(n,o,s),c.cross(l,s,A),c.normalize(A,A),c.subtract(o,i,l),c.subtract(o,t,s),c.cross(l,s,h),c.normalize(h,h);var f=[t,n,o,i],d=[0,-1,0,v[0],v[1],v[2],A[0],A[1],A[2],h[0],h[1],h[2]],O=[0,1,2,3,1,0,3,2,1,3,0,2],u=[0,0,0,1,1,1,2,2,2,3,3,3];return function(e){var a;Array.isArray(e)||(e=[e,e,e]);var t=new Float32Array(12);for(a=0;4>a;a++)t[3*a]=f[a][0]*e[0],t[3*a+1]=f[a][1]*e[1],t[3*a+2]=f[a][2]*e[2];var n={};n[y.POSITION]=new Uint32Array(O),n[y.NORMAL]=new Uint32Array(u);var o={};return o[y.POSITION]={size:3,data:t},o[y.NORMAL]={size:3,data:new Float32Array(d)},new r(o,n)}}var c=t.vec3,v=t.vec4,A=t.vec3d,y=a.VertexAttrConstants,h=e.Vec3Compact,f=.99619469809,d=A.create(),O=A.create(),u={createSphereGeometry:function(e,t,n,o,i,l,s){e=e||50,o=void 0!==o?o:-Math.PI,i=void 0!==i?i:2*Math.PI,l=void 0!==l?l:.5*-Math.PI,s=void 0!==s?s:Math.PI;var v,A,h=Math.max(3,Math.floor(t)||8),f=Math.max(2,Math.floor(n)||6),d=(h+1)*(f+1),O=new Float32Array(3*d),u=new Float32Array(3*d),w=new Float32Array(2*d),g=[],m=c.create(),I=0;for(A=0;f>=A;A++){var F=[],z=A/f,M=l+z*s,N=Math.cos(M);for(v=0;h>=v;v++){var U=v/h,P=o+U*i,S=Math.cos(P)*N*e,L=Math.sin(M)*e,R=-Math.sin(P)*N*e;O[3*I]=S,O[3*I+1]=L,O[3*I+2]=R,c.set3(S,L,R,m),c.normalize(m),u[3*I]=m[0],u[3*I+1]=m[1],u[3*I+2]=m[2],w[2*I]=U,w[2*I+1]=z,F.push(I),++I}g.push(F)}var T=new Uint32Array(2*h*(f-1)*3);for(I=0,A=0;f>A;A++)for(v=0;h>v;v++){var p=g[A][v],V=g[A][v+1],G=g[A+1][v+1],b=g[A+1][v];0===A?(T[I++]=p,T[I++]=G,T[I++]=b):A===f-1?(T[I++]=p,T[I++]=V,T[I++]=G):(T[I++]=p,T[I++]=V,T[I++]=G,T[I++]=G,T[I++]=b,T[I++]=p)}a.assert(I===T.length);var x={};x[y.POSITION]=T,x[y.NORMAL]=T,x[y.UV0]=T;var C={};return C[y.POSITION]={size:3,data:O},C[y.NORMAL]={size:3,data:u},C[y.UV0]={size:2,data:w},new r(C,x)},createPolySphereGeometry:function(e,a,t){function n(r,a){r>a&&(r=a+(a=r,0));var t=r.toString()+"."+a.toString();if(v[t])return v[t];var n=i.length;return i.length+=3,h.add(i,3*r,i,3*a,i,n),h.scale(i,n,e/h.length(i,n)),n/=3,v[t]=n,n}var o,i,l,s=e;if(t)i=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],l=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{var c=s*(1+Math.sqrt(5))/2;i=[-s,c,0,s,c,0,-s,-c,0,s,-c,0,0,-s,c,0,s,c,0,-s,-c,0,s,-c,c,0,-s,c,0,s,-c,0,-s,-c,0,s],l=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(o=0;o<i.length;o+=3)h.scale(i,o,e/h.length(i,o));var v={};for(o=0;a>o;o++){for(var A=l.length,f=new Uint32Array(4*A),d=0;A>d;d+=3){var O=l[d],u=l[d+1],w=l[d+2],g=n(O,u),m=n(u,w),I=n(w,O),F=4*d;f[F]=O,f[F+1]=g,f[F+2]=I,f[F+3]=u,f[F+4]=m,f[F+5]=g,f[F+6]=w,f[F+7]=I,f[F+8]=m,f[F+9]=g,f[F+10]=m,f[F+11]=I}l=f,v={}}var z=new Float32Array(i);for(o=0;z>o;o+=3)h.normalize(z,o);i=new Float32Array(i);var M={};M[y.POSITION]=l,M[y.NORMAL]=l;var N={};return N[y.POSITION]={size:3,data:i},N[y.NORMAL]={size:3,data:z},new r(N,M)},createPointGeometry:function(e,a,t,n,o,i,l){var s=new Float32Array(3);s[0]=a?a[0]:0,s[1]=a?a[1]:0,s[2]=a?a[2]:0;var c=new Float32Array(3);if(c[0]=e?e[0]:0,c[1]=e?e[1]:0,c[2]=e?e[2]:1,null==i){var v=new Float32Array(2);v[0]=0,v[1]=0}else{v=new Float32Array(i.length);for(var A=0;A<i.length;A++)v[A]=i[A]}var h=new Uint8Array(4);h[0]=t?255*t[0]:255,h[1]=t?255*t[1]:255,h[2]=t?255*t[2]:255,h[3]=t&&t.length>3?255*t[3]:255;var f=new Float32Array(2);if(f[0]=null!=n&&2==n.length?n[0]:1,f[1]=null!=n&&2==n.length?n[1]:1,null!=o){var d=new Float32Array(4);d[0]=o[0],d[1]=o[1],d[2]=o[2],d[3]=o[3]}if(null!=l){var O=new Float32Array(4);O[0]=l[0],O[1]=l[1],O[2]=l[2],O[3]=l[3]}var u=new Uint32Array(1);u[0]=0;var w={};w[y.POSITION]=u,w[y.NORMAL]=u,w[y.UV0]=u,w[y.COLOR]=u,w[y.SIZE]=u,null!=o&&(w[y.AUXPOS1]=u),null!=l&&(w[y.AUXPOS2]=u);var g={};return g[y.POSITION]={size:3,data:s},g[y.NORMAL]={size:3,data:c},g[y.UV0]={size:v.length,data:v},g[y.COLOR]={size:4,data:h},g[y.SIZE]={size:2,data:f},null!=o&&(g[y.AUXPOS1]={size:4,data:d}),null!=l&&(g[y.AUXPOS2]={size:4,data:O}),new r(g,w,r.DefaultOffsets,"point")},createPointArrayGeometry:function(e,a){for(var t=new Float32Array(3*e.length),n=new Float32Array(a?3*e.length:3),o=new Uint32Array(e.length),i=new Uint32Array(e.length),l=0;l<e.length;l++)t[3*l]=e[l][0],t[3*l+1]=e[l][1],t[3*l+2]=e[l][2],a&&(n[3*l]=a[l][0],n[3*l+1]=a[l][1],n[3*l+2]=a[l][2]),o[l]=l,i[l]=0;a||(n[0]=0,n[1]=1,n[2]=0);var s=new Float32Array(2);s[0]=0,s[1]=0;var c={};c[y.POSITION]=o,c[y.NORMAL]=a?o:i,c[y.UV0]=i;var v={};return v[y.POSITION]={size:3,data:t},v[y.NORMAL]={size:3,data:n},v[y.UV0]={size:2,data:s},new r(v,c,r.DefaultOffsets,"point")},createTriangleGeometry:function(){var e=new Float32Array(9);e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=100,e[6]=100,e[7]=0,e[8]=0;var a=new Uint32Array(3);a[0]=0,a[1]=1,a[2]=2;var t=new Float32Array(3);t[0]=0,t[1]=1,t[2]=0;var n=new Uint32Array(3);n[0]=0,n[1]=0,n[2]=0;var o=new Float32Array(2);o[0]=0,o[1]=0;var i=new Uint32Array(3);i[0]=0,i[1]=0,i[2]=0;var l={};l[y.POSITION]=a,l[y.NORMAL]=n,l[y.UV0]=i;var s={};return s[y.POSITION]={size:3,data:e},s[y.NORMAL]={size:3,data:t},s[y.UV0]={size:2,data:o},new r(s,l)},createSquareGeometry:function(e){var a,t,n=new Float32Array(12);if(e)for(a=0;4>a;a++)for(t=0;3>t;t++)n[3*a+t]=e[a][t];else n[0]=-1,n[1]=-1,n[2]=0,n[3]=1,n[4]=-1,n[5]=0,n[6]=1,n[7]=1,n[8]=0,n[9]=-1,n[10]=1,n[11]=0;var o=new Uint32Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=2,o[4]=3,o[5]=0;var i=new Float32Array(3);i[0]=0,i[1]=0,i[2]=1;var l=new Uint32Array(6);for(a=0;6>a;a++)l[a]=0;var s=new Float32Array(8);s[0]=0,s[1]=0,s[2]=1,s[3]=0,s[4]=1,s[5]=1,s[6]=0,s[7]=1;var c=new Uint8Array(4);c[0]=255,c[1]=255,c[2]=255,c[3]=255;var v={};v[y.POSITION]=o,v[y.NORMAL]=l,v[y.UV0]=o,v[y.COLOR]=l;var A={};return A[y.POSITION]={size:3,data:n},A[y.NORMAL]={size:3,data:i},A[y.UV0]={size:2,data:s},A[y.COLOR]={size:4,data:c},new r(A,v)},createBoxGeometry:i(),createDiamondGeometry:l(),createTetrahedronGeometry:s(),createConeGeometry:function(e,a,t,n){var o,i=0,l=a,s=e,v=c.createFrom(0,i,0),A=c.createFrom(0,i+s,0),h=c.createFrom(0,-1,0),f=c.createFrom(0,1,0);n&&(i=s,A=c.createFrom(0,0,0),v=c.createFrom(0,i,0),h=c.createFrom(0,1,0),f=c.createFrom(0,-1,0));var d=[A,v],O=[h,f],u=t+2,w=0,g=Math.sqrt(s*s+l*l);if(n)for(o=t-1;o>=0;o--)w=o*(2*Math.PI/t),m=c.createFrom(Math.cos(w)*l,i,Math.sin(w)*l),d.push(m),I=c.createFrom(s*Math.cos(w)/g,-l/g,s*Math.sin(w)/g),O.push(I);else for(o=0;t>o;o++){w=o*(2*Math.PI/t);var m=c.createFrom(Math.cos(w)*l,i,Math.sin(w)*l);d.push(m);var I=c.createFrom(s*Math.cos(w)/g,l/g,s*Math.sin(w)/g);O.push(I)}var F=new Uint32Array(2*(t+2)*3),z=new Uint32Array(2*(t+2)*3),M=0,N=0;for(o=3;o<d.length;o++)F[M++]=1,F[M++]=o-1,F[M++]=o,z[N++]=0,z[N++]=0,z[N++]=0;for(F[M++]=d.length-1,F[M++]=2,F[M++]=1,z[N++]=0,z[N++]=0,z[N++]=0,o=3;o<d.length;o++)F[M++]=o,F[M++]=o-1,F[M++]=0,z[N++]=o,z[N++]=o-1,z[N++]=1;F[M++]=0,F[M++]=2,F[M++]=d.length-1,z[N++]=1,z[N++]=2,z[N++]=O.length-1;var U=1;Array.isArray(U)||(U=[U,U,U]);var P=new Float32Array(3*u);for(o=0;u>o;o++)P[3*o]=d[o][0]*U[0],P[3*o+1]=d[o][1]*U[1],P[3*o+2]=d[o][2]*U[2];var S=new Float32Array(3*u);for(o=0;u>o;o++)S[3*o]=O[o][0],S[3*o+1]=O[o][1],S[3*o+2]=O[o][2];var L={};L[y.POSITION]=F,L[y.NORMAL]=z;var R={};return R[y.POSITION]={size:3,data:P},R[y.NORMAL]={size:3,data:S},new r(R,L)},createCylinderGeometry:function(e,a,t,n,o,i){n||(n=c.createFrom(1,0,0)),o||(o=c.createFrom(0,0,0));var l=void 0===i?!0:i,s=c.create();c.normalize(n,s);var v=c.create();c.scale(s,Math.abs(e),v);var A=c.create();c.scale(v,-.5,A),c.add(A,o);var h=c.createFrom(0,1,0);Math.abs(1-c.dot(s,h)<.2)&&c.set3(0,0,1,h);var f=c.create();c.cross(s,h,f),c.normalize(f),c.cross(f,s,h);var d=2*t+(l?2:0),O=t+(l?2:0),u=new Float32Array(3*d),w=new Float32Array(3*O),g=new Float32Array(2*d),m=new Uint32Array(3*t*(l?4:2)),I=new Uint32Array(3*t*(l?4:2));l&&(u[3*(d-2)+0]=A[0],u[3*(d-2)+1]=A[1],u[3*(d-2)+2]=A[2],g[2*(d-2)]=0,g[2*(d-2)+1]=0,u[3*(d-1)+0]=u[3*(d-2)+0]+v[0],u[3*(d-1)+1]=u[3*(d-2)+1]+v[1],u[3*(d-1)+2]=u[3*(d-2)+2]+v[2],g[2*(d-1)]=1,g[2*(d-1)+1]=1,w[3*(O-2)+0]=-s[0],w[3*(O-2)+1]=-s[1],w[3*(O-2)+2]=-s[2],w[3*(O-1)+0]=s[0],w[3*(O-1)+1]=s[1],w[3*(O-1)+2]=s[2]);var F,z,M,N=function(r,e,a){m[r]=e,I[r]=a},U=0,P=c.create(),S=c.create();for(F=0;t>F;F++)M=F*(2*Math.PI/t),c.scale(h,Math.sin(M),P),c.scale(f,Math.cos(M),S),c.add(P,S),w[3*F+0]=P[0],w[3*F+1]=P[1],w[3*F+2]=P[2],c.scale(P,a),c.add(P,A),u[3*F+0]=P[0],u[3*F+1]=P[1],u[3*F+2]=P[2],g[2*F+0]=F/t,g[2*F+1]=0,u[3*(F+t)+0]=u[3*F+0]+v[0],u[3*(F+t)+1]=u[3*F+1]+v[1],u[3*(F+t)+2]=u[3*F+2]+v[2],g[2*(F+t)+0]=F/t,g[2*F+1]=1,z=(F+1)%t,N(U++,F,F),N(U++,F+t,F),N(U++,z,z),N(U++,z,z),N(U++,F+t,F),N(U++,z+t,z);if(l){for(F=0;t>F;F++)z=(F+1)%t,N(U++,d-2,O-2),N(U++,F,O-2),N(U++,z,O-2);for(F=0;t>F;F++)z=(F+1)%t,N(U++,F+t,O-1),N(U++,d-1,O-1),N(U++,z+t,O-1)}var L={};L[y.POSITION]=m,L[y.NORMAL]=I,L[y.UV0]=m;var R={};return R[y.POSITION]={size:3,data:u},R[y.NORMAL]={size:3,data:w},R[y.UV0]={size:2,data:g},new r(R,L)},createTubeGeometry:function(r,e,t,n,o){t=t||10,n=null!=n?n:!0,a.assert(r.length>1);for(var i=[[0,0,0]],l=[],s=[],c=0;t>c;c++){l.push([0,-c-1,-((c+1)%t)-1]);var v=c/t*2*Math.PI;s.push([Math.cos(v)*e,Math.sin(v)*e])}return u.createPathExtrusionGeometry(s,r,i,l,n,o)},createPathExtrusionGeometry:function(e,t,n,i,l,s){var h,d=e.length,O=new Float32Array(t.length*d*3+(6*n.length||0)),u=new Float32Array(t.length*d+(2*n.length||0)),w=new Float32Array(t.length*d*3+(n?6:0)),g=0,m=0,I=0,F=(t.length-1)*d*6+3*i.length*2,z=new Uint32Array(F),M=new Uint32Array(F),N=0,U=0,P=c.create(),S=c.create(),L=c.create(),R=c.create(),T=(c.create(),c.create()),p=(c.create(),c.create(),c.create()),V=c.create(),G=c.create(),b=c.create(),x=c.create(),C=(c.create(),c.create(),c.create()),D=c.create(),E=c.create(),X=v.create();for(c.set3(0,1,0,b),c.subtract(t[1],t[0],S),c.normalize(S),l?(c.add(t[0],s,G),c.normalize(G,L)):c.set3(0,0,1,L),o(S,L,b,b,T,L,f),c.set(L,R),c.set(T,D),h=0;h<n.length;h++)c.scale(T,n[h][0],p),c.scale(L,n[h][2],G),c.add(p,G),c.add(p,t[0]),O[g++]=p[0],O[g++]=p[1],O[g++]=p[2],u[I++]=0;for(w[m++]=-S[0],w[m++]=-S[1],w[m++]=-S[2],h=0;h<i.length;h++)z[N++]=i[h][0]>0?i[h][0]:-i[h][0]-1+n.length,z[N++]=i[h][1]>0?i[h][1]:-i[h][1]-1+n.length,z[N++]=i[h][2]>0?i[h][2]:-i[h][2]-1+n.length,M[U++]=0,M[U++]=0,M[U++]=0;for(var q,K=n.length,B=n.length-1,Z=0;Z<t.length;Z++){if(q=!1,Z>0){c.set(S,P),Z<t.length-1?(c.subtract(t[Z+1],t[Z],S),c.normalize(S)):q=!0,c.add(P,S,x),c.normalize(x),c.add(t[Z-1],R,C),X[0]=x[0],X[1]=x[1],X[2]=x[2],X[3]=-A.dot(x,t[Z]);var j=a.rayPlane(C,P,X,G);j?(c.subtract(G,t[Z]),c.normalize(G,L),c.cross(x,L,T),c.normalize(T)):o(x,R,D,b,T,L,f),c.set(L,R),c.set(T,D)}l&&(c.add(t[Z],s,G),c.normalize(G,E));for(var k=0;d>k;k++)if(c.scale(T,e[k][0],p),c.scale(L,e[k][1],G),c.add(p,G),c.normalize(p,V),w[m++]=V[0],w[m++]=V[1],w[m++]=V[2],l?u[I++]=c.dot(p,E):u[I++]=p[2],c.add(p,t[Z]),O[g++]=p[0],O[g++]=p[1],O[g++]=p[2],!q){var H=(k+1)%d;z[N++]=K+k,z[N++]=K+d+k,z[N++]=K+H,z[N++]=K+H,z[N++]=K+d+k,z[N++]=K+d+H;for(var J=0;6>J;J++)M[U++]=z[N-6+J]-B}K+=d}for(q=t[t.length-1],h=0;h<n.length;h++)c.scale(T,n[h][0],p),c.scale(L,n[h][1],G),c.add(p,G),c.add(p,q),O[g++]=p[0],O[g++]=p[1],O[g++]=p[2],u[I++]=0;var Q=m/3;w[m++]=S[0],w[m++]=S[1],w[m++]=S[2];var W=K-d;for(h=0;h<i.length;h++)z[N++]=i[h][0]>=0?K+i[h][0]:-i[h][0]-1+W,z[N++]=i[h][2]>=0?K+i[h][2]:-i[h][2]-1+W,z[N++]=i[h][1]>=0?K+i[h][1]:-i[h][1]-1+W,M[U++]=Q,M[U++]=Q,M[U++]=Q;var Y={};Y[y.POSITION]=z,Y[y.NORMAL]=M;var $={};return $[y.POSITION]={size:3,data:O},$.zOffset={size:1,data:u},$[y.NORMAL]={size:3,data:w},new r($,Y)},createPolylineGeometry:function(e){a.assert(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),a.assert(3===e[0].length,"createPolylineGeometry(): malformed vertex");for(var t=new Float32Array(3*e.length),n=new Uint32Array(2*(e.length-1)),o=0,i=0,l=0;l<e.length;l++){for(var s=0;3>s;s++)t[o++]=e[l][s];l>0&&(n[i++]=l-1,n[i++]=l)}var c={},v={};return c[y.POSITION]=n,v[y.POSITION]={size:3,data:t},new r(v,c,r.DefaultOffsets,"line")},addVertexColors:function(e,a,t){var n,o,i,l;if(t){var s={},c=e.getVertexAttr();for(l in c)s[l]=c[l];var v=e.getFaces();for(n=new Array(v.length),i=0;i<v.length;i++){o={};for(l in v[i].indices)o[l]=v[i].indices[l];n[i]={type:v[i].type,indices:o,positionKey:v[i].positionKey}}e=new r(n,s)}var A=a||[1,1,1,1],h=new Uint8Array(4);h[0]=255*A[0],h[1]=255*A[1],h[2]=255*A[2],h[3]=255*(A.length>3?A[3]:1);var f=e.getVertexAttr();for(f[y.COLOR]={size:4,data:h},n=e.getFaces(),i=0;i<n.length;i++){var d=n[i],O=d.indices[d.positionKey].length;o=new Uint32Array(O),d.indices[y.COLOR]=o}return e},addNormals:function(r){for(var a=r.getVertexAttr(),t=r.getFaces(),n=e.Vec3Compact.subtract,o=t.map(function(r){return r.indices.position.length/3}).reduce(function(r,e){return r+e}),i=new Float32Array(3*o),l=a.position.data,s=0,c=0;c<t.length;c++){for(var v=t[c].indices.position,y=new Uint32Array(v.length),h=0;h<v.length;h+=3){n(l,3*v[h],l,3*v[h+2],O,0),n(l,3*v[h],l,3*v[h+1],d,0),A.cross(d,O),A.normalize(d);var f=s/3;i[s++]=d[0],i[s++]=d[1],i[s++]=d[2],y[h]=f,y[h+1]=f,y[h+2]=f}t[c].indices.normal=y}a.normal={size:3,data:i}},cgToGIS:function(r){var e,a,t=r.getVertexAttr(),n=t.position.data,o=t.normal.data;if(o)for(e=0;e<o.length;e+=3)a=o[e+1],o[e+1]=-o[e+2],o[e+2]=a;if(n)for(e=0;e<n.length;e+=3)a=n[e+1],n[e+1]=-n[e+2],n[e+2]=a}};return u});