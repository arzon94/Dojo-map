// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","./Texture","./Util","../../../webgl/Texture","../../../webgl/enums"],function(t,e,i,r,n,o){function h(){var t=document.createElement("canvas");return t.width=g,t.height=g,t}function s(t,e){return"center"===t?.5*e:"right"===t?e:0}function a(t){var e=t.slice(0,3).map(function(t){return Math.floor(255*t)}).toString();return"rgb("+e+")"}function l(t){var e=t.slice(0,3).map(function(t){return Math.floor(255*t)}).toString();return"rgba("+e+","+t[3]+")"}function u(){return _}for(var g=1024,p=function(){function t(t,e,i){this._idHint=i,this._text=t,this._textLines=t.split(/\r?\n/),this._params=e;var r=this._params.halo.size;this._haloSize=Math.round(r),this._fillStyle=l(this._params.color),this._haloStyle=a(this._params.halo.color)}return t.prototype.getId=function(){return null==this._id&&(this._id=i.idGen.gen(this._idHint)),this._id},t.prototype.getParams=function(){return this._params},t.prototype.getString=function(){return this._text},t.prototype.deferredLoading=function(){return!1},t.prototype.getWidth=function(){if(null!=this._width)return this._width;var t=this.getTextWidth();return this._params.usedInAtlas||(t=r.nextHighestPowerOfTwo(t)),this._width=t,this._width},t.prototype.getHeight=function(){if(null!=this._height)return this._height;var t=this.getTextHeight();return this._params.usedInAtlas||(t=r.nextHighestPowerOfTwo(t)),this._height=t,this._height},t.prototype.initializeThroughRender=function(t,e){var i=this._getTextCanvas(),r=i.getContext("2d");r.save();var o=this.getWidth(),h=this.getHeight(),s=this.getTextWidth(),a=this.getTextHeight();i.width=o,i.height=h,e.samplingMode=9987,e.wrapMode=33071,e.flipped=!0,e.preMultiplyAlpha=!0,e.hasMipmap=!0,this.renderText(1,s,a,r,0,h-a);var l=new n(t,e,i);return r.restore(),l},t.prototype.getTextWidth=function(){var t=this._getTextCanvas(),e=t.getContext("2d");this._setFontProperties(e,this._params.size);for(var i=0,r=0,n=this._textLines;r<n.length;r++){var o=n[r],h=e.measureText(o).width;h>i&&(i=h)}var s=this._params.font;return("italic"===s.style||"oblique"===s.style||"string"==typeof s.weight&&("bold"===s.weight||"bolder"===s.weight)||"number"==typeof s.weight&&s.weight>600)&&(i+=.3*e.measureText("A").width),i+=2*this._haloSize,Math.round(i)},t.prototype.getTextHeight=function(){return this.getLineHeight()*this._textLines.length},t.prototype.getTexcoordScale=function(){var t=this.getTextWidth(),e=this.getTextHeight();return[t/this.getWidth(),e/this.getHeight()]},t.prototype.getLineHeight=function(){var t=1.275*this._params.size;return Math.floor(t+2*this._haloSize)},t.prototype.setUnloadFunc=function(t){this._unloadFunc=t},t.prototype.unload=function(){this._unloadFunc&&(this._unloadFunc(this._id),this._unloadFunc=null)},t.prototype.renderText=function(t,e,i,r,n,o){void 0===n&&(n=0),void 0===o&&(o=0);var h=this.getLineHeight()*t,a=this._haloSize,l=n+s(r.textAlign,e)+a,p=o+a;r.save();var _=a>0,f=3>a;if(_){var d=p,c=this._getHaloCanvas(),v=c.getContext("2d");if(v.clearRect(0,0,g,g),this._setFontProperties(v,this._params.size*t),v.fillStyle=this._haloStyle,v.strokeStyle=this._haloStyle,v.lineJoin=f?"miter":"round",f)for(var x=0,y=this._textLines;x<y.length;x++){for(var m=y[x],T=0,w=u();T<w.length;T++){var S=w[T],C=S[0],H=S[1];v.fillText(m,l+a*C,p+a*H)}d+=h}else for(var b=0,M=this._textLines;b<M.length;b++){for(var m=M[b],z=2*a,L=5,F=.1,P=0;L>P;P++){var A=1-(L-1)*F,W=A+P*F;v.lineWidth=W*z,v.strokeText(m,l,d)}d+=h}r.globalAlpha=this._params.halo.color[3],r.drawImage(c,0,0),r.globalAlpha=1}this._setFontProperties(r,this._params.size*t);for(var d=p,D=0,I=this._textLines;D<I.length;D++){var m=I[D];r.globalCompositeOperation="destination-out",r.fillStyle="rgb(0, 0, 0)",r.fillText(m,l,d),r.globalCompositeOperation="source-over",r.fillStyle=this._fillStyle,r.fillText(m,l,d),d+=h}r.restore()},t.prototype._getTextCanvas=function(){return null==t._textCanvas2D&&(t._textCanvas2D=h()),t._textCanvas2D},t.prototype._getHaloCanvas=function(){return null==t._haloCanvas2D&&(t._haloCanvas2D=h()),t._haloCanvas2D},t.prototype._setFontProperties=function(t,e){var i=this._params.font,r=i.style+" "+i.weight+" "+e+"px "+i.family;t.font=r,t.textAlign="left",t.textBaseline="top"},t}(),_=[],f=16,d=0;360>d;d+=360/f)_.push([Math.cos(Math.PI*d/180),Math.sin(Math.PI*d/180)]);return p});