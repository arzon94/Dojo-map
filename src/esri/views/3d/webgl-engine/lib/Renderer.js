// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","./IntervalUtilities","./ModelDirtyTypesTs","./Float32ArrayList","./InstanceBufferData","../lighting/SceneLighting","../materials/internal/SimpleGLMaterial","./LinearDepthTextureHelper","./NormalTextureHelper","./HighlightTextureHelper","./RenderPass","./RenderSlot","./RenderContext","./ExternalRendererContainer","./StencilRenderingHelper","./Util","./gl-matrix","./ComponentUtils","../../../webgl/Texture","../../../webgl/VertexArrayObject","../../../webgl/BufferObject","../../../webgl/Util","./FxaaRenderPass","./SmaaRenderPass","../../../webgl/enums","./DefaultVertexAttributeLocations","../../../webgl/Profiling"],function(e,t,r,a,i,n,s,o,d,l,h,g,f,p,m,u,_,c,v,x,y,I,R,b,A,C,H,T){function D(e){var t=e.instanceParameters.componentVisibilities,r=e.componentOffsets,a=v.generateVisibleIndexRanges(t,r);return a}function O(e){var t=e.instanceParameters.componentVisibilities,r=e.instanceParameters.componentHighlights,a=e.componentOffsets,i=v.generateHighlightedIndexRanges(t,r,a);return i}var M=_.assert,P=_.objectEmpty,S=_.getFirstObjectValue,w=_.setMatrixTranslation3,E=c.vec2d,L=c.vec4d,B=c.mat4d,N=_.VertexAttrConstants,V=B.identity(),G=1535,F=!1,U=function(){function e(e,t,r,a,i){this._lighting=new s.SceneLighting,this._mat2dataMerged={},this._mat2dataInstanced={},this._renderOrder=[],this._externalRenderers=new m,this._renderContext=new p,this._framesRendered=0,this._isRendering=!1,this._highlights=[],this._pixelRatio=1,this._threshold=G,this._needsRender=!0,this._fallbackDepthStencilTexture=null,this._stats=new q,this.ssaoEnabled=!1,this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1},this._programRep=e,this._materialRep=t,this._textureRep=r,this._orderedRendering=i,this._rctx=a;var n=a.gl;this._fxaaPass=new b(a),this._smaaPass=new A(a),this._selectionMaterial=new o(e,L.createFrom(.1,.2,.9,.4),n.EQUAL),this._selectionMaterialLines=new o(e,L.createFrom(.1,.2,.9,.4),n.EQUAL,n.LINES),this._renderContext.lightingData=this._lighting.getOld(),a.setDepthTestEnabled(!0),a.setFaceCullingEnabled(!0),a.setBlendingEnabled(!1),a.setBlendFunctionSeparate(770,771,1,771),this._bindParameters={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null,extensions:{angleInstancedArrays:a.extensions.angleInstancedArrays}},this._linearDepthTextureHelper=new d(a),this._normalTextureHelper=new l(a),this._highlightTextureHelper=new h(a),this._stencilRenderingHelper=new u(a),this._initializeFramebufferTexture()}return e.prototype._initializeFramebufferTexture=function(){var e=this._rctx.gl,t=this._rctx.contextAttributes,r=t.alpha?e.RGBA:e.RGB,a=new x(this._rctx,{target:3553,pixelFormat:r,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:r,texture:a}},e.prototype.dispose=function(){for(var e in this._mat2dataMerged){this._releaseMaterials(e);var t=this._mat2dataMerged[e];for(var r in t.origin2data)t.origin2data[r].vao.dispose(!0)}this._mat2dataMerged=null;for(var e in this._mat2dataInstanced){this._releaseMaterials(e);var t=this._mat2dataInstanced[e];for(var r in t.origin2data)t.origin2data[r].vao.dispose(!0)}this._mat2dataInstanced=null,this._framebuffer.texture.dispose(),this._framebuffer.texture=null,this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable(),this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable(),this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1),this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1),this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null)},e.prototype.setLighting=function(e){this._lighting.set(e)},e.prototype.setPixelRatio=function(e){this._pixelRatio=e,this._needsRender=!0},e.prototype.getPixelRatio=function(){return this._pixelRatio},e.prototype.addExternalRenderer=function(e,t){return this._externalRenderers.addRenderer(e,t),!0},e.prototype.removeExternalRenderer=function(e){return this._externalRenderers.removeRenderer(e),!0},e.prototype.getExternalRenderers=function(){return this._externalRenderers},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._externalRenderers.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()},e.prototype.getCombinedStats=function(){this._stats.VBOallocatedSize=0,this._stats.VBOoptimalSize=0,this._stats.VBOusedSize=0;for(var e in this._mat2dataInstanced){var t=this._mat2dataInstanced[e];for(var r in t.origin2data){var a=t.origin2data[r];this._stats.VBOallocatedSize+=a.buffer.getArray().length,this._stats.VBOusedSize+=a.buffer.getSize(),this._stats.VBOoptimalSize+=a.optimalCount}}for(var e in this._mat2dataMerged){var t=this._mat2dataMerged[e];for(var r in t.origin2data){var a=t.origin2data[r];this._stats.VBOallocatedSize+=a.buffer.getArray().length,this._stats.VBOusedSize+=a.buffer.getSize(),this._stats.VBOoptimalSize+=a.optimalCount}}return this._stats.VBOallocatedSize*=4/1024,this._stats.VBOusedSize*=4/1024,this._stats.VBOoptimalSize*=4/1024,this._stats},e.prototype._addHighlight=function(e){var t=this._getInstance(e,!0)||this._getInstance(e,!1);return null===t?void console.error("No instance found for RenderGeometry {name: '"+e.name+"', uniqueName: '"+e.uniqueName+"'}"):(this._highlights.push(t),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,void(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)))},e.prototype._removeHighlight=function(e){var t=this._highlights.length;this._highlights=this._highlights.filter(function(t){return t.uniqueName!==e.uniqueName}),t!==this._highlights.length&&(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights),this._needsRender=!0)},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlights.length>0},enumerable:!0,configurable:!0}),e.prototype._renderHUDVisibility=function(e){var t=this;e.offscreenRenderingHelper.renderHUDVisibility(function(){t._renderInternalSlot(f.OCCLUSION_PIXELS,e)})},e.prototype.renderGeometrySlots=function(e){this._externalRenderers.render(f.INTERNAL_MATERIAL,e),this._renderInternalSlot(f.STENCIL_MATERIAL,e),this._externalRenderers.render(f.OPAQUE_TERRAIN,e),this._renderInternalSlot(f.OPAQUE_MATERIAL,e),this._externalRenderers.render(f.OPAQUE_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._renderInternalSlot(f.TRANSPARENT_MATERIAL,e),this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(e),this._renderInternalSlot(f.LINE_CALLOUTS,this._renderContext)),this._externalRenderers.render(f.TRANSPARENT_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._externalRenderers.render(f.TRANSPARENT_TERRAIN,e)},e.prototype._renderHighlights=function(e,t,r){var a=!!r&&r.getEnableState(),i=a&&(this.hasHighlights||this._externalRenderers.needsHighlight());if(this._highlightTextureHelper.setEnableState(i),i){var n=null;r.profilingCallback&&(n=T.startMeasurement(this._renderContext.rctx)),this._highlightTextureHelper.setupFBOs(e),this._highlightTextureHelper.prepareHighlightPass(),this.renderGeometryPass(g.MATERIAL_HIGHLIGHT,e,null,null);var s=this._rctx.gl;this._rctx.clear(s.DEPTH_BUFFER_BIT),this._renderInternalSlot(f.LINE_CALLOUTS_HUD_DEPTH,this._renderContext),this._renderInternalSlot(f.HUDMATERIAL1,this._renderContext),this._renderInternalSlot(f.HUDMATERIAL2,this._renderContext),this._highlightTextureHelper.finish(t);var o=this._highlightTextureHelper.getHighlightFBO();r.render(e,t,o),null!==n&&r.profilingCallback&&n.stop(function(e){r.profilingCallback&&r.profilingCallback(e)})}},e.prototype._renderUnordered=function(e,t,r,a,i,n){var s=this._rctx;switch(this._isRendering=!0,this._stats.reset(),this._updateGlobalUniforms(e.projectionMatrix),this._renderContext.pass=g.MATERIAL,this._renderContext.camera=e,this._renderContext.shadowMap=t,this._renderContext.ssaoHelper=r,this._renderContext.offscreenRenderingHelper=i,this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO(),this._renderContext.options=this.renderOptions,this._renderContext.rctx=this._rctx,this._renderContext.lightingData=this._lighting.getOld(),i.setEnableState(!0),i.initializeFrame(e),this._externalRenderers.render(f.BACKGROUND,this._renderContext),this.renderGeometrySlots(this._renderContext),this._externalRenderers.render(f.POSTPROCESSING_ATMOSPHERE,this._renderContext),this.renderOptions.earlyOcclusionPixelDraw||(this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(f.LINE_CALLOUTS,this._renderContext)),this.renderOptions.antialiasing){case"none":var o=e.viewport,d=B.ortho(o[0],o[2],o[1],o[3],-1,1);i.drawQuad(d),this._fxaaPass.disable(),this._smaaPass.disable();break;case"fxaa":this._smaaPass.disable(),this._fxaaPass.render({colorTexture:i.getColorTexture()},null);break;case"smaa":this._fxaaPass.disable(),this._smaaPass.render({colorTexture:i.getColorTexture()},null)}if(s.bindFramebuffer(null),this._renderContext.framebufferTex=i.getColorTexture(),this._renderInternalSlot(f.LINE_CALLOUTS_HUD_DEPTH,this._renderContext),this._renderInternalSlot(f.HUDMATERIAL1,this._renderContext),this._renderInternalSlot(f.HUDMATERIAL2,this._renderContext),this._renderHighlights(e,a,n),F){var l=this._stats;window.FPSCounterDebugString="dc: "+(l.drawCallsInstanced+l.drawCallsMerged)+" instanced: "+l.drawCallsInstanced+" merged: (dc: "+(l.drawCallsInstanced+l.drawCallsMerged)+" instanced: "+l.drawCallsInstanced+" merged: "+l.drawCallsMerged+")"}this._framesRendered++,this._isRendering=!1},e.prototype._renderGeometryPassOrderedHighlight=function(e){this._renderInternalHighlights(this._highlights)},e.prototype._renderGeometryPassOrderedMaterial=function(e){for(var t=null,r=0;r<this._renderOrder.length;r++){var a=this._renderOrder[r][1];if(a.instanced){var i=a.instanced||a.merged,n=i[e.pass];!n||n.isVisible&&!n.isVisible()||(this._renderInternalInstanced(i,n,this._bindParameters,1/0),t=null)}if(a.merged){var i=a.merged,n=i[e.pass];if(n&&(!n.isVisible||n.isVisible())){var s=n.getProgram();s!==t&&(s.setUniformMatrix4fv("model",V),s.hasUniform("modelNormal")&&s.setUniformMatrix4fv("modelNormal",V)),t=s,this._renderInternalMerged(i,n,this._bindParameters,1/0)}}}},e.prototype._renderGeometryPassOrdered=function(e){var t=e.camera;this._bindParameters.view=t.viewMatrix,this._bindParameters.proj=t.projectionMatrix,this._bindParameters.viewInvTransp=t.viewInverseTransposeMatrix,k[0]=t.near,k[1]=t.far,this._bindParameters.nearFar=k,this._bindParameters.lightingData=this._lighting.getOld(),this._bindParameters.viewport=t.fullViewport,this._bindParameters.framebufferTex=this._framebuffer.texture,this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO(),this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO(),e.isHighlightPass?this._renderGeometryPassOrderedHighlight(e):this._renderGeometryPassOrderedMaterial(e)},e.prototype._renderOrdered=function(e,t){this._stats.reset(),this.renderGeometryPass(e,t),this._framesRendered++},e.prototype.render=function(e,t,r,a,i,n){this._orderedRendering?this._renderOrdered(g.MATERIAL,e):this._renderUnordered(e,t,r,a,n,i)},e.prototype.renderAuxiliaryBuffers=function(e,t,r,a,i){var n=this.ssaoEnabled;this._linearDepthTextureHelper.setEnableState(n),n&&(this._linearDepthTextureHelper.setupFBOs(e),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(g.MATERIAL_DEPTH,e,t,r),this._linearDepthTextureHelper.finish(a)),this._normalTextureHelper.setEnableState(this.ssaoEnabled),this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(e),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(g.MATERIAL_NORMAL,e,t,r),this._normalTextureHelper.finish(a)),this.ssaoEnabled&&r.computeSSAO(e,a,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO()),r.bindAll(this._programRep)},e.prototype.renderGeometryPass=function(e,t,r,a){this._isRendering=!0,this._updateGlobalUniforms(t.projectionMatrix),this._renderContext.pass=e,this._renderContext.camera=t,this._renderContext.shadowMap=r,this._renderContext.ssaoHelper=a,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.rctx=this._rctx,this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext),this._isRendering=!1},e.prototype._renderGeometryPassUnordered=function(e){this.renderGeometrySlots(e)},e.prototype._renderInternalHighlights=function(e,t){void 0===t&&(t=null);for(var r=0;r<e.length;++r){var a=e[r],i=a.matData[g.MATERIAL_HIGHLIGHT];!i||null!==t&&!i.beginSlot(t)||i.isVisible&&!i.isVisible()||this._renderInternalHighlight(a,this._bindParameters,g.MATERIAL_HIGHLIGHT)}},e.prototype._renderInternalSlotMaterial=function(e,t){for(var r in this._mat2dataInstanced){var a=this._mat2dataInstanced[r],i=a[t.pass];i&&i.beginSlot(e)&&(!i.isVisible||i.isVisible())&&this._renderInternalInstanced(a,i,this._bindParameters,e)}for(var n=this._programRep.getProgramsUsingUniform("model"),s=this._programRep.getProgramsUsingUniform("modelNormal"),o=0;o<n.length;o++){var d=n[o];d.setUniformMatrix4fv("model",V),s.indexOf(d)>-1&&d.setUniformMatrix4fv("modelNormal",V)}for(var r in this._mat2dataMerged){var a=this._mat2dataMerged[r],i=a[t.pass];i&&i.beginSlot(e)&&(!i.isVisible||i.isVisible())&&this._renderInternalMerged(a,i,this._bindParameters,e)}e===f.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish()},e.prototype._renderInternalSlotHighlights=function(e,t){this._renderInternalHighlights(this._highlights,e)},e.prototype._renderInternalSlot=function(e,t){this._bindParameters.view=t.camera.viewMatrix,this._bindParameters.proj=t.camera.projectionMatrix,this._bindParameters.viewInvTransp=t.camera.viewInverseTransposeMatrix,this._bindParameters.cameraAboveGround=t.camera.aboveGround,this._bindParameters.fovY=t.camera.fovY,this._bindParameters.poiDistance=t.camera.distance,k[0]=t.camera.near,k[1]=t.camera.far;var r=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=k,this._bindParameters.lightingData=this._lighting.getOld(),this._bindParameters.viewport=t.camera.fullViewport,this._bindParameters.framebufferTex=r?r.getColorTexture():null,this._bindParameters.shadowMap=t.shadowMap,this._bindParameters.shadowMappingEnabled=!!t.shadowMap&&t.shadowMap.getEnableState(),this._bindParameters.ssaoEnabled=!!t.ssaoHelper&&t.ssaoHelper.getEnableState(),this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO(),this._bindParameters.hudVisibilityTexture=r?r.getHUDVisibilityTexture():null,t.isHighlightPass?this._renderInternalSlotHighlights(e,t):this._renderInternalSlotMaterial(e,t)},e.prototype._renderInternalInstanced=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1,o=t.getDrawMode(i),d=this._bindParameters.extensions.angleInstancedArrays;for(var l in e.origin2data){var h=e.origin2data[l];r.origin=h.origin,a===f.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());var g=!1;if(t.instanced)for(var p in h.perGeometryDataInfo){var m=h.perGeometryDataInfo[p];s||(t.bind(i,r),s=!0),i.bindVAO(m.vao);var u=t.getProgram();R.assertCompatibleVertexAttributeLocations(m.vao,u),g||(t.bindView(i,r),g=!0);var _=m.to-m.from,c=m.refCount;o===n.TRIANGLES&&(this._stats.trianglesRendered+=c*_/3),d.drawArraysInstancedANGLE(o,m.from,_,c),this._stats.drawCallsAngleInstanced++,this._stats.instancesDrawnAngle+=c}else{var v=h.instances;for(var x in v){var y=v[x],I=y.displayedIndexRange;I&&0===I.length||(s||(t.bind(i,r),s=!0),g||(i.bindVAO(h.vao),t.bindView(i,r),g=!0),t.bindInstance(i,y),this._stats.drawCallsInstanced++,o===n.TRIANGLES&&(this._stats.trianglesRendered+=(y.to-y.from)/3),I?this._drawArraysFaceRange(I,y.from,o):i.drawArrays(o,y.from,y.to-y.from))}}}i.bindVAO(null),s&&t.release(i,r)},e.prototype._renderInternalHighlight=function(e,t,r){var a=this._rctx,i=a.gl,n=e.matData[r],s=n.getDrawMode(a),o=e.instance,d=o.highlightedIndexRange,l=this._renderContext.offscreenRenderingHelper,h=(l?l.getDepthTexture():null)||this._getFallbackDepthTexture(),g=n.getProgram(),f=this._bindParameters.extensions.angleInstancedArrays;if(t.origin=e.originData.origin,n.instanced&&"instanced"===e.type){var p=e.instancedVAO;n.bind(a,t),a.bindVAO(p),R.assertCompatibleVertexAttributeLocations(p,g),n.bindView(a,t);for(var m=0;m<d.length;m++){var u=d[m],_=u.range?u.range[0]+o.from:o.from,c=u.range?u.range[1]-u.range[0]+1:o.to-o.from;a.bindTexture(h,5),g.setUniform1i("depthTex",5),g.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),f.drawArraysInstancedANGLE(s,_,c,1),s===i.TRIANGLES&&(this._stats.trianglesRendered+=1*c/3),this._stats.drawCallsHighlight++}}else if("merged"===e.type||"instanced"===e.type&&!n.instanced){var p=e.originData.vao;n.bind(a,t),a.bindVAO(p),n.bindView(a,t),"instanced"===e.type?n.bindInstance(a,o):g.setUniformMatrix4fv("model",V);for(var m=0;m<d.length;m++){var u=d[m],_=u.range?u.range[0]+o.from:o.from,c=u.range?u.range[1]-u.range[0]+1:o.to-o.from;a.bindTexture(h,5),n.getProgram().setUniform1i("depthTex",5),g.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),a.drawArrays(s,_,c),s===i.TRIANGLES&&(this._stats.trianglesRendered+=c/3),this._stats.drawCallsHighlight++}}else console.error("_renderInternalHighlight: incompatible istance type");a.bindVAO(null),n.release(a,t)},e.prototype._drawArraysFaceRange=function(e,t,r){for(var a=this._rctx,i=0;i<e.length;i++){var n=e[i];a.drawArrays(r,n[0]+t,n[1]-n[0]+1)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._renderInternalMerged=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1;for(var o in e.origin2data){var d=e.origin2data[o];if(r.origin=d.origin,a===f.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass()),!d.displayedIndexRange||0!==d.displayedIndexRange.length){s||(t.bind(i,r),s=!0);var l=t.getProgram();i.bindVAO(d.vao),R.assertCompatibleVertexAttributeLocations(d.vao,l),t.bindView(i,r),this._stats.drawCallsMerged++;var h=t.getDrawMode(i);h===n.TRIANGLES&&(this._stats.trianglesRendered+=d.vao.vertexBuffers.geometry.size/3),d.displayedIndexRange?this._drawArraysFaceRange(d.displayedIndexRange,0,h):i.drawArrays(h,0,R.vertexCount(d.vao,"geometry"))}}s&&t.release(i,r)},e.prototype._updateGlobalUniforms=function(e){for(var t=this._programRep.getProgramsUsingUniform("proj"),r=0;r<t.length;r++)t[r].setUniformMatrix4fv("proj",e);if(this._lighting){t=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r]);t=this._programRep.getProgramsUsingUniform("lightDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r])}},e.prototype.print=function(){var e=Object.keys(this._mat2dataMerged).length,t=Object.keys(this._mat2dataInstanced).length;console.log("number of materials (merged/instanced): "+e+"/"+t);var r=0;for(var a in this._mat2dataMerged){var i=this._mat2dataMerged[a];for(var n in i.origin2data)r+=Object.keys(i.origin2data[n].instances).length}var s=0;for(var a in this._mat2dataInstanced){var i=this._mat2dataInstanced[a];for(var n in i.origin2data)s+=Object.keys(i.origin2data[n].instances).length}console.log("number of instances (merged/instanced): "+r+"/"+s)},e.prototype.isEmpty=function(){for(var e in this._mat2dataInstanced){var t=this._mat2dataInstanced[e];for(var r in t.origin2data)if(!P(t.origin2data[r].instances))return!1}for(var e in this._mat2dataMerged){var t=this._mat2dataMerged[e];for(var r in t.origin2data)if(!P(t.origin2data[r].instances))return!1}return!0},e.prototype.modify=function(e,t,r,a){this._isRendering&&console.warn("Renderer.modify called while rendering");var i=[],n=[];this._mergedOrInstanced(e,i,n);var s=[],o=[];this._mergedOrInstanced(t,s,o);var d={};r&&this._performUpdates(r,d);var l=[];this._modifyMerged(i,s,l,d),this._modifyInstanced(n,o,l),this._updateMergedFaceranges(d),this._releaseMaterials(l);var h=this._highlights.length;t&&t.length>0&&h>0&&(this._highlights=this._highlights.filter(function(e){return!t.some(function(t){return t.uniqueName===e.uniqueName})}),h!==this._highlights.length&&this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)),this._updateHighlightVAOs(),this._modifyMaterials(a),this._needsRender=!0},e.prototype._isInstanced=function(e){var t=!1,r=S(e.data.faces.indices).length;return t=t||e.material.canBeMerged===!1,t=t||e.material.instanced,t=t||e.material.isBackdrop,e.singleUse?t:t=t||r>this._threshold},e.prototype._mergedOrInstanced=function(e,t,r){for(var a=0;a<e.length;++a){var i=S(e[a].data.faces.indices).length;if(!(1>i)){var n=this._isInstanced(e[a]);n?r.push(e[a]):t.push(e[a])}}},e.prototype._performUpdates=function(e,t){for(var r=0;r<e.length;r++){var a=e[r],i=a.renderGeometry,n=this._isInstanced(i),s=a.updateType;if(2&s&&this._updateFaceranges(i,n,t),32&s){var o=this._getInstance(i,n);o&&this._updateHighlightFaceranges(i,o.instance)}4&s||!n&&16&s?this._updateVertexAttributes(i,n):n&&16&s?this._updateInstanceTransformation(i,n):8&s&&this._updateColorAttributes(i)}},e.prototype._updateFaceranges=function(e,t,r){var a=e.material,i=a.getId(),n=e.origin.id,s=t?this._mat2dataInstanced:this._mat2dataMerged,o=s[i],d=o.origin2data[n],l=d.instances[e.uniqueName];l&&(l.displayedIndexRange=D(e),t||(r[this._modifiedMergedFacerangesKey(i,n)]=d),this._updateHighlightFaceranges(e,l))},e.prototype._updateHighlightFaceranges=function(e,t){if(t){var r=t.highlightedIndexRange,a=O(e);t.highlightedIndexRange=a,a&&!r?this._addHighlight(e):!a&&r&&this._removeHighlight(e)}},e.prototype._updateMergedFaceranges=function(e){for(var t in e){var a=e[t];a.displayedIndexRange=[];var i=a.instances,n=!0;for(var s in i){var o=i[s];o.displayedIndexRange?(a.displayedIndexRange.push.apply(a.displayedIndexRange,r.offsetIntervals(o.displayedIndexRange,o.from)),n=!1):a.displayedIndexRange.push([o.from,o.to-1])}n?a.displayedIndexRange=null:a.displayedIndexRange=r.mergeIntervals(a.displayedIndexRange)}},e.prototype._updateVertexAttributes=function(e,t){var r,a,i=e.material,n=i.getId(),s=e.origin.id,o=t?this._mat2dataInstanced:this._mat2dataMerged,d=o[n],l=d.origin2data[s],h=l.instances[e.uniqueName];if(!t){var g=e.origin.vec3;w(j,-g[0],-g[1],-g[2]),B.multiply(j,e.transformation,Q),B.inverse(Q,K),B.transpose(K),r=Q,a=K}var f=R.getStride(i.getVertexBufferLayout()),p=f/4;M(h.from+i.getOutputAmount(S(e.data.faces.indices).length)/p===h.to,"material VBO layout has changed"),i.fillInterleaved(e.data,r,a,e.instanceParameters,l.buffer.getArray(),h.from*p),l.vao.vertexBuffers.geometry.setSubData(l.buffer.getArray(),h.from*f,h.from*f,h.to*f)},e.prototype._updateInstanceTransformation=function(e,t){var r=e.origin.vec3,a=t?this._mat2dataInstanced:this._mat2dataMerged,i=a[e.material.getId()],n=i.origin2data[e.origin.id],s=n.instances[e.uniqueName];w(j,-r[0],-r[1],-r[2]),B.multiply(j,e.transformation,s.transformation),B.inverse(s.transformation,s.transformationNormal),B.transpose(s.transformationNormal,s.transformationNormal);var o=n.perGeometryDataInfo[e.data.id],d=o.instanceBufferData;if(d){var l=d.getSlot(e.idx);d.fill(l,0,s.transformation),d.fill(l,16,s.transformationNormal);var h=d.getOffset(l),g=4*h,f=R.getStride(o.vao.layout.instance);o.vao.vertexBuffers.instance.setSubData(d.getArray(),g,g,g+f)}},e.prototype._updateColorAttributes=function(e){var t=e.material,r=t.getId(),a=e.origin.id,i=this._isInstanced(e),n=i?this._mat2dataInstanced:this._mat2dataMerged,s=n[r],o=s.origin2data[a],d=o.instances[e.uniqueName],l=(g={},g[N.COLOR]=!0,g[N.SYMBOLCOLOR]=!0,g),h=R.getStride(t.getVertexBufferLayout())/4;M(d.from+t.getOutputAmount(S(e.data.faces.indices).length)/h===d.to,"material VBO layout has changed"),t.fillInterleaved(e.data,void 0,void 0,e.instanceParameters,o.buffer.getArray(),d.from*h,l),o.vao.vertexBuffers.geometry.setSubData(o.buffer.getArray(),d.from*h*4,d.from*h*4,d.to*h*4);var g},e.prototype._modifyMerged=function(e,t,r,a){var n=this._rctx,s=this._compMat2delta(e,t,!1);for(var o in s){var d=s[o];for(var l in d){var h=d[l],f=h.optimalCount,p=h.material,m=p.getVertexBufferLayout(),u=R.getStride(m)/4,_=this._mat2dataMerged[o];if(null==_){M(f>0);var c=p.getRenderPriority();_={origin2data:{}},_[g.MATERIAL]=this._materialRep.aquire(p),_[g.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(p),_[g.MATERIAL_NORMAL]=this._materialRep.aquireNormal(p),_[g.MATERIAL_DEPTH]=this._materialRep.aquireDepth(p),_[g.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(p),this._mat2dataMerged[o]=_,this._orderedRendering&&this._insertIntoRenderOrder(_,c,"merged")}var v=_.origin2data[l];if(null==v&&(M(f>0),v={instances:{},vao:new y(n,H.Default3D,{geometry:m},{geometry:I.createVertex(n,35044)}),buffer:new i(f),optimalCount:0,origin:h.origin},_.origin2data[l]=v),f>0){var x=v.buffer.getSize(),b=v.buffer.getArray(),A=f<h.sparseCount/2,C=v.buffer.resize(A?f:h.sparseCount),T=h.toRemove;if(A||C){x=0;for(var O=v.buffer.getArray(),P=!1,E=0;E<T.length;++E){var L=v.instances[T[E].uniqueName];v.optimalCount-=(L.to-L.from)*u,delete v.instances[T[E].uniqueName]}var N={};for(var V in v.instances){var L=v.instances[V];M(null==N[L.from]),N[L.from]=L}for(var G in N){var L=N[G],F=L.from*u,U=L.to*u;O.set(b.subarray(F,U),x),L.from=x/u,x+=U-F,L.to=x/u,L.displayedIndexRange&&(P=!0)}M(x===v.optimalCount)}else for(var E=0;E<T.length;++E){var q=T[E].uniqueName;M(void 0!==v.instances[q]);var F=v.instances[q].from*u,U=v.instances[q].to*u;v.buffer.erase(F,U),delete v.instances[q],v.optimalCount-=U-F}w(j,-h.origin[0],-h.origin[1],-h.origin[2]);for(var k=h.toAdd,W=!1,E=0;E<k.length;++E){var X=k[E],Y=X.data;B.multiply(j,X.transformation,Q),B.inverse(Q,K),B.transpose(K);var J=x;p.fillInterleaved(Y,Q,K,X.instanceParameters,v.buffer.getArray(),x);var Z=p.getOutputAmount(S(Y.faces.indices).length),$=J+Z;M(null==v.instances[X.uniqueName]);var ee=D(X),L=new z(X.name,J/u,$/u,ee,void 0,void 0,X.idx);v.instances[X.uniqueName]=L,this._updateHighlightFaceranges(X,L),ee&&(W=!0),v.optimalCount+=Z,x+=Z}M(v.optimalCount===f);var te=new Float32Array(v.buffer.getArray().buffer,0,v.buffer.getSize());v.vao.vertexBuffers.geometry.setData(te),(W||v.displayedIndexRange)&&(a[this._modifiedMergedFacerangesKey(o,l)]=v)}else M(0===f),v.vao.dispose(!0),v.vao=null,delete _.origin2data[l],0===Object.keys(_.origin2data).length&&(r.push(o),delete this._mat2dataMerged[o],this._orderedRendering&&this._removeFromRenderOrder(_,"merged"))}}},e.prototype._modifyInstanced=function(e,t,r){var a=this._compMat2delta(e,t,!0),s=this._rctx;for(var o in a){var d=a[o];for(var l in d){var h=d[l];if(0!==h.optimalCount){var f=h.material,p=this._mat2dataInstanced[o];if(null==p){var m=f.getRenderPriority();p={origin2data:{}},p[g.MATERIAL]=this._materialRep.aquire(f),p[g.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(f),p[g.MATERIAL_NORMAL]=this._materialRep.aquireNormal(f),p[g.MATERIAL_DEPTH]=this._materialRep.aquireDepth(f),p[g.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(f),this._mat2dataInstanced[o]=p,this._orderedRendering&&this._insertIntoRenderOrder(p,m,"instanced")}var u=f.getVertexBufferLayout(),_=p[g.MATERIAL].instanced?f.getInstanceBufferLayout():void 0,c=_&&R.findAttribute(_,"instanceColor"),v=_&&R.findAttribute(_,"instanceFeatureAttribute"),x=R.getStride(u)/4,b=p.origin2data[l];null==b&&(b={instances:{},vao:new y(s,H.Default3D,{geometry:u},{geometry:I.createVertex(s,35044)}),buffer:new i(h.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:h.origin},p.origin2data[l]=b);var A=b.buffer.getSize(),C=b.buffer.getArray(),T=h.optimalCount<h.sparseCount/2,O=b.buffer.resize(T?h.optimalCount:h.sparseCount);for(var P in h.perGeometryDelta){var E=b.perGeometryDataInfo[P];if(E&&E.instanceBufferData){var L=h.perGeometryDelta[P].removeCount;L>0&&E.instanceBufferData.prepareFree(L)}}var N=h.toRemove;if(T||O){for(var V=0;V<N.length;++V){var G=N[V];delete b.instances[G.uniqueName];var P=G.data.id,E=b.perGeometryDataInfo[P],F=E;0===--F.refCount&&null==h.dataId2refCount[P]?(b.optimalCount-=(F.to-F.from)*x,delete b.perGeometryDataInfo[P]):E.instanceBufferData&&E.instanceBufferData.free(G.idx)}A=0;var U=b.buffer.getArray(),q={};for(var k in b.perGeometryDataInfo){var F=b.perGeometryDataInfo[k];M(null==q[F.from]),q[F.from]=F}for(var Q in q){var F=q[Q],K=F.from*x,W=F.to*x;U.set(C.subarray(K,W),A),F.from=A/x,A+=W-K,F.to=A/x}for(var X in b.instances){var Y=b.instances[X];Y.from=b.perGeometryDataInfo[Y.dataId].from,Y.to=b.perGeometryDataInfo[Y.dataId].to}}else for(var V=0;V<N.length;++V){var G=N[V];delete b.instances[G.uniqueName];var P=G.data.id,E=b.perGeometryDataInfo[P];if(0===--E.refCount&&null==h.dataId2refCount[P]){var K=E.from*x,W=E.to*x;b.buffer.erase(K,W),b.optimalCount-=W-K,delete b.perGeometryDataInfo[P]}else E.instanceBufferData&&E.instanceBufferData.free(G.idx)}w(j,-h.origin[0],-h.origin[1],-h.origin[2]);for(var P in h.perGeometryDelta){var E=b.perGeometryDataInfo[P];if(E&&E.instanceBufferData){var J=h.perGeometryDelta[P].addCount;J>0&&E.instanceBufferData.prepareAllocate(J)}}for(var Z=h.toAdd,V=0;V<Z.length;++V){var G=Z[V],$=G.data,P=$.id,E=b.perGeometryDataInfo[P];if(null==E){f.fillInterleaved($,void 0,void 0,void 0,b.buffer.getArray(),A);var ee=f.getOutputAmount(S($.faces.indices).length),K=A/x;A+=ee;var W=A/x;if(b.optimalCount+=ee,E={refCount:1,from:K,to:W,vao:null,instanceBufferData:null},_){var te=R.getStride(_)/4;E.vao=new y(s,H.Default3D,{geometry:u,instance:_},{geometry:b.vao.vertexBuffers.geometry,instance:I.createVertex(s,35044)}),E.instanceBufferData=new n(te,h.perGeometryDelta[P].addCount)}b.perGeometryDataInfo[P]=E}else++E.refCount;M(E.from*x<=b.buffer.getSize()&&E.to*x<=b.buffer.getSize());var re=B.create();B.multiply(j,G.transformation,re);var ae=D(G),Y=new z(G.name,E.from,E.to,ae,re,G.instanceParameters,G.idx,P);b.instances[G.uniqueName]=Y,this._updateHighlightFaceranges(G,Y);var ie=E.instanceBufferData;if(ie){var ne=ie.allocate(G.idx);ie.fill(ne,0,Y.transformation),ie.fill(ne,16,Y.transformationNormal),c&&ie.fill(ne,c.offset/4,G.instanceParameters.color),v&&ie.fill(ne,v.offset/4,G.instanceParameters.featureAttribute)}}M(b.optimalCount===h.optimalCount);var se=new Float32Array(b.buffer.getArray().buffer,0,b.buffer.getSize());b.vao.vertexBuffers.geometry.setData(se);for(var P in b.perGeometryDataInfo){var oe=b.perGeometryDataInfo[P];if(oe.vao){var de=oe.vao.vertexBuffers.instance;if(de){var le=h.perGeometryDelta[P];if(le.addCount+le.removeCount>0){var he=oe.instanceBufferData.compact();de.setData(he)}}}}}else{var ge=this._mat2dataInstanced[o];ge.origin2data[l].vao.dispose(!0),delete ge.origin2data[l],0===Object.keys(ge.origin2data).length&&(r.push(o),delete this._mat2dataInstanced[o],this._orderedRendering&&this._removeFromRenderOrder(ge,"instanced"))}}}},e.prototype._compMat2delta=function(e,t,r){var a={};return this._updateMat2delta(e,!0,r,a),this._updateMat2delta(t,!1,r,a),a},e.prototype._updateMat2delta=function(e,t,r,a){for(var i=0;i<e.length;++i){var n=e[i],s=n.origin,o=n.material,d=o.getId(),l=r?this._mat2dataInstanced[d]:this._mat2dataMerged[d],h=l&&l.origin2data[s.id],g=a[d];
null==g&&(g={},a[d]=g);var f=g[s.id];if(null==f){if(f={optimalCount:null==h?0:h.optimalCount,sparseCount:null==h?0:h.buffer.getSize(),material:o,toAdd:[],toRemove:[],perGeometryDelta:null,origin:s.vec3},r){var p={};if(void 0!==h)for(var m in h.perGeometryDataInfo)p[m]=h.perGeometryDataInfo[m].refCount;f.dataId2refCount=p,f.perGeometryDelta={}}g[s.id]=f}var u=o.getOutputAmount(S(n.data.faces.indices).length);if(r){var _=n.data.id,c=f.perGeometryDelta[_];c||(c={addCount:0,removeCount:0},f.perGeometryDelta[_]=c),t?(c.addCount++,null==f.dataId2refCount[_]&&(f.dataId2refCount[_]=0),1===++f.dataId2refCount[_]&&(f.optimalCount+=u,f.sparseCount+=u),f.toAdd.push(n)):(c.removeCount++,0===--f.dataId2refCount[_]&&(delete f.dataId2refCount[_],f.optimalCount-=u),f.toRemove.push(n))}else t?(f.optimalCount+=u,f.sparseCount+=u,f.toAdd.push(n)):(f.optimalCount-=u,f.toRemove.push(n))}},e.prototype._modifiedMergedFacerangesKey=function(e,t){return e+"_"+t},e.prototype._insertIntoRenderOrder=function(e,t,r){for(var a=e[g.MATERIAL].getMaterialId(),i=this._renderOrder.length,n=0;i>n&&this._renderOrder[n][0]>=t;){var s=this._renderOrder[n][1];if(s.id===a)return M(!s[r],"matData for type already exists"),void(s[r]=e);n++}var o={id:a,instanced:null,merged:null};o[r]=e,this._renderOrder.splice(n,0,[t,o])},e.prototype._removeFromRenderOrder=function(e,t){for(var r=e[g.MATERIAL].getMaterialId(),a=0;this._renderOrder[a][1].id!==r;)a++;var i=this._renderOrder[a][1];i[t]=null,i.instanced||i.merged||this._renderOrder.splice(a,1)},e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(e,t){var r=e.matData[g.MATERIAL].getRenderPriority(),a=t.matData[g.MATERIAL].getRenderPriority();return r>a?-1:a>r?1:0})},e.prototype._updateRenderOrder=function(e,t){for(var r=t.length,a=0;r>a&&t[a][1].id!==e;)a++;if(r>a){var i=t[a][1],n=i.merged||i.instanced,s=n[g.MATERIAL].getRenderPriority(),o=t[a][0];if(s!==t[a][0]){t[a][0]=s;var d=s>o?-1:1;for(a+=d;a>-1&&r>a&&d*t[a][0]>d*s;){var l=t[a];t[a]=t[a-d],t[a-d]=l,a+=d}}}},e.prototype._modifyMaterials=function(e){for(var t in e)this._materialRep.updateMaterialParameters(t)},e.prototype.modifyRenderOrder=function(e){if(this._orderedRendering){for(var t in e)this._updateRenderOrder(t,this._renderOrder);this._sortHighlightsByRenderOrder(),this._needsRender=!0}},e.prototype._releaseMaterials=function(e){if(Array.isArray(e))for(var t=e,r=0;r<t.length;r++)this._materialRep.release(t[r]),this._materialRep.releaseDepthShadowMap(t[r]),this._materialRep.releaseNormal(t[r]),this._materialRep.releaseDepth(t[r]),this._materialRep.releaseHighlight(t[r]);else this._materialRep.release(e),this._materialRep.releaseDepthShadowMap(e),this._materialRep.releaseNormal(e),this._materialRep.releaseDepth(e),this._materialRep.releaseHighlight(e)},e.prototype._getInstance=function(e,t){var r=e.material,a=r.getId(),i=e.origin.id,n=t?this._mat2dataInstanced:this._mat2dataMerged,s=n[a];if(!s)return null;var o=s.origin2data[i];if(!o)return null;var d=o.instances[e.uniqueName];if(!d)return null;var l=t?"instanced":"merged";return{uniqueName:e.uniqueName,instance:d,matData:s,originData:o,type:l,instancedVAO:null,instancedVAOBaseInstance:null}},e.prototype._createBaseInstanceVAO=function(e){var t=this._rctx,r=e.instance;if("instanced"===e.type&&e.originData.perGeometryDataInfo){var a=e.originData.perGeometryDataInfo[r.dataId],i=a.instanceBufferData;if(i){var n=a.vao,s=i.getSlot(r.idx);if(e.instancedVAOBaseInstance!==s){var o=R.setBaseInstanceOffset(n.layout,s);e.instancedVAO=new y(t,n.locations,o,n.vertexBuffers,n.indexBuffer),e.instancedVAOBaseInstance=s}}}},e.prototype._updateHighlightVAOs=function(){for(var e=0;e<this._highlights.length;++e){var t=this._highlights[e];this._createBaseInstanceVAO(t)}},e.prototype._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new x(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))),this._fallbackDepthStencilTexture},e}(),q=function(){function e(){this.reset()}return e.prototype.reset=function(){this.trianglesRendered=0,this.drawCallsInstanced=0,this.drawCallsAngleInstanced=0,this.drawCallsMerged=0,this.drawCallsFragmented=0,this.drawCallsHighlight=0,this.instancesDrawnAngle=0,this.VBOallocatedSize=0,this.VBOoptimalSize=0,this.VBOusedSize=0},e}(),z=function(){function e(e,t,r,a,i,n,s,o){this.name=e,this.from=t,this.to=r,this.displayedIndexRange=a,this.transformation=i,this.instanceParameters=n,this.idx=s,this.dataId=o,null!=i&&(this.transformationNormal=B.create(),B.set(i,this.transformationNormal),B.inverse(this.transformationNormal,this.transformationNormal),B.transpose(this.transformationNormal,this.transformationNormal))}return e}(),k=E.create(),j=B.identity(),Q=B.create(),K=B.create();return U});