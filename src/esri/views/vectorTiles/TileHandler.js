// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","module","dojo/Deferred","dojo/promise/all","dojo/has","../../core/workers","../../core/promiseUtils","../../core/requireUtils","../../core/LRUCache","../../request","../2d/tiling/TileKey","./TileIndex","./SpriteMosaic","./SpriteSource","./GlyphMosaic","./GlyphSource","./VectorTileDisplayObject","./GeometryUtils"],function(e,t,i,o,n,r,s,a,l,c,u,h,p,d,y,_,f,g,v){var b=new c(10),m=function(){function t(e,t,i,o,n){void 0===o&&(o=!1),this.devicePixelRatio=i,this.allowUpdates=o,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._tileIndex=null,this._updateQueue=new Map,this._ongoingRequests=new Map,this._vectorTileLayer=e,this._styleRepository=e.styleRepository,this._requestUpdate=t,this._tileInfoView=n}return t.prototype.destroy=function(){this.stop(),this._vectorTileLayer=this._requestUpdate=this._styleRepository=null,this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null)},Object.defineProperty(t.prototype,"initialized",{get:function(){return this._broadcastPromise&&this._broadcastPromise.isFulfilled()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"spriteMosaic",{get:function(){return this._spriteMosaic},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ongoingRequestCount",{get:function(){return this._ongoingRequests.size},enumerable:!0,configurable:!0}),t.prototype.start=function(){var t=this;this.stop();var a=this._styleRepository,c=new y(a.sprite,this.devicePixelRatio);c.devicePixelRatio=this.devicePixelRatio;var u=c.load().then(function(){t._spriteMosaic=new d(1024,1024,250),t._spriteMosaic.setSpriteSource(c),r("stable-symbol-rendering")&&t._spriteMosaic.preloadSpriteItems()}),h=new f(a.glyphs);this._glyphMosaic=new _(1024,1024,h);var p=this._fetchTileMap(this._vectorTileLayer.tileIndexUrl),g=s.open(this,l.getAbsMid("./WorkerTileHandler",e,i)).then(function(e){t._connection=e}),v=new o(function(e){u.isFulfilled()||u.cancel(),p.isFulfilled()||p.cancel(),g.isFulfilled()||g.cancel()});return n([u,p,g]).then(function(e){n(t._connection.broadcast("setLayers",a.styleJSON)).then(function(){v.resolve()})}),this._broadcastPromise=v.promise,this._broadcastPromise},t.prototype.stop=function(){this._broadcastPromise&&!this._broadcastPromise.isFulfilled()&&this._broadcastPromise.cancel(),this._updateQueue.forEach(function(e){return e.cancel()}),this._ongoingRequests.forEach(function(e){return e.cancel()}),this._connection&&(this._connection.close(),this._connection=null)},t.prototype.updateTile=function(e,t){var i=this;if(!this.allowUpdates)return a.resolve(null);if(!this._broadcastPromise.isFulfilled()||!this._connection)return a.reject(new Error("no connection"));var o=Math.round(v.degToByte(t.state.rotation));if(e.rotation===o)return a.resolve(null);var n,r=e.key;return this._updateQueue.has(r.id)&&(n=this._updateQueue.get(r.id),n.cancel("cancel")),e.rotation=o,n=this._connection.invoke("update",{key:e.id,rotation:o},[],{id:e.workerID}).then(function(t){return e.updateSymbolData(t),t}).always(function(){i._updateQueue["delete"](r.id)}),this._updateQueue.set(e.id,n),n},t.prototype.getVectorTileWithLRC=function(e,t,i,o){var n=this;void 0===o&&(o=0);var r=new h(e,t,i,0),s=this.getRefKey(r),a=new g(r,s,this._vectorTileLayer.tileInfo,this._styleRepository,this._glyphMosaic,0);return this.getTileData(a.key,0).then(function(e){return a.setData(e.tileData,e.workerId,n._connection),a})},t.prototype.getTileData=function(e,t){var i=this;if(!this._broadcastPromise.isFulfilled()||!this._connection)return a.reject(new Error("no connection"));var o=this._tileIndex?this._tileIndex.dataKey(e):e;if(!o)return a.reject(new Error("no data"));var n=Math.round(v.degToByte(t));return this._getTileData(this._connection,e,o,n).then(function(e){return e&&e.tileData?{tileData:e.tileData,workerId:e.workerId,connection:i._connection}:a.reject("No data")})},t.prototype.getRefKey=function(e){return this._tileIndex?this._tileIndex.dataKey(e):e},t.prototype.fetchTileData=function(e){var t=h.pool.acquire(e),i=this._vectorTileLayer.getTileUrl(t.level,t.row,t.col);return h.pool.release(t),u(i,{callbackParamName:"callback",responseType:"array-buffer"}).then(function(e){return{data:{protobuff:e.data},buffers:[e.data]}})},t.prototype.getSprites=function(e){return a.resolve({data:{spriteItems:this._spriteMosaic.getSpriteItems(e.sprites)}})},t.prototype.getGlyphs=function(e){return this._glyphMosaic.getGlyphItems(e.tileID,e.font,e.codePoints).then(function(e){return{data:{glyphItems:e}}})},t.prototype.getStyleRepository=function(){return this._styleRepository},t.prototype.getTileIndex=function(){return this._tileIndex},t.prototype._getTileData=function(e,t,i,o){var n=this,r={id:null},s=this._ongoingRequests.get(t.id);return s?s:(s=this._connection.invoke("getTile",{key:t.id,refKey:i.id,rotation:o,cacheTile:this.allowUpdates},[],r).then(function(e){return n._ongoingRequests["delete"](t.id),{tileData:e,workerId:r.id}}).otherwise(function(e){return n._ongoingRequests["delete"](t.id),n._connection.invoke("destructTileData",{key:t.id},[],r),a.reject(e)}),this._ongoingRequests.set(t.id,s),s)},t.prototype._fetchTileMap=function(e){var t=this;return e?b.has(e)?(this._tileIndex=b.use(e),a.resolve()):u(e,{callbackParamName:"callback",responseType:"json"}).then(function(i){t._tileIndex=new p(i.data),b.insert(e,t._tileIndex)}):null},t}();return m});