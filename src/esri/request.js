// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","dojo/_base/config","dojo/Deferred","dojo/_base/lang","dojo/_base/url","dojo/request","dojo/io-query","dojo/when","./kernel","./config","./core/global","./core/sniff","./core/lang","./core/urlUtils","./core/deferredUtils","./core/promiseUtils","dojo/has!host-browser?dojo/io/script","dojo/has!host-webworker?./core/workers/request"],function(e,r,n,t,o,s,i,a,l,u,d,c,f,g,h,p,w,v){function b(e){var r=i.objectToQuery(e.content);if(r&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+r),e.url.length>2e3)return p.reject(t.mixin(new Error,{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));var o=new Image;e.allowImageDataAccess&&(e.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous");var s=!1,a=new n(function(e){s=!0,o.onload=o.onerror=o.onabort=null,o.src=""}),l=function(e){o.onload=o.onerror=o.onabort=null,s||a.reject(e)};return o.onload=function(){o.onload=o.onerror=o.onabort=null,s||a.resolve(this)},o.onerror=l,o.onabort=l,o.alt="",o.src=e.url,a.promise}function m(e){return e=new o(e),(e.host+(e.port?":"+e.port:"")).toLowerCase()}function _(e,o){var a=!!e.useProxy,u=e.method||"auto",d=f.isDefined(e.crossOrigin)?e.crossOrigin:A.useCors;e=t.mixin({},e),e._ssl&&(e.url=e.url.replace(/^http:/i,"https:"));var h=e.content,p=e.url;e.load=function(e){var n;return e&&(e.error?(n=t.mixin(new Error,e.error),n.log=!!r.isDebug):"error"===e.status&&(n=t.mixin(new Error,e),n.log=!!r.isDebug),n&&!f.isDefined(n.httpCode)&&(n.httpCode=n.code)),n||e},e.error=function(e,n){return n&&n.xhr&&n.xhr.abort(),e instanceof Error||(e=t.mixin(new Error,e)),e.log=!!r.isDebug,e},e._token&&(e.content=e.content||{},e.content.token=e._token);var v,m=0;p&&(v=i.objectToQuery(h),m=v.length+p.length+1,c("esri-url-encodes-apostrophe")&&(m=v.replace(/'/g,"%27").length+p.length+1)),e.timeout=f.isDefined(e.timeout)?e.timeout:A.timeout,e.handleAs=e.handleAs||"json";try{var _,k,C=d&&g.canUseXhr(e.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(e.url),y=g.hasSameOrigin(e.urlObj,g.appUrl)||C,D="post"===u||!!e.body||m>A.maxUrlLength,O=!y&&-1!==e.handleAs.indexOf("json")&&e.callbackParamName&&!e.body,x=!!g.getProxyRule(e.url)||A.forceProxy||a||("image"!==e.handleAs||e.allowImageDataAccess)&&(!O||D)&&!y;if((c("host-browser")||c("host-webworker"))&&x)if(_=g.getProxyUrl(p,d),k=_.path,_._xo&&(C=!0),!D&&k.length+1+m>A.maxUrlLength&&(D=!0),e.url=k+"?"+p,D)e.content=t.mixin(_.query||{},h);else{var q=i.objectToQuery(t.mixin(_.query||{},h));q&&(e.url+=(-1===p.indexOf("?")?"?":"&")+q),e.content=null}if((c("host-browser")||c("host-webworker"))&&O&&!D)return!f.isDefined(e.isAsync)&&c("ff")<4&&(e.isAsync=!0),w.get(j?j(e):e);var T=e.headers;if(!c("host-browser")&&!c("host-webworker")||T&&T.hasOwnProperty("X-Requested-With")||(T=e.headers=T||{},T["X-Requested-With"]=null),c("host-browser")&&o){var U=e.content&&e.content.token;U&&o.set("token",U),e.contentType=!1}if(C&&!e.hasOwnProperty("withCredentials")&&"with-credentials"===A.useCors){var E=x?k:p,L=g.getCorsConfig(E);if(L&&L.hasOwnProperty("withCredentials"))L.withCredentials&&(e.withCredentials=!0);else if(l.id){var P=l.id.findServerInfo(E);P&&P.webTierAuth&&(e.withCredentials=!0)}}return e=j?j(e):e,"image"===e.handleAs?b(e):D?(e.body?(e.data=o||e.body,e.query=e.content):e.data=e.content,delete e.body,delete e.content,!x&&c("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+S++),s.post(e.url,e)):(e.query=e.content,delete e.content,s.get(e.url,e))}catch(R){var W=new n;return W.reject(e.error(R)),W}}function k(e){var r=A.corsStatus,n=g.getCorsConfig(e,!0);return n>-1&&A.corsEnabledServers.splice(n,1),r[m(e)]=1,n}function C(e){var r=A.corsStatus;try{var t=m(e.url);if(A.corsDetection&&A.useCors&&c("esri-cors")&&e.url&&-1!==e.url.toLowerCase().indexOf("/rest/services")&&!g.hasSameOrigin(e.urlObj,g.appUrl)&&!g.canUseXhr(e.urlObj)){if(r[t])return r[t];var o=new n;r[t]=o.promise;var i=e.url.substring(0,e.url.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info";return s.get(i,{query:{f:"json"},handleAs:"json",headers:{"X-Requested-With":null},timeout:1e3*A.corsDetectionTimeout}).then(function(r){r?(g.canUseXhr(e.url)||A.corsEnabledServers.push(t),o.resolve()):o.reject()},function(e){o.reject()}),o.promise}}catch(a){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}function y(e){j=e}function D(o,i,a,u){function d(e){if(e._pendingDfd=_(a,C),!e._pendingDfd){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs;var o=new Error("Deferred object is missing");return o.log=!!r.isDebug,e.reject(o),void(e._pendingDfd=null)}var s=!!e._pendingDfd.response,i=e._pendingDfd.response||e._pendingDfd;i.then(function(e){if(!s||!e.data)return e;var r=e.getHeader("Content-Type");if(r&&(r=r.toLowerCase(),-1===r.indexOf("text/plain")&&-1===r.indexOf("application/json")))return e;var o,i=750,a=e.data;if(a instanceof ArrayBuffer&&a.byteLength<=i)o=new Blob([a]);else{if(!(a instanceof Blob&&a.size<=i))return e;o=a}var l=new n,u=new FileReader;return u.readAsText(o),u.onloadend=function(){if(!u.error)try{var r=JSON.parse(u.result);r.error&&(Object.isExtensible(e)||(e=t.mixin({},e)),e._jsonData=r)}catch(n){}l.resolve(e)},l.promise}).then(function(n){var o=s?n.data:n,i=s?n.getHeader.bind(n):T,a=null;if(e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,o){var l=s&&n._jsonData||o;if(l.error?(a=t.mixin(new Error,l.error),a.log=!!r.isDebug):"error"===l.status&&(a=t.mixin(new Error,l),a.log=!!r.isDebug),a&&!f.isDefined(a.httpCode)&&(a.httpCode=a.code),a)throw a}e.resolve({data:o,url:u.url,requestOptions:u.requestOptions,getHeader:i}),e._pendingDfd=null}).otherwise(function(r){var n,t,o;if(r&&(n=r.code,t=r.subcode,o=r.messageCode,o=o&&o.toUpperCase()),r&&403==n&&(4==t||r.message&&r.message.toLowerCase().indexOf("ssl")>-1&&-1===r.message.toLowerCase().indexOf("permission"))){if(!a._ssl)return a._ssl=a._sslFromServer=!0,void D(e,!0,a,u)}else if(r&&415==r.status){if(k(a.url),!a._err415)return a._err415=1,void D(e,!0,a,u)}else if(l.id&&l.id._errorCodes&&-1!==l.id._errorCodes.indexOf(n)&&!l.id._isPublic(a.url)&&!p&&(403!=n||q&&-1===q.indexOf(o)&&(!f.isDefined(t)||2==t&&a._token)))return void O(e,a,u,r);e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,e.reject(r),e._pendingDfd=null})}var h=a.body,p=a.disableIdentityLookup,w=a._preLookup,v=!1;if(c("esri-workers")&&A.useWorkers!==!1)if(a.useWorkers===!0||A.useWorkers===!0)v=!0;else if(a.workerOptions){var b=a.workerOptions;(b.callback||b.worker&&b.worker.worker instanceof Worker)&&(v=!0)}var C=null,y=h instanceof FormData;(y||h&&h.elements)&&(C=y?h:new FormData(h));var x=!!(-1!==a.url.toLowerCase().indexOf("token=")||a.content&&a.content.token||C&&C.get("token"));if(!i){o.then(function(e){if((/\/sharing\/rest\/accounts\/self/i.test(a.url)||/\/sharing\/rest\/portals\/self/i.test(a.url))&&!x&&!a._token&&e.user&&e.user.username){var r=A.corsEnabledServers,n=g.getCorsConfig(a.url,!0),t={host:m(a.url),withCredentials:!0};if(-1===n)r.push(t);else{var o=r[n];"object"==typeof o?o.withCredentials=!0:r.splice(n,1,t)}}var s=a._credential;if(s){var i,u=l.id.findServerInfo(s.server),d=u&&u.owningSystemUrl;d&&(d=d.replace(/\/?$/,"/sharing"),i=l.id.findCredential(d,s.userId),i&&-1===l.id._getIdenticalSvcIdx(d,i)&&i.resources.splice(0,0,d))}return e}).always(function(e){delete a._credential,e&&(e.ssl=!!a._ssl)});var j=a.load,S=a.error;j&&o.then(function(e){var r=o._pendingDfd,n=r&&r.ioArgs,t=n&&n.args;return j.call(t,e,n)}),S&&o.then(null,function(e){var r=o._pendingDfd,n=r&&r.ioArgs,t=n&&n.args;return S.call(t,e,n)})}if(l.id&&!x&&!a._token&&!l.id._isPublic(a.url)&&(!p||w)){var U=l.id.findCredential(a.url);U&&(a._token=U.token,a._ssl=U.ssl)}return v?a.workerOptions&&a.workerOptions.worker?(s=a.workerOptions.worker,d(o)):e(["./workers/RequestClient"],function(e){if(a.workerOptions){var r=a.workerOptions;s=e.getClient(r.callback,r.cbFunction)}else s=e.getClient();d(o)}):d(o),o.promise}function O(e,r,n,t){e._pendingDfd=l.id.getCredential(r.url,{token:r._token,error:t}),e._pendingDfd.then(function(t){r._token=t.token,r._credential=t,r._ssl=r._sslFromServer||t.ssl,D(e,!0,r,n)}).otherwise(function(r){e.reject(r),e._pendingDfd=null})}function x(e,r){if(v&&d.invokeStaticMessage)return v.execute(e,r);"string"!=typeof e&&console.error("esri/request: the first parameter should be a url string");var n=t.mixin({},r),s={url:e,requestOptions:t.mixin({},r)};if(n.content=n.query,delete n.query,n.preventCache=!!n.cacheBust,delete n.cacheBust,n.handleAs=n.responseType,delete n.responseType,"array-buffer"===n.handleAs&&(n.handleAs="arraybuffer"),"image"===n.handleAs){if(c("host-webworker")||c("host-node"))return p.reject(t.mixin(new Error,{message:"The responseType 'image' is not supported in Web Workers or Node environment."}));n.preventCache&&(n.content=n.content||{},n.content["request.preventCache"]=Date.now()),n.method="auto"}n.url=g.normalize(e),n.urlObj=new o(n.url);var i=h.makeDeferredCancellingPending();return a(C(n)).always(function(){D(i,!1,n,s)}),i.promise}var j,A=u.request,q=["COM_0056","COM_0057"],S=0,T=function(){return null};return x._makeRequest=_,x._processRequest=D,x._disableCors=k,x._detectCors=C,x.setRequestPreCallback=y,x});