// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","dojo/_base/kernel","dojo/_base/lang","dojo/Deferred","../../kernel","../../config","../../request","../Logger","../urlUtils","./WorkerFallbackImpl"],function(e,t,o,r,n,i,s,a,c,d,l){function u(){if(!k){var e=void 0;try{e=new Worker(m)}catch(t){p.warn("Failed to create Worker. Fallback to execute module in main thread",event),e=new l}return f(e)}return w||(w=a(m,{responseType:"text"})),w.then(function(e){return new Worker(URL.createObjectURL(new Blob([e.data],{type:"text/javascript"})))}).otherwise(function(e){return p.warn("Failed to create Worker. Fallback to execute module in main thread",e),new l}).then(function(e){return f(e)})}function f(e){function t(n){if(n&&n.data&&n.data.type){var i=n.data.type;"<worker-loaded>"===i?g(e):"<worker-configured>"===i&&(e.removeEventListener("message",t),e.removeEventListener("error",o),r.resolve(e))}}function o(r){r.preventDefault(),e.removeEventListener("message",t),e.removeEventListener("error",o),p.warn("Failed to create Worker. Fallback to execute module in main thread",r),e=new l,e.addEventListener("message",t),e.addEventListener("error",o)}var r=new n;return e.addEventListener("message",t),e.addEventListener("error",o),r.promise}function g(e){var t;if(null!=s["default"]){var n=r.mixin({},s);delete n["default"],t=JSON.parse(JSON.stringify(n))}else t=JSON.parse(JSON.stringify(s));var i={async:!0,baseUrl:v,locale:o.locale,has:{},paths:{}};r.mixin(i,s.workers.loaderConfig),i.has=r.mixin({"esri-cors":1,"dojo-test-sniff":0,"config-deferredInstrumentation":0,"host-webworker":1},i.has),i.paths=r.mixin({esri:"../esri",dojo:"../dojo",dojox:"../dojox",dstore:"../dstore",moment:"../moment"},i.paths),e.postMessage({type:"<configure>",configure:{esriConfig:t,dojoConfig:i,loaderUrl:h}})}var p=c.getLogger("esri.core.workers"),m=d.normalize(e.toUrl("./worker.js")),h=d.makeAbsolute(e.toUrl("dojo/dojo.js")),v=d.makeAbsolute("../",h)+"/",k=!d.hasSameOrigin(m,location.href),w=null,b=function(){function e(e,t,o){var r=this;this.connections=e,this.index=t,this.workerInitCallback=o,this.msgCount=0,this.outgoingJobs={},this.incomingJobs={},this.incomingStaticJobs={},u().then(function(e){r.worker=e,r.worker.addEventListener("message",r.message.bind(r)),r.worker.addEventListener("error",function(e){e.preventDefault(),p.error(e)}),r.workerInitCallback(r.index)})}return e.prototype.terminate=function(){this.worker.terminate()},e.prototype.openConnection=function(e,t){return this.invoke("<open-connection>",{path:e},void 0,t)},e.prototype.closeConnection=function(e){this.invoke("<close-connection>",void 0,void 0,e)},e.prototype.invoke=function(e,t,o,r){var i=this,s=++this.msgCount,a=new n(function(e){i.worker.postMessage({type:"<cancel>",id:s,connection:r,data:{reason:e}}),i.outgoingJobs[s]&&delete i.outgoingJobs[s]});return this.outgoingJobs[s]=a,this.worker.postMessage({type:e,id:s,connection:r,data:t},o),a.promise},e.prototype.message=function(e){var t=this;if(e&&e.data){var o=e.data.type;if(o){var r=e.data,n=e.data.id;if("<response>"===o&&n){var s=this.outgoingJobs[n];if(!s)return;delete this.outgoingJobs[n],r.error?s.reject(r.error):s.resolve(r.data)}else if("<cancel>"===o&&n){var a=this.incomingJobs[n];if(a&&a.cancel(r.data.reason),r.staticMsg){var c=this.incomingStaticJobs[n];c&&c.cancel(r.data.reason)}}else if("<static-message>"===o){var d=r.staticMsg,l=i.workerMessages[d];if(!l||"function"!=typeof l)return void this.worker.postMessage({type:"<static-message>",staticMsg:d,id:n,error:d+" message type is not available on the kernel!"});var u=l.call(this,r.data);this.incomingStaticJobs[n]=u,u.then(function(e){t.worker.postMessage({type:"<static-message>",staticMsg:d,id:n,data:e.data},e.buffers)}).otherwise(function(e){e||(e="Error encountered at method"+d),e.dojoType&&"cancel"===e.dojoType||t.worker.postMessage({type:"<static-message>",staticMsg:d,id:n,error:e})}).always(function(){delete t.incomingStaticJobs[n]})}else{var f=r.connection,g=this.connections[f];if(!g)return;var p=g.client;if(!p)return;var m=p[o];if("function"==typeof m){var h=m.call(p,r.data);this.incomingJobs[n]=h,h.then(function(e){t.worker.postMessage({type:"<response>",id:n,connection:f,error:e.error,data:e.data},e.buffers)}).otherwise(function(e){e||(e="Error encountered at method"+o),e.dojoType&&"cancel"===e.dojoType||t.worker.postMessage({type:"<response>",id:n,connection:f,error:e})}).always(function(){delete t.incomingJobs[n]})}}}}},e}();return b});