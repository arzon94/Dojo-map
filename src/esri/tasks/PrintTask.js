// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["../core/kebabDictionary","../core/urlUtils","../geometry/Polygon","dojo/_base/lang","dojo/dom-construct","dojox/gfx/canvas","./Geoprocessor","./support/PrintTemplate","./support/printTaskUtils","./Task"],function(e,t,a,r,i,n,s,o,l,u){function y(e){return!(!e||!e.path)}var c={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},p=e({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),d=e({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape","A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape","A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"}),m=u.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},_vtlExtent:null,_legendLayers:[],_legendLayerNameMap:{},properties:{_geoprocessor:{dependsOn:["url","updateDelay"],get:function(){return new s(this.url,{updateDelay:this.updateDelay})}},mode:{value:"sync"},url:{value:null,type:String},updateDelay:{value:1e3,type:Number}},execute:function(e,t){var a=this._setPrintParams(e),r="async"===this.mode?"submitJob":"execute";return this._geoprocessor[r](a,t).then(this._handleExecuteResponse)},_createOperationalLayers:function(e,a){var i,n,s,o,l=e.map,u=[],y=l.allLayers.items;for(i=0;i<y.length;i++)if(n=y[i],n.loaded&&n.visible)switch(o={id:n.id,title:this._legendLayerNameMap[n.id]||n.title,opacity:n.opacity,minScale:n.minScale||0,maxScale:n.maxScale||0,url:n.url&&t.normalize(n.url),token:n.token},s=n.declaredClass){case"esri.layers.ImageryLayer":var c={bandIds:n.bandIds,compressionQuality:n.compressionQuality,format:n.format,interpolation:n.interpolation};n.mosaicRule&&(c.mosaicRule=n.mosaicRule.toJSON()),n.renderingRule&&(c.renderingRule=n.renderingRule.toJSON()),u.push(r.mixin(o,c)),this._legendLayers&&this._legendLayers.push({id:n.id});break;case"esri.layers.OpenStreetMapLayer":r.mixin(o,{type:"OpenStreetMap"}),u.push(o);break;case"esri.layers.GraphicsLayer":r.mixin(o,this._createFeatureCollectionJSON(n)),u.push(o),this._legendLayers&&this._legendLayers.push({id:n.id});break;case"esri.layers.VectorTileLayer":o.type="image",o.url&&delete o.url;var p=a.exportOptions&&a.exportOptions.dpi||96,d=a.exportOptions&&a.exportOptions.width%2===e.width%2,m=a.exportOptions&&a.exportOptions.height%2===e.height%2,f={format:"png",pixelRatio:p/96,rotation:0},h=this._vtlExtent||e.extent.clone();if("MAP_ONLY"===a.layout&&a.preserveScale&&(!a.outScale||a.outScale===e.scale)&&96===p&&(!d||!m)&&(f.area={x:0,y:0,width:e.width,height:e.height},d||(f.area.width+=1),m||(f.area.height+=1),!this._vtlExtent)){var g=e.toMap({x:f.area.width,y:f.area.height});h.ymin=g.y,h.xmax=g.x,this._vtlExtent=h}o.extent=h.clone()._normalize(!0).toJSON();var b=e.whenLayerView(n);b.isResolved()&&b.then(function(t){var a=t.takeScreenshot(f,e);a.isResolved()?a.then(function(e){"data:image/png;base64,"===e.dataURL.substr(0,22)&&(o.imageData=e.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise"),o.imageData&&u.push(o)});break;case"esri.layers.MapImageLayer":var v={id:n.id,subLayerIds:[]},S=[],x=e.scale,L=function(e){var t=0===x,a=0===e.minScale||x<=e.minScale,r=0===e.maxScale||x>=e.maxScale;if(e.visible&&(t||a&&r))if(e.sublayers)e.sublayers.forEach(L);else{var i=e.toExportImageJSON().drawingInfo,n=e.toJSON();n.layerDefinition.drawingInfo=i,S.unshift(n),v.subLayerIds.push(e.id)}};n.sublayers&&n.sublayers.forEach(L),r.mixin(o,{layers:S}),u.push(o),this._legendLayers.push(v);break;case"esri.layers.WMSLayer":var S=[],L=function(e){e.visible&&(e.sublayers?e.sublayers.forEach(L):e.name&&S.unshift(e.name))};n.sublayers&&n.sublayers.forEach(L),r.mixin(o,{type:"wms",transparentBackground:n.imageTransparency,visibleLayers:S,version:n.version}),u.push(o);break;case"esri.layers.WMTSLayer":var _=n.activeLayer;r.mixin(o,{type:"wmts",layer:_.id,style:_.styleId,format:_.imageFormat,tileMatrixSet:_.tileMatrixSetId}),u.push(o);break;case"esri.layers.WebTileLayer":var O=n.urlTemplate.replace(/\$\{/g,"{");r.mixin(o,{type:"WebTiledLayer",urlTemplate:O,credits:n.copyright}),n.subDomains&&n.subDomains.length>0&&(o.subDomains=n.subDomains),u.push(o);break;case"esri.layers.FeatureLayer":case"esri.layers.CSVLayer":case"esri.layers.StreamLayer":var w;e.whenLayerView(n).then(function(e){return e.queryGraphics&&e.queryGraphics()||e.featuresView.graphics}).then(function(e){w=e.map(function(e){return e.geometry.hasZ=!1,e})}),r.mixin(o,this._createFeatureCollectionJSON(n,w)),u.push(o),this._legendLayers&&this._legendLayers.push({id:n.id});break;case"esri.layers.MapNotesLayer":var D=[];n.featureCollections.map(function(e){var t=e.source.toArray(),a=this._createFeatureCollectionJSON(e,t).featureCollection;D=D.concat(a.layers)}.bind(this)),r.mixin(o,{featureCollection:{layers:D}}),u.push(o);break;default:u.push(o)}return u},_createFeatureCollectionJSON:function(e,t){var i=e,n=l.createPolygonLayer(),s=l.createPolylineLayer(),o=l.createPointLayer(),u=l.createMultipointLayer(),y=l.createPointLayer();if(y.layerDefinition.name="textLayer",delete y.layerDefinition.drawingInfo,"esri.layers.FeatureLayer"===i.declaredClass||"esri.layers.StreamLayer"===i.declaredClass?n.layerDefinition.name=s.layerDefinition.name=o.layerDefinition.name=u.layerDefinition.name=this._legendLayerNameMap[i.id]||i.get("arcgisProps.title")||i.title:"esri.layers.GraphicsLayer"===i.declaredClass&&(t=i.graphics.items),i.renderer&&!r.isFunction(i.get("renderer.field"))){var c=i.renderer.toJSON();n.layerDefinition.drawingInfo.renderer=c,s.layerDefinition.drawingInfo.renderer=c,o.layerDefinition.drawingInfo.renderer=c,u.layerDefinition.drawingInfo.renderer=c}else delete n.layerDefinition.drawingInfo,delete s.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo,delete u.layerDefinition.drawingInfo;var p=i.fields,d=i.renderer,m=[];d&&!r.isFunction(i.get("renderer.field"))&&("classBreaks"===d.type?(p||(p=[{name:d.field,type:"esriFieldTypeDouble"}],d.normalizationField&&p.push({name:d.normalizationField,type:"esriFieldTypeDouble"})),d.field&&m.push(d.field),d.normalizationField&&m.push(d.normalizationField)):"uniqueValue"===d.type&&(p||(p=[{name:d.field,type:"esriFieldTypeString"}],d.field2&&p.push({name:d.field2,type:"esriFieldTypeString"}),d.field3&&p.push({name:d.field3,type:"esriFieldTypeString"})),d.field&&m.push(d.field),d.field2&&m.push(d.field2),d.field3&&m.push(d.field3))),p&&(n.layerDefinition.fields=p,s.layerDefinition.fields=p,o.layerDefinition.fields=p,u.layerDefinition.fields=p);for(var f,h=t&&t.length,g=0;h>g;g++){var b=t[g]||t.getItemAt(g);if(b.visible!==!1&&b.geometry&&(f=b.toJSON(),f.hasOwnProperty("popupTemplate")&&delete f.popupTemplate,f.geometry&&f.geometry.z&&delete f.geometry.z,!f.symbol||!f.symbol.outline||"esriCLS"!==f.symbol.outline.type)){if(f.symbol&&f.symbol.outline&&f.symbol.outline.color&&f.symbol.outline.color[3]&&(f.symbol.outline.color[3]=255),i.renderer&&!f.symbol&&(r.isFunction(i.renderer.field)||i.renderer.compiledFunc||i.renderer.hasVisualVariables())){var d=i.renderer,v=d.getSymbol(b);if(!v)continue;f.symbol=v.toJSON(),d.hasVisualVariables()&&l.applyVisualVariables(f.symbol,{renderer:d,graphic:b,symbol:v})}if(f.symbol&&(f.symbol.angle||delete f.symbol.angle,f.symbol.path?f.symbol=this._convertSvgToPictureMarkerSymbolJson(f.symbol):f.symbol.text&&delete f.attributes),i.renderer&&"simple"===i.renderer.type)delete f.attributes;else if(m.length){var S={};m.forEach(function(e){f.attributes&&f.attributes.hasOwnProperty(e)&&(S[e]=f.attributes[e])}),f.attributes=S}"polygon"===b.geometry.type?n.featureSet.features.push(f):"polyline"===b.geometry.type?s.featureSet.features.push(f):"point"===b.geometry.type?f.symbol&&f.symbol.text?y.featureSet.features.push(f):o.featureSet.features.push(f):"multipoint"===b.geometry.type?u.featureSet.features.push(f):"extent"===b.geometry.type&&(f.geometry=a.fromExtent(b.geometry).toJSON(),n.featureSet.features.push(f))}}var x=[n,s,u,o,y].filter(function(e){return e.featureSet.features.length>0});return x.forEach(function(e){var t=e.featureSet.features.every(function(e){return e.symbol});t&&(e.featureSet.features.forEach(function(e){delete e.attributes}),delete e.layerDefinition.drawingInfo),e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(e.layerDefinition.drawingInfo.renderer)},this),{featureCollection:{layers:x}}},_convertSvgToPictureMarkerSymbolJson:function(e){this._canvasParent||(this._canvasParent=i.create("div"),this._canvasSurface=n.createSurface(this._canvasParent,200,200));var t=this._canvasSurface.createObject(n.Path,e.path).setFill(e.color).setStroke(e.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var a=this._canvasSurface.rawNode.getContext("2d"),r=t.getBoundingBox(),s=Math.ceil(r.width+r.x),o=Math.ceil(r.height+r.y),l=a.getImageData(r.x,r.y,s,o);a.canvas.width=s,a.canvas.height=o,a.putImageData(l,0,0);var u=a.canvas.toDataURL("image/png"),y=22;return{type:"esriPMS",imageData:u.substr(y),angle:-e.angle,contentType:"image/png",height:e.size?e.size:o-r.y,width:e.size?e.size:s-r.x,xoffset:e.xoffset,yoffset:e.yoffset}},_convertSvgRenderer:function(e){var t=e.type;if("simple"===t&&y(e.symbol))return void(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol));if("uniqueValue"===t||"classBreaks"===t){var a="uniqueValue"===t?"uniqueValueInfos":"classBreakInfos",r=e[a];y(e.defaultSymbol)&&(e.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(e.defaultSymbol)),r&&r.forEach(function(e){y(e)&&(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol))},this)}},_getPrintDefinition:function(e,t){var a=e.view,r=a.map,i=a.spatialReference,n={operationalLayers:this._createOperationalLayers(a,t)},s=this._vtlExtent||e.extent||a.extent;return i&&i.isWrappable&&(s=s.clone()._normalize(!0),i=s.spatialReference),n.mapOptions={extent:s&&s.toJSON(),spatialReference:i&&i.toJSON(),showAttribution:t.attributionVisible},this._vtlExtent=null,a.rotation&&(n.mapOptions.rotation=-a.rotation),t.preserveScale&&(n.mapOptions.scale=t.outScale||a.scale),r.timeExtent&&(n.mapOptions.time=[r.timeExtent.startTime.getTime(),r.timeExtent.endTime.getTime()]),n},_handleExecuteResponse:function(e){return"sync"===this.mode?e.results&&e.results[0]&&e.results[0].value:this._geoprocessor.getResultData(e.jobId,"Output_File").then(function(e){return e.value})},_setPrintParams:function(e){var t=e.template||new o;null==t.showLabels&&(t.showLabels=!0);var a,i=t.exportOptions;if(i){var n=i.dpi;a={dpi:n};var s=d.toJSON(t.layout);if("map_only"===s.toLowerCase()||""===s){var l=i.width,u=i.height;a.outputSize=[l,u]}}var y,m=t.layoutOptions;if(m){var f,h;"Miles"===m.scalebarUnit||"Kilometers"===m.scalebarUnit?(f="Kilometers",h="Miles"):("Meters"===m.scalebarUnit||"Feet"===m.scalebarUnit)&&(f="Meters",h="Feet"),y={titleText:m.titleText,authorText:m.authorText,copyrightText:m.copyrightText,customTextElements:m.customTextElements,scaleBarOptions:{metricUnit:p.toJSON(f),metricLabel:c[f],nonMetricUnit:p.toJSON(h),nonMetricLabel:c[h]}}}var g=null;m&&m.legendLayers&&(g=m.legendLayers.map(function(e){this._legendLayerNameMap[e.layerId]=e.title;var t={id:e.layerId};return e.subLayerIds&&(t.subLayerIds=e.subLayerIds),t},this));var b=this._getPrintDefinition(e,t);e.outSpatialReference&&(b.mapOptions.spatialReference=e.outSpatialReference.toJSON()),r.mixin(b,{exportOptions:a,layoutOptions:y}),r.mixin(b.layoutOptions,{legendOptions:{operationalLayers:null!=g?g:this._legendLayers}});var v=JSON.stringify(b),S={Web_Map_as_JSON:v,Format:t.format,Layout_Template:s};return e.extraParameters&&r.mixin(S,e.extraParameters),S}});return m});