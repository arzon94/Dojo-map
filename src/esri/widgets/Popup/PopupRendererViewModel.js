// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["../Widget","../../core/Accessor","../../core/Error","../../core/HandleRegistry","../../core/lang","../../core/urlUtils","../../core/promiseUtils","../../core/watchUtils","../../request","../../tasks/support/StatisticDefinition","../../tasks/support/Query","../../tasks/QueryTask","../../renderers/support/arcadeUtils","dojo/_base/lang","dojo/promise/all","dojo/i18n!dojo/cldr/nls/number","dojox/html/entities"],function(e,t,i,r,n,s,a,o,l,d,c,f,u,h,m,p,_){function y(t){return t&&t.isInstanceOf&&t.isInstanceOf(e)}function g(e){return e&&"function"==typeof e.postMixInProperties&&"function"==typeof e.buildRendering&&"function"==typeof e.postCreate&&"function"==typeof e.startup}var b={apostrophe:/\'/g,hrefAttributes:/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,exprField:/^\s*expression\//i,token:/(\{([^\{\r\n]+)\})/g},F={apostrophe:"&apos;",ltr:"&lrm;"},I="expression/",v="relationships/",P={attachments:"attachments",fields:"fields",media:"media",text:"text"},R={"short-date":"(datePattern: 'M/d/y', selector: 'date')","short-date-le":"(datePattern: 'd/M/y', selector: 'date')","long-month-day-year":"(datePattern: 'MMMM d, y', selector: 'date')","day-short-month-year":"(datePattern: 'd MMM y', selector: 'date')","long-date":"(datePattern: 'EEEE, MMMM d, y', selector: 'date')","short-date-short-time":"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-le-short-time":"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-short-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')","short-date-le-short-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')","short-date-long-time":"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-le-long-time":"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-long-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')","short-date-le-long-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')","long-month-year":"(datePattern: 'MMMM y', selector: 'date')","short-month-year":"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"};return t.createSubclass({declaredClass:"esri.widgets.Popup.PopupRendererViewModel",properties:{content:{readOnly:!0},contentEnabled:!0,contentTypes:{readOnly:!0},formattedAttributes:{readOnly:!0},graphic:{},title:{readOnly:!0},waitingForContent:{readOnly:!0}},constructor:function(){this._handles=new r},initialize:function(){this._handles.add([o.init(this,"graphic",function(e){this._updateGraphic(e,this.contentEnabled)}.bind(this)),o.init(this,"contentEnabled",function(e){this._updateGraphic(this.graphic,e)}.bind(this))])},destroy:function(){this._handles.destroy(),this._handles=null,this._clearRelatedInfo(),this._cancelPromises(),this.graphic=null,this._set("title",null),this._set("content",null),this._set("waitingForContent",null)},content:null,contentEnabled:!0,contentTypes:P,formattedAttributes:null,graphic:null,title:"",waitingForContent:!1,_handles:null,_contentPromise:null,_contentElementPromises:null,_relatedRecordsPromise:null,_relatedRecordsQueryPromises:[],_relatedRecordsLayerPromises:[],_relatedLayersInfo:null,_relatedInfo:null,_dateFormats:R,_addValuesToHref:function(e,t,i,r){return t=this._trimString(t),n.substitute((t?0!==t.indexOf("${"):1)?r:i,e)},_cancelPromises:function(){this._contentElementPromises&&(this._contentElementPromises.forEach(function(e){e.cancel()},this),this._contentElementPromises=null),this._contentPromise&&(this._contentPromise.cancel(),this._contentPromise=null),this._relatedRecordsQueryPromises.forEach(function(e){e.cancel()}),this._relatedRecordsQueryPromises.length=0,this._relatedRecordsLayerPromises.length&&(this._relatedRecordsLayerPromises.forEach(function(e){e.cancel()}),this._relatedRecordsLayerPromises.length=0),this._relatedRecordsPromise&&(this._relatedRecordsPromise.cancel(),this._relatedRecordsPromise=null)},_clearRelatedInfo:function(){this._relatedLayersInfo=null,this._relatedInfo=null},_compileContent:function(e,t){var r=e.content;if(r&&(r.nodeName||r&&g(r)||y(r)))return r;if("string"==typeof r)return this._compileText(e,{type:P.text,text:r}).text;if(Array.isArray(r))return r.map(function(i,r){var n=t&&t[r],s=n&&n.value;switch(i.type){case P.attachments:return this._proxyAttachments(i,s);case P.fields:return this._compileFields(e,i);case P.media:return this._compileMedia(e,i);case P.text:return this._compileText(e,i)}},this);if(r)try{throw new i(this.declaredClass+"::invalid content type.")}catch(n){console.warn(n.stack)}},_compileFields:function(e,t){var i=h.clone(t),r=e.template,n=r&&r.expressionInfos,s=r&&h.clone(r.fieldInfos),a=i.fieldInfos||s,o=[];return a.forEach(function(e){var t=e.fieldName.toLowerCase(),i=e.hasOwnProperty("visible")?e.visible:!0;if(i){var r=this._isExpressionField(t)?this._getExpressionInfo(n,t):null;e.label=r?r.title:e.label,o.push(e)}},this),i.fieldInfos=o,i},_compileMedia:function(e,t){var i,r,s=h.clone(t),a=s.mediaInfos,o=e.attributes,l=e.layer,d=this.formattedAttributes.global,c=e.substOptions;return a&&(i=[],a.forEach(function(t){r=0;var s=t.value;switch(t.type){case"image":var a=s.sourceURL;a=a&&this._trimString(n.substitute(o,this._fixTokens(a,l))),r=!!a;break;case"pie-chart":case"line-chart":case"column-chart":case"bar-chart":var f,u=s.normalizeField;s.fields=s.fields.map(function(e){return f=this._getLayerFieldInfo(l,e),f?f.name:e},this),u&&(f=this._getLayerFieldInfo(l,u),s.normalizeField=f?f.name:u),r=s.fields.some(function(e){return n.isDefined(o[e])||-1!==e.indexOf(v)&&this._relatedInfo},this);break;default:return}if(r){t=h.clone(t),s=t.value;var m=t.title?this._processFieldsInLinks(this._fixTokens(t.title,l),o):"",p=t.caption?this._processFieldsInLinks(this._fixTokens(t.caption,l),o):"";if(t.title=m?this._trimString(n.substitute(d,m,c)):"",t.caption=p?this._trimString(n.substitute(d,p,c)):"","image"===t.type)s.sourceURL=n.substitute(o,this._fixTokens(s.sourceURL,l)),s.linkURL&&(s.linkURL=this._trimString(n.substitute(o,this._fixTokens(s.linkURL,l))));else{var _,y=e.template,g=y&&y.fieldInfos;s.fields.forEach(function(e,t){if(-1!==e.indexOf(v)){var i=this._getRelatedChartInfos(l,g,e,s,o,c);Array.isArray(i)?s.fields=i:s.fields[t]=i}else{var r=o[e];r=void 0===r?null:r,_=o[s.normalizeField]||0,r&&_&&(r/=_);var n=g&&this._getFieldInfo(g,e);s.fields[t]={y:r,tooltip:(n&&n.label||e)+":"+this._formatValue(r,{fieldInfos:g,fieldName:e,layer:l,substOptions:c,preventPlacesFormatting:!!_})}}},this)}i.push(t)}},this)),s.mediaInfos=i,s},_compileText:function(e,t){var i=h.clone(t);if(i&&i.text){var r=e.layer,s=e.attributes,a=this.formattedAttributes.global,o=e.substOptions,l=this._processFieldsInLinks(this._fixTokens(i.text,r),s);i.text=this._trimString(n.substitute(a,l,o))}return i},_compileTitle:function(e){var t="",i=e.title,r=e.layer,s=e.attributes,a=e.substOptions,o=this.formattedAttributes.global;if(i&&("function"==typeof i&&(i=i.call(null,{graphic:e.graphic})),"string"==typeof i)){var l=-1!==i.indexOf("{"+v);if(!l){var d=this._processFieldsInLinks(this._fixTokens(i,r),s);t=this._trimString(n.substitute(o,d,a))}}return t},_getExpressionInfo:function(e,t){if(this._isExpressionField(t)){t=t.replace(b.exprField,""),t=t.toLowerCase();var i;return e.some(function(e){return e.name.toLowerCase()===t&&(i=e),!!i}),i}},_createGraphicInfo:function(e,t){var i=e.getEffectivePopupTemplate(),r=i&&i.title,n=i&&i.content,s=e.layer,a=s&&s._getDateOpts&&s._getDateOpts().properties,o=h.clone(e.attributes)||{},l={dateFormat:{properties:a,formatter:"DateFormat"+R["short-date-short-time"]}};return{graphic:e,template:i,title:r,content:n,contentEnabled:t,layer:s,attributes:o,properties:a,substOptions:l}},_fixTokens:function(e,t){return e.replace(b.token,function(e,i,r){var n=this._getLayerFieldInfo(t,r);return n?"{"+n.name+"}":i}.bind(this))},_encodeAttributes:function(e){var t=h.clone(e)||{};return Object.keys(t).forEach(function(e){var i=t[e];if("string"==typeof i){var r=encodeURIComponent(i).replace(b.apostrophe,F.apostrophe);t[e]=r}}),t},_formatAttributesToFieldInfos:function(e,t,i,r,n){e.forEach(function(s){var a=s.fieldName,o=this._getLayerFieldInfo(t,a);o&&(a=s.fieldName=o.name);var l=n[a];if(n[a]=this._formatValue(l,{fieldInfos:e,fieldName:a,layer:t,substOptions:i}),r&&s.format&&s.format.dateFormat){var d=r.indexOf(a);d>-1&&r.splice(d,1)}},this)},_formatAttributes:function(e,t,i,r,s,a,o,l){var d=h.clone(s);if(o&&o.forEach(function(e){var t=I+e.name,i=l[e.name],r=u.executeFunction(i&&i.compiledFunc,u.createExecContext(a));"string"==typeof r&&(r=_.encode(r)),d[t]=r}),this._relatedInfo&&Object.keys(this._relatedInfo).forEach(function(e){var t=this._relatedInfo[e],i=this._relatedLayersInfo[e];t&&(t.relatedFeatures.forEach(this._relatedFeaturesAttributes.bind(this,i,s,d)),t.relatedStatsFeatures.forEach(this._relatedStatsAttributes.bind(this,i,s,d)))},this),e&&this._formatAttributesToFieldInfos(e,t,i,r,d),t){var c=t.typeIdField;Object.keys(s).forEach(function(e){if(-1===e.indexOf(v)){var i=s[e];if(n.isDefined(i)){var r=this._getDomainName(t,a,e,i);if(n.isDefined(r))d[e]=r;else if(e===c){var o=this._getTypeName(t,a,i);n.isDefined(o)&&(d[e]=o)}}}},this)}return d},_formatValue:function(e,t){var i=t.fieldInfos,r=t.fieldName,s=t.substOptions,a=i&&this._getFieldInfo(i,r),o=h.clone(a),l=t.preventPlacesFormatting,d=this._getLayerFieldInfo(t.layer,r);if(d&&"date"===d.type){var c=o.format||{};c.dateFormat=c.dateFormat||"short-date-short-time",o.format=c}var f=o&&o.format,u="number"==typeof e&&s.dateFormat.properties&&-1===s.dateFormat.properties.indexOf(r)&&(!f||!f.dateFormat);if(!n.isDefined(e)||!o||!n.isDefined(f))return u?this._forceLTR(e):e;var m="",_=[],y=f.hasOwnProperty("places")||f.hasOwnProperty("digitSeparator"),g=f.hasOwnProperty("digitSeparator")?f.digitSeparator:!0;if(y)m="NumberFormat",n.isDefined(f.places)&&(!l||f.places>0)&&(_.push("places: "+Number(f.places)),m+="("+_.join(",")+")");else{if(!f.dateFormat)return u?this._forceLTR(e):e;m="DateFormat"+R[f.dateFormat]||R["short-date-short-time"]}var b=n.substitute({myKey:e},"{myKey:"+m+"}",s)||"";return y&&!g&&p.group&&(b=b.replace(new RegExp("\\"+p.group,"g"),"")),u?this._forceLTR(b):b},_forceLTR:function(e){return F.ltr+e},_getDomainName:function(e,t,i,r){var n=e.getDomain&&e.getDomain(i,{feature:t});return n&&n.codedValues?n.getName(r):null},_getFieldInfo:function(e,t){for(var i,r=t.toLowerCase(),n=0;n<e.length;n++){var s=e[n];if(s.fieldName&&s.fieldName.toLowerCase()===r){i=s;break}}return i},_getLayerFieldInfo:function(e,t){return t&&e&&e.getField?e.getField(t):null},_getTypeName:function(e,t){var i=e.getType&&e.getType(t);return i&&i.name},_processFieldsInLinks:function(e,t){var i=this._encodeAttributes(t);return e&&(e=e.replace(b.hrefAttributes,function(e,r){return this._addValuesToHref(e,r,t,i)}.bind(this))),e},_proxyAttachments:function(e,t){var r=h.clone(e);if(t&&!(t instanceof i)&&t.attachmentInfos&&t.attachmentInfos.length){var n=t.attachmentInfos.map(function(e){return e.url=s.addProxy(e.url),e},this);r.attachmentInfos=n}return r},_queryAttachments:function(e){var t=e.layer;if(!t)return a.resolve();"scene"===t.type&&t.companionFeatureLayer&&(t=t.companionFeatureLayer);var i=e.attributes,r=t&&t.objectIdField,n=i&&r&&i[r];return r&&t.get("capabilities.data.supportsAttachment")&&n?this._queryAttachmentInfos(t,n):void 0},_queryAttachmentInfos:function(e,t){var i=e.url+"/"+e.layerId+"/"+t+"/attachments",r=e.token||"";return l(i,{query:{f:"json",token:r},callbackParamName:"callback"}).then(function(e){var n=e.data,s=n.attachmentInfos;return s.forEach(function(e){e.url=i+"/"+e.id,r&&(e.url+="?token="+r),e.objectId=t}),n})},_queryContentElements:function(e){var t=e.content;if(!Array.isArray(t))return a.resolve();var i=[],r={};return t.forEach(function(t,n){if(t.type===P.attachments){var s=this._queryAttachments(e);s&&(r[n]=s,i.push(s))}},this),this._contentElementPromises=i,0===i.length?a.resolve():a.eachAlways(r).always(function(e){return this._contentElementPromises=null,e}.bind(this))},_trimString:function(e){return(e||"").trim()},_getContent:function(e){var t=e.template,i=t&&t.content;return"function"==typeof i&&(i=i.call(null,{graphic:e.graphic})),i&&"function"==typeof i.then?i:a.resolve(i)},_updateContent:function(e){if(!e.contentEnabled)return a.resolve();var t=this._getContent(e).then(function(t){return e.content=t,this._queryContentElements(e)}.bind(this)).then(function(t){this._set("content",this._compileContent(e,t))}.bind(this)).otherwise(function(e){console.log(this.declaredClass+"::error loading template",e)}.bind(this)).then(function(){this._contentPromise=null}.bind(this));return this._contentPromise=t,t},_isExpressionField:function(e){return b.exprField.test(e)},_compileExpressions:function(e){if(e){var t={};return e.forEach(function(e){t[e.name]={compiledFunc:u.createFunction(e.expression)}}),t}},_createFormattedAttributes:function(e){var t=e.graphic,i=e.attributes,r=e.layer,n=e.template,s=n&&n.fieldInfos,a=n&&n.expressionInfos,o=this._compileExpressions(a),l=e.substOptions,d=e.properties,c={global:this._formatAttributes(s,r,l,d,i,t,a,o),content:[]},f=n&&n.content;return Array.isArray(f)&&f.forEach(function(e,n){e.type===P.fields&&e.fieldInfos&&(c.content[n]=this._formatAttributes(e.fieldInfos,r,l,d,i,t,a,o))},this),c},_queryGraphicInfo:function(e,t){var i=this._createGraphicInfo(e,t);return this._checkForRelatedRecords(i).then(function(){return this._set("formattedAttributes",this._createFormattedAttributes(i)),this._set("title",this._compileTitle(i)),this._updateContent(i)}.bind(this))},_updateGraphic:function(e,t){if(this._handles&&(this._clearRelatedInfo(),this._cancelPromises(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null),this._set("waitingForContent",!1),e)){this._set("waitingForContent",!0);var i=this._queryGraphicInfo(e,t).always(function(){this._relatedRecordsPromise=null,this._relatedRecordsLayerPromises.length=0,this._relatedRecordsQueryPromises.length=0,this._set("waitingForContent",!1)}.bind(this));this._relatedRecordsPromise=i}},_getAllFieldInfos:function(e){var t=[],i=e.template,r=i&&i.fieldInfos,n=e.contentEnabled;if(r&&(t=t.concat(r)),n){var s=i&&i.content;Array.isArray(s)&&s.forEach(function(e){var i=e&&e.fieldInfos;t=t.concat(i)},this)}return t},_checkForRelatedRecords:function(e){var t=this._getAllFieldInfos(e),i=t.filter(function(e){return e&&e.fieldName&&-1!==e.fieldName.indexOf(v)},this);return e.layer&&i&&i.length>0?this._getRelatedRecords({graphic:e.graphic,fieldsInfo:i}):a.resolve()},_relatedFeaturesAttributes:function(e,t,i,r){Object.keys(r.attributes).forEach(function(n){if("esriRelCardinalityOneToOne"===e.relation.cardinality){var s=this._toRelatedFieldName([e.relation.id,n]);t[s]=i[s]=r.attributes[n]}},this)},_relatedStatsAttributes:function(e,t,i,r){Object.keys(r.attributes).forEach(function(n){var s=this._toRelatedFieldName([e.relation.id,n]);t[s]=i[s]=r.attributes[n]},this)},_getRelatedChartInfos:function(e,t,i,r,n,s){var a,o,l,d,c,f,u,h;return a=[],h=this._fromRelatedFieldName(i),f=h[0],o=this._relatedInfo[f],u=this._relatedLayersInfo[f],o&&o.relatedFeatures.forEach(function(o){var l,f=o.attributes;Object.keys(f).forEach(function(o){if(o===h[1]){if(l={},c=f[o],r.normalizeField&&(d=-1!==r.normalizeField.indexOf(v)?f[this._fromRelatedFieldName(r.normalizeField)[1]]:n[r.normalizeField]),c&&d&&(c/=d),r.tooltipField)if(-1!==r.tooltipField.indexOf(v)){var u=this._fromRelatedFieldName(r.tooltipField)[1],m=f[u];l.tooltip=m+": "+this._formatValue(c,{fieldInfos:t,fieldName:m,layer:e,substOptions:s,preventPlacesFormatting:!!d})}else{var p=this._getLayerFieldInfo(e,i);p&&(i=p.name),l.tooltip=i+": "+this._formatValue(c,{fieldInfos:t,fieldName:r.tooltipField,layer:e,substOptions:s,preventPlacesFormatting:!!d})}else l.tooltip=c;l.y=c,a.push(l)}},this)},this),l="esriRelCardinalityOneToMany"===u.relation.cardinality||"esriRelCardinalityManyToMany"===u.relation.cardinality?a:a[0]},_getRelatedRecords:function(e){var t=e.graphic;return this._relatedLayersInfo?this._queryRelatedLayers(t).then(function(e){return this._setRelatedRecords(e),e}.bind(this)):this._getRelatedLayersInfo(e).then(function(e){return Object.keys(e).forEach(function(t){e[t]&&(this._relatedLayersInfo[t].relatedLayerInfo=e[t].data)},this),this._queryRelatedLayers(t).then(function(e){return this._setRelatedRecords(e),e}.bind(this))}.bind(this))},_getRelatedLayersInfo:function(e){var t,i=e.graphic,r=e.fieldsInfo,n={};return t=i.layer,this._relatedLayersInfo||(this._relatedLayersInfo={}),r.forEach(function(e){var i,r,n,s,a;if(i=this._fromRelatedFieldName(e.fieldName),r=i[0],n=i[1],r){if(!this._relatedLayersInfo[r]){var o=t&&t.relationships;o&&o.some(function(e){return e.id==r?(a=e,!0):void 0}),a&&(this._relatedLayersInfo[r]={relation:a,relatedFields:[],outStatistics:[]})}this._relatedLayersInfo[r]&&(this._relatedLayersInfo[r].relatedFields.push(n),e.statisticType&&(s=new d({statisticType:e.statisticType,onStatisticField:n,outStatisticFieldName:n}),this._relatedLayersInfo[r].outStatistics.push(s)))}},this),Object.keys(this._relatedLayersInfo).forEach(function(e){var i,r;this._relatedLayersInfo[e]&&(i=this._relatedLayersInfo[e].relation,r=t.url+"/"+i.relatedTableId,this._relatedLayersInfo[e].relatedLayerUrl=r,n[e]=l(r,{query:{f:"json"},callbackParamName:"callback"}))},this),Object.keys(n).forEach(function(e){this._relatedRecordsLayerPromises.push(n[e])},this),m(n)},_queryRelatedLayers:function(e){var t={};return Object.keys(this._relatedLayersInfo).forEach(function(i){t[i]=this._queryRelatedLayer({graphic:e,relatedInfo:this._relatedLayersInfo[i]})},this),m(t)},_queryRelatedLayer:function(e){var t,i,r,n,s,a,o,l,d,u,h,p,_,y;return t=e.graphic,i=t.layer,r=i.layerId,p=e.relatedInfo,n=p.relatedLayerInfo,_=p.relatedLayerUrl,y=p.relation,n&&n.relationships&&n.relationships.some(function(e){return e.relatedTableId===parseInt(r,10)?(s=e,!0):void 0}),s&&(n.fields.some(function(e){if(e.name===s.keyField){var t=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"];return a=-1!==t.indexOf(e.type)?"number":"string",!0}}),u="string"===a?s.keyField+"='"+t.attributes[y.keyField]+"'":s.keyField+"="+t.attributes[y.keyField],o=new c({where:u,outFields:p.relatedFields}),p.outStatistics&&p.outStatistics.length>0&&n.supportsStatistics&&(h=new c({where:o.where,outFields:o.outFields,outStatistics:p.outStatistics})),l=new f({url:_}),d=[l.execute(o)],h&&d.push(l.execute(h))),this._relatedRecordsQueryPromises=this._relatedRecordsQueryPromises.concat(d),m(d)},_setRelatedRecords:function(e){this._relatedInfo=[],Object.keys(e).forEach(function(t){if(e[t]){var i=e[t];this._relatedInfo[t]={relatedFeatures:i[0].features},n.isDefined(i[1])&&(this._relatedInfo[t].relatedStatsFeatures=i[1].features)}},this)},_fromRelatedFieldName:function(e){var t=-1!==e.indexOf(v);return t?e.split("/").slice(1):[]},_toRelatedFieldName:function(e){return e&&e.length>0?v+e[0]+"/"+e[1]:""}})});