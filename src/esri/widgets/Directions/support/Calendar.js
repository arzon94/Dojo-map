// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../support/widget","../../../core/accessorSupport/decorators","../../Widget","../../../../moment/moment","./CalendarViewModel","dojo/keys","dojo/i18n!../nls/Calendar"],function(e,t,a,r,i,o,s,n,d,l,c){var _={base:"esri-calendar esri-widget",datePicker:"esri-calendar__date-picker",monthPicker:"esri-calendar__month-picker",dayPicker:"esri-calendar__day-picker",week:"esri-calendar__week-item",nearbyMonth:"esri-calendar__day-item--nearby-month",activeDay:"esri-calendar__day-item--active",today:"esri-calendar__day-item--today",selectedDay:"esri-calendar__day-item--selected",day:"esri-calendar__day-item",dayHeader:"esri-calendar__day-item--header",yearPicker:"esri-calendar__year-picker",selectedYear:"esri-calendar__year-picker-item--selected",year:"esri-calendar__year-picker-item",monthDropdown:"esri-calendar__month-dropdown",date:"esri-calendar__date",datePickerToggle:"esri-calendar__date-picker-toggle",openIcon:"esri-icon-down-arrow",closeIcon:"esri-icon-up-arrow",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",button:"esri-widget-button"},h="L",y="YYYY-MM-DD",p=[l.DOWN_ARROW,l.END,l.ENTER,l.HOME,l.LEFT_ARROW,l.PAGE_DOWN,l.PAGE_UP,l.RIGHT_ARROW,l.SPACE,l.UP_ARROW],u=function(e){function t(t){var a=e.call(this)||this;return a._activeDate=null,a._isOpen=!1,a._closedByUserAction=!1,a.value=null,a.viewModel=new d,a}return a(t,e),t.prototype.render=function(){var e=this.viewModel.value.format(h),t=this._isOpen,a=(r={},r[_.openIcon]=!t,r[_.closeIcon]=t,r);return i.tsx("div",{"class":_.base},i.tsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-pressed":t.toString(),bind:this,"class":i.join(_.button,_.datePickerToggle),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},i.tsx("span",{"class":_.date},e),i.tsx("span",{"aria-hidden":"true",classes:a})),t?this._renderCalendarOptions():null);var r},t.prototype._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},t.prototype._handleDatePickerKeydown=function(e){var t=e.keyCode;t===l.ESCAPE&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},t.prototype._renderCalendarOptions=function(){var e=this._activeDate,t=this.get("viewModel.value");return i.tsx("div",{bind:this,"class":_.datePicker,key:"esri-calendar__date-picker",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},t.prototype._renderMonthPicker=function(e){var t=n.months().map(function(t,a){var r=e.month()===a;return i.tsx("option",{selected:r},t)});return i.tsx("div",{"class":_.monthPicker},i.tsx("div",{"aria-label":c.goToPreviousMonth,bind:this,"class":_.button,onclick:this._setPreviousMonth,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:c.goToPreviousMonth},i.tsx("span",{"aria-hidden":"true","class":_.previousIcon})),i.tsx("select",{"aria-live":"assertive",bind:this,"class":_.monthDropdown,id:this.id+"__month-picker",onchange:this._setMonth,onkeydown:this._setMonth},t),i.tsx("div",{"aria-label":c.goToNextMonth,bind:this,"class":_.button,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:c.goToNextMonth},i.tsx("span",{"aria-hidden":"true","class":_.nextIcon})))},t.prototype._renderDayPicker=function(e,t){var a=e.clone().day(n.localeData().firstDayOfWeek()),r=this._getWeekLabels(a),o=this._getDayId(e),s=this._renderCalendarMonth(e,t);return i.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":o,"aria-labelledby":this.id+"__month-picker "+this.id+"__selected-year",bind:this,"class":_.dayPicker,id:this.id+"__day-picker",onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},i.tsx("div",{"class":_.week,role:"row"},r.map(function(e){return i.tsx("div",{"aria-label":e.name,"class":i.join(_.day,_.dayHeader),role:"columnheader",title:e.name},e.abbr)})),s)},t.prototype._getDayId=function(e){return this.id+"__"+e.format(y)},t.prototype._handleDayPickerCreate=function(e){e.focus()},t.prototype._getWeekLabels=function(e){for(var t=[],a="dddd",r="dd",i=0;7>i;i++)t.push({name:e.format(a),abbr:e.format(r)}),e.add(1,"day");return t},t.prototype._handleDayPickerKeydown=function(e){var t=e.keyCode,a=e.ctrlKey,r=e.shiftKey,i=this._activeDate;if(-1!==p.indexOf(t)){if(t===l.LEFT_ARROW)i.subtract(1,"day");else if(t===l.RIGHT_ARROW)i.add(1,"day");else if(t===l.UP_ARROW)i.subtract(1,"week");else if(t===l.DOWN_ARROW)i.add(1,"week");else if(t===l.PAGE_UP){var o=r?"year":"month";i.subtract(1,o)}else if(t===l.PAGE_DOWN){var o=r?"year":"month";i.add(1,o)}else if(t===l.HOME){var o=a?"year":"month";i.startOf(o)}else if(t===l.END){var o=a?"year":"month";i.endOf(o)}else(t===l.ENTER||t===l.SPACE)&&(this.viewModel.value=i.clone(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},t.prototype._renderCalendarMonth=function(e,t){for(var a=n(),r=n.localeData(),o=e.clone().startOf("month"),s=e.clone().endOf("month"),d=o.clone().subtract(o.weekday()-r.firstDayOfWeek(),"day"),l=6,c=7,h=d,y=[],p=0;l>p;p++){for(var u=[],v=0;c>v;v++){var f=h.date(),k=h.isSame(e,"day"),b=h.isSame(t,"day"),m=this._getDayId(h),P=(g={},g[_.nearbyMonth]=!h.isBetween(o,s,null,"[]"),g[_.today]=h.isSame(a,"day"),g[_.activeDay]=k,g[_.selectedDay]=b,g);u.push(i.tsx("div",{"aria-label":f.toString(),"aria-selected":k.toString(),bind:this,"class":_.day,"data-iso-date":h.toISOString(),classes:P,id:m,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},f)),h.add(1,"day")}y.push(i.tsx("div",{"class":_.week,role:"row"},u))}return y;var g},t.prototype._renderYearPicker=function(e){var t="YYYY",a=e.clone(),r=a.format(t),o=a.add(1,"year").format(t),s=a.subtract(2,"year").format(t);return i.tsx("div",{"class":_.yearPicker},i.tsx("div",{"aria-label":c.goToPreviousYear,bind:this,"class":_.year,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:0,title:c.goToPreviousYear},s),i.tsx("div",{"class":i.join(_.year,_.selectedYear),id:this.id+"__selected-year"},r),i.tsx("div",{"aria-label":c.goToNextYear,bind:this,"class":_.year,onclick:this._setNextYear,onkeydown:this._setNextYear,tabIndex:0,title:c.goToNextYear},o))},t.prototype._toggle=function(){return this._isOpen?void this._close():void this._open(this.viewModel.value.clone())},t.prototype._setMonth=function(e){var t=e.target,a=t.item(t.selectedIndex).value;this._activeDate.month(a)},t.prototype._close=function(){this._activeDate=null,this._isOpen=!1},t.prototype._open=function(e){this._activeDate=e,this._isOpen=!0},t.prototype._setPreviousMonth=function(){this._activeDate.subtract(1,"month")},t.prototype._setNextMonth=function(){this._activeDate.add(1,"month")},t.prototype._setPreviousYear=function(){this._activeDate.subtract(1,"year")},t.prototype._setNextYear=function(){this._activeDate.add(1,"year")},t.prototype._handleSelectedDate=function(e){var t=e.target;this.viewModel.value=n(t.getAttribute("data-iso-date")),this._closedByUserAction=!0,this._close()},t}(o.declared(s));return r([o.aliasOf("viewModel.value")],u.prototype,"value",void 0),r([o.property({type:d}),i.renderable("viewModel.value")],u.prototype,"viewModel",void 0),r([i.accessibleHandler()],u.prototype,"_toggle",null),r([i.accessibleHandler()],u.prototype,"_setPreviousMonth",null),r([i.accessibleHandler()],u.prototype,"_setNextMonth",null),r([i.accessibleHandler()],u.prototype,"_setPreviousYear",null),r([i.accessibleHandler()],u.prototype,"_setNextYear",null),r([i.accessibleHandler()],u.prototype,"_handleSelectedDate",null),u=r([o.subclass("esri.widgets.Directions.support.Calendar")],u)});