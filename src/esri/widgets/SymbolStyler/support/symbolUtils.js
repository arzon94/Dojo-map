// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../../core/screenUtils","../../../symbols/support/Symbol3DOutline","../../../symbols/support/symbolLayerUtils","../../../core/promiseUtils","dojo/_base/lang","dojo/Deferred","dojo/dom-construct","dojo/on","dojo/i18n!../nls/SymbolStyler"],function(e,t,i,r,n,o,u,l,s,c,f){function a(e,t){e[t]||(e[t]={})}function d(e,t){return e.indexOf(t)>-1}function h(e){return k(e)}function m(e){return e&&"icon"===e.type}function p(e){return e&&"object"===e.type}function y(e){return e&&"line"===e.type}function b(e){return e&&"path"===e.type}function v(e){return e&&"extrude"===e.type}function g(e){return e&&"fill"===e.type}function w(e){return e&&"text"===e.type}function x(e){return D(e,"simple-line","2d")}function z(e){return D(e,"simple-marker","2d")}function S(e){return D(e,"simple-fill","2d")}function O(e){return D(e,"picture-marker","2d")}function j(e){return D(e,"fill","2d")}function k(e){return d(e.type,"3d")}function L(e){return e.symbolLayers.getItemAt(0)}function P(e,t){return D(e,"marker",t)||D(e,"point",t)}function C(e){return h(e)&&v(L(e))}function M(e){return h(e)&&w(L(e))}function D(e,t,i){var r=e&&e.type,n=d(r,t+"-symbol");return i?n&&("3d"===i?k(e):!k(e)):n}function F(e,t){return D(e,"line",t)}function U(e,t){return D(e,"fill",t)}function N(e){return e&&"string"==typeof e.style}function T(e){return h(e)?!1:N(e)&&d(Ne,e.style)}function A(e){return h(e)?I(e):_(e)}function I(e){var t=L(e);return g(t)&&t.outline||m(t)&&xe(t)?{color:t.outline.color,size:i.pt2px(t.outline.size)}:y(t)||b(t)?{color:t.material&&t.material.color,size:i.pt2px(t.size)}:null}function _(e){return x(e)?{color:e.color,size:e.width}:j(e)||z(e)?{color:e.get("outline.color"),size:e.get("outline.width")}:null}function q(e,t){!isNaN(t)&&e&&(h(e)?R(e,t):B(e,t))}function R(e,t){var r=L(e);m(r)||g(r)?(a(r,"outline"),r.outline.size=i.px2pt(t)):y(r)?(a(r,"size"),r.size=i.px2pt(t)):b(r)&&(a(r,"size"),r.size=t)}function B(e,t){x(e)?e.width=t:ae(e)&&(e.outline.width=t)}function E(e,t){t&&e&&!k(e)&&(t=A(e).color?t:"none",x(e)?e.style=t:ae(e)&&(e.outline.style=t))}function V(e,t){e&&!isNaN(t)&&(h(e)?W(e,t):H(e,t))}function W(e,t){var r=L(e);m(r)||w(r)?r.size=i.px2pt(t):p(r)?G(r,t):v(r)&&(r.size=t)}function G(e,t){var i=e.width,r=e.height,n=e.depth,o=Math.max(i,r,n),u=t/o;e.set({width:i*u,height:r*u,depth:n*u})}function H(e,t){var i=e.width,r=t;if(i!==r)if(O(e)){var n=e.url,o=ee({dimensions:e,targetDimension:"width",targetSize:r});if(e.height=o.height,e.width=o.width,!n||"http://"===n||!d(n,"http://")&&!d(n,"data:"))return;if(e.xoffset||e.yoffset){var u=e.width/i;e.xoffset=Math.round(e.xoffset*u),e.yoffset=Math.round(e.yoffset*u)}}else e.size=r}function J(e){if(!h(e))return z(e)?e.size:O(e)?K(e):void 0;var t=L(e);return m(t)||w(t)?i.pt2px(t.size):p(t)?K(t):v(t)?t.size:void 0}function K(e){return Math.max(e.width,e.height,e.depth)}function Q(e,t){h(e)?me(e,{color:t}):e.color=t}function X(e){return h(e)?Y(e):Z(e)}function Y(e){return L(e).get("material.color")}function Z(e){return e.color}function $(e,t){if(h(e)){var i=L(e);return y(i)||b(i)?void me(e,{color:t}):(a(i,"outline"),void(i.outline.color=t))}A(e).color=t}function ee(e){var t=e.dimensions,i="height"===e.targetDimension?"height":"width",r=e.targetSize;return"height"===i?{height:r,width:t.width/t.height*r}:{height:t.height/t.width*r,width:r}}function te(e){var t=new l,i=s.create("img"),r=c(i,"load",function(){return 0===i.width&&0===i.height?void t.reject("image has both width and height of 0"):void t.resolve({width:i.width,height:i.height})}),n=c(i,"error",function(e){t.reject("error ocurred while loading image",e)});return i.src=e,t.promise.always(function(){r.remove(),n.remove(),s.destroy(i)}),t.promise}function ie(e){h(e.symbol)?re(e):ne(e)}function re(e){V(e.symbol,e.size)}function ne(e){V(e.symbol,e.size)}function oe(e){h(e.symbol)?ue(e):le(e)}function ue(e){Q(e.symbol,e.color)}function le(e){Q(e.symbol,e.color)}function se(e){h(e.symbol)?ce(e):fe(e)}function ce(e){$(e.symbol,e.color),q(e.symbol,e.size)}function fe(e){$(e.symbol,e.color),E(e.symbol,e.pattern),q(e.symbol,e.size)}function ae(e){return e&&e.outline}function de(e){if(h(e))return!1;var t=void 0;return t=ae(e)?e.outline.color:e.color,he(t)}function he(e){return e&&e.r>246&&e.g>246&&e.b>246}function me(e,t){var i=L(e);return t.color?void(i.material=u.mixin({},i.material,t)):void(i.material=void 0)}function pe(e){S(e)&&"solid"!==e.style&&"none"!==e.style&&(e.style="solid")}function ye(e,t){return void 0===t&&(t=[]),h(e)?ge(e,t):ve(e,t)}function be(e){var t=["circle","square","diamond"];return d(t,e.style)}function ve(e,t){var i=e.type,r=["simple-marker-symbol","picture-marker-symbol"],n=["simple-marker-symbol","simple-fill-symbol"],o=["simple-marker-symbol","simple-line-symbol","simple-fill-symbol"],u=F(e),l=U(e);return{shape:{state:d(t,"shape")||u||l?"excluded":d(r,i)?"enabled":"disabled"},fill:{state:d(t,"fill")||u?"excluded":n[0]===i&&be(e)||n[1]===i?"enabled":"disabled"},outline:{state:d(t,"outline")?"excluded":d(o,i)?"enabled":"disabled"}}}function ge(e,t){var i=L(e),r=i.type,n=["icon","object"],o=["icon","object","fill","extrude","text"],u=["icon","fill","line","path"];return{shape:{state:d(t,"shape")||!d(n,r)?"excluded":"enabled"},fill:{state:d(t,"fill")||!d(o,r)?"excluded":we(i)?"disabled":"enabled"},outline:{state:d(t,"outline")||!d(u,r)?"excluded":!m(i)||xe(i)||we(i)?"enabled":"disabled"}}}function we(e){return m(e)&&d(Ne,e.get("resource.primitive"))}function xe(e){return m(e)?e.outline&&!e.get("resource.href"):!1}function ze(e){if(h(e)){var t=L(e).type;if("extrude"===t||"object"===t)return"meters"}return"pixels"}function Se(e){if(h(e)){var t=L(e).type;if("path"===t)return"meters"}return"pixels"}function Oe(e){if(h(e)){if(P(e)){var t=L(e);return p(t)?"web-style:volumetric":m(t)?"web-style:flat":"web-style"}return"web-style"}return"symbol-set"}function je(e){var t=L(e).type;return"object"===t||"path"===t||"extrude"===t?"volumetric":"flat"}function ke(e){if(h(e)){var t=L(e);if(m(t)&&(t.outline||(t.outline=new r.Symbol3DOutline({color:void 0,size:0})),void 0===t.size))return n.computeLayerSize(t).then(function(i){return t.size=i[0],e});if(p(t)&&void 0===t.width&&void 0===t.height&&void 0===t.depth)return n.computeLayerSize(t).then(function(i){return t.set({width:i[0],height:i[1],depth:i[2]}),e})}return o.resolve(e)}function Le(e,t){if(h(e)&&h(t)){var i=L(e),r=L(t);return m(i)&&p(r)&&!!i.resource.href&&!r.resource.href&&!!r.resource.primitive}return O(e)&&z(t)}function Pe(e,t){if(h(e)&&h(t)){var i=L(e),r=L(t);return m(i)&&m(r)&&!i.resource.href&&!r.resource.href&&!d(Ne,i.resource.primitive)&&d(Ne,r.resource.primitive)}return Me(e,t)}function Ce(e,t){return h(e)&&h(t)?Pe(t,e):Me(t,e)}function Me(e,t){return z(e)&&z(t)&&!T(e)&&T(t)}function De(e){if(!h(e))return"";var t=L(e);if(!m(t)&&!p(t))return"";if(e.styleOrigin)return e.styleOrigin.name;if(!Ue(t))return"";var i=t.get("resource.primitive");if(m(t))return f[i];if(p(t)){var r={sphere:f.sphere,cylinder:f.cylinder,"tall-cylinder":f.tallCylinder,cube:f.cube,"tall-cube":f.tallCube,cone:f.cone,"tall-cone":f.tallCone,"inverted-cone":f.invertedCone,diamond:f.diamond,tetrahedron:f.tetrahedron};return r[Fe(t)?"tall-"+i:i]}}function Fe(e){var t=e.depth,i=e.height,r=e.width;return r&&t&&i&&r===t&&i>r}function Ue(e){return!e.get("resource.href")&&!!e.get("resource.primitive")}Object.defineProperty(t,"__esModule",{value:!0});var Ne=["x","cross"];t.is3d=k,t.getSymbolLayer=L,t.isPoint=P,t.hasExtrudeSymbolLayer=C,t.hasTextSymbolLayer=M,t.isLine=F,t.isPolygon=U,t.hasPureOutlineStyle=T,t.getOutline=A,t.setOutlineWidth=q,t.setOutlineStyle=E,t.setSize=V,t.getMarkerLength=J,t.setFillColor=Q,t.getFillColor=X,t.setOutlineColor=$,t.preserveAspectRatio=ee,t.testImageUrl=te,t.updateShape=ie,t.updateFill=oe,t.updateOutline=se,t.blendsIntoBackground=de,t.updateMaterial=me,t.ensureSupportedSimpleFillSymbolStyle=pe,t.getApplicableTabs=ye,t.getSizeUnit=ze,t.getOutlineUnit=Se,t.getSymbolSource=Oe,t.getDimensionality=je,t.ensureProps=ke,t.switchedFromRasterToVectorSymbol=Le,t.switchedToPureOutline=Pe,t.switchedFromPureOutline=Ce,t.switchedSmsStyleToPureOutline=Me,t.getSymbolName=De});