// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/Accessor","../../core/Collection","../../core/Error","../../core/Evented","../../core/HandleRegistry","../../core/promiseUtils","../../core/watchUtils","../../styles/basic","./FeatureLayerSearchSource","./LocatorSearchSource","../../tasks/Locator","dojo/has","../../Graphic","../../geometry/Point","../../symbols/PictureMarkerSymbol","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/TextSymbol","../../PopupTemplate","../../geometry/SpatialReference","./support/geometryUtils","dojo/i18n!./nls/Search","../../core/accessorSupport/decorators"],function(e,t,r,o,s,i,n,u,a,l,c,p,h,g,d,m,y,v,f,S,_,w,x,b,I,R,T,P){function E(e){return e instanceof g||e instanceof h?e:e.featureLayer?new h(e):new g(e)}function A(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}var O=i.ofType(E),F=I.WGS84,G="../../images/search/search-symbol-32.svg",D="../../images/search/search-symbol-32.png",L=new g({locator:new d({url:"//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer"}),singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],name:T.esriLocatorName,localSearchOptions:{minScale:3e5,distance:5e4},placeholder:T.placeholder,resultSymbol:new f({url:e.toUrl(m("trident")?D:G),size:24,width:24,height:24})}),z=-1,C=function(e){function t(t){var r=e.call(this)||this;return r._suggestPromises=[],r._handles=new a,r._suggestDelayPromise=null,r._viewReadyPromise=null,r._viewAnimation=null,r._popupTemplate=new b({title:T.searchResult,content:"{Match_addr}"}),r.activeSource=null,r.activeSourceIndex=0,r.allPlaceholder=T.allPlaceholder,r.autoNavigate=!0,r.autoSelect=!0,r.defaultSource=L,r.locationToAddressDistance=1500,r.maxInputLength=128,r.maxResults=6,r.maxSuggestions=6,r.minSuggestCharacters=1,r.placeholder="",r.popupOpenOnSelect=!0,r.popupTemplate=null,r.popupEnabled=!0,r.resultGraphicEnabled=!0,r.resultGraphic=null,r.results=null,r.selectedSuggestion=null,r.searchAllEnabled=!0,r.selectedResult=null,r.sources=new O([L]),r.suggestionDelay=150,r.suggestions=null,r.suggestionsEnabled=!0,r.view=null,r.zoomScale=1e3,r}return r(t,e),t.prototype.initialize=function(){var e=this;this._handles.add([c.init(this,"activeSourceIndex",function(t){e._updateActiveSource(),e._setPlaceholder(t)}),c.init(this,"allPlaceholder",function(){e._setPlaceholder(e.activeSourceIndex)}),c.init(this,"sources",function(){e._setDefaultActiveSourceIndex(),e._setPlaceholder(e.activeSourceIndex)}),c.init(this,"searchAllEnabled",function(){return e._setDefaultActiveSourceIndex()})])},t.prototype.destroy=function(){this.clearGraphics(),this._viewReadyPromise&&this._viewReadyPromise.cancel(),this._handles.destroy(),this._handles=null},Object.defineProperty(t.prototype,"popup",{get:function(){return this.get("view.popup")||null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()},enumerable:!0,configurable:!0}),t.prototype.cancelSuggest=function(){this._cancelSuggestions();var e=this._suggestDelayPromise;e&&e.cancel()},t.prototype.clear=function(){this.searchTerm=""},t.prototype.clearGraphics=function(){this._closePopup(),this.view&&this.view.graphics.remove(this.resultGraphic),this._set("resultGraphic",null)},t.prototype.search=function(e){var t=this;this.emit("search-start"),this.cancelSuggest();var r=this._getLocationSearch(e),o=this._createSuggestionForSearch(e);return this._ready(this.view).then(function(){return t._getResultsFromSources(r,o).then(function(e){var r={activeSourceIndex:t.activeSourceIndex,searchTerm:o.text,numResults:0,numErrors:0,errors:[],results:[]};return t._formatEvent(r,e,o),t._set("searchTerm",o.text),o.key&&o.sourceIndex&&t._set("selectedSuggestion",o),t._set("results",r.results),t.emit("search-complete",r),t._selectFirstResult(r.results).then(function(){return r.results})})})},t.prototype.select=function(e){var t=this;if(this.cancelSuggest(),this.clearGraphics(),!e)return l.reject(new n("searchviewmodel:missing-parameter","searchResult is required."));var r=this.view,o=A(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),s=this.sources.getItemAt(o);if(!s)return l.reject(new n("searchviewmodel:missing-source","source not found for selection."));var i=s instanceof h?this._getSourcePopupTemplate(s):null,u=s.resultSymbol||this._getDefaultSymbol(e),a=A(s,"resultGraphicEnabled")?s.resultGraphicEnabled:this.resultGraphicEnabled,c=A(s,"autoNavigate")?s.autoNavigate:this.autoNavigate,p=A(s,"popupOpenOnSelect")?s.popupOpenOnSelect:this.popupOpenOnSelect,g=A(s,"popupEnabled")?s.popupEnabled:this.popupEnabled,d=i||this.popupTemplate||this._popupTemplate,m=e.feature,v=this.popup;if(!m)return l.reject(new n("searchviewmodel:missing-feature","The SearchResult must contain a feature for selection."));var f=R.getPointFromGeometry(m.geometry),S=this.view?R.getPointWithElevation(f,r):l.resolve(f);return S.then(function(i){u instanceof x&&(u.text=e.name);var n=new y({geometry:i,symbol:u,attributes:m.attributes,popupTemplate:g?d:null}),l=t._goToSearchResult(c,e.extent);return l.always(function(){return t._viewAnimation=null,a&&r&&r.graphics.push(n),v&&g&&p&&v.open({features:[n],location:i}),t._set("selectedResult",e),t._set("resultGraphic",n),t.emit("select-result",{result:e,source:s,sourceIndex:o}),e})})},t.prototype.suggest=function(e,t){var r=this;this.cancelSuggest();var o=e||this.searchTerm;return this.emit("suggest-start",{searchTerm:o}),this._suggestTimer(t).then(function(){return r._suggestImmediate(o).then(function(e){return r._set("suggestions",e.results),r.emit("suggest-complete",e),e.results})})},t.prototype._clear=function(){this._viewAnimation&&(this._viewAnimation.stop(),this._viewAnimation=null),this._set("results",null),this._set("suggestions",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")},t.prototype._closePopup=function(){var e=this.get("view.popup"),t=this.resultGraphic;if(e&&this.popupEnabled&&t){var r=e.selectedFeature,o=r&&r===t;o&&e.close()}},t.prototype._suggestTimer=function(e){var t=null!=e?e:this.suggestionDelay,r=l.after(t);return this._suggestDelayPromise=r,r},t.prototype._getLocationSearch=function(e){return e instanceof y?R.getPointFromGeometry(e.geometry):e instanceof v?e:Array.isArray(e)&&2===e.length?new v({longitude:e[0],latitude:e[1]}):void 0},t.prototype._createSuggestionForSearch=function(e){var t=e&&A(e,"key")&&A(e,"text")&&A(e,"sourceIndex");if(t)return e;var r="string"==typeof e?e:this.searchTerm,o=this,s=o.selectedSuggestion,i=o.selectedResult,n=s&&i&&s.text===i.name,u=n?s:{text:r,key:null,sourceIndex:null};return u},t.prototype._getFirstResult=function(e){var t=null;return e&&e.some(function(e){var r=e.results,o=r[0],s=!!o;return s&&(t=o),s}),t},t.prototype._selectFirstResult=function(e){if(!this.autoSelect||!e||!this.view)return l.resolve();var t=this._getFirstResult(e);return t?this.select(t):l.resolve()},t.prototype._suggestImmediate=function(e){var t=this;return this._ready(this.view).then(function(){return t._getSuggestionsFromSources(e)}).then(function(r){var o={activeSourceIndex:t.activeSourceIndex,searchTerm:e,numResults:0,numErrors:0,errors:[],results:[]};return t._formatEvent(o,r),o})},t.prototype._formatEventSource=function(e,t,r){var o=t&&t.value||[],s=t&&t.error,i=this.sources.getItemAt(r);if(s){var n={sourceIndex:r,source:i,error:s};e.errors.push(n),e.numErrors++}else{var u={sourceIndex:r,source:i,results:o};e.results.push(u),e.numResults+=o.length}},t.prototype._formatEvent=function(e,t,r){var o=this;if(t)if(e.activeSourceIndex===z){var s=r&&A(r,"sourceIndex")&&-1!==r.sourceIndex?r.sourceIndex:void 0;t.forEach(function(t,r){var i=void 0!==s?s:r;o._formatEventSource(e,t,i)})}else this._formatEventSource(e,t[0],e.activeSourceIndex)},t.prototype._getResultsFromSources=function(e,t){var r=this,o=!e&&A(t,"sourceIndex")?t.sourceIndex:this.activeSourceIndex,s=[];return o===z?this.sources.forEach(function(o,i){s.push(r._getResultsFromSource(e,t,i))}):s.push(this._getResultsFromSource(e,t,o)),l.eachAlways(s)},t.prototype._getSuggestionsFromSources=function(e){var t=this,r=this.activeSourceIndex,o=[];if(r===z)this.sources.forEach(function(r,s){var i=t._getSuggestionsFromSource(e,s);t._suggestPromises.push(i),o.push(i)});else{var s=this._getSuggestionsFromSource(e,r);this._suggestPromises.push(s),o.push(s)}return l.eachAlways(o)},t.prototype._getResultsFromSource=function(e,t,r){var o=this.sources.getItemAt(r),s=this.get("view.spatialReference")||F,i=A(o,"maxResults")?o.maxResults:this.maxResults,n=o instanceof h&&A(o,"exactMatch")?o.exactMatch:!1,u=A(o,"zoomScale")?o.zoomScale:this.zoomScale,a=o instanceof g&&A(o,"locationToAddressDistance")?o.locationToAddressDistance:this.locationToAddressDistance,l=this.view;return o.getResults({view:l,sourceIndex:r,location:e,suggestResult:t,spatialReference:s,exactMatch:n,maxResults:i,distance:a,zoomScale:u})},t.prototype._getSuggestionsFromSource=function(e,t){var r=this.sources.getItemAt(t),o=A(r,"suggestionsEnabled")?r.suggestionsEnabled:this.suggestionsEnabled,s=e.trim().length,i=A(r,"minSuggestCharacters")?r.minSuggestCharacters:this.minSuggestCharacters;if(o&&s>=i){var n=this.get("view.spatialReference")||F,u=A(r,"maxSuggestions")?r.maxSuggestions:this.maxSuggestions,a=this.view;return r.getSuggestions({view:a,sourceIndex:t,suggestTerm:e,spatialReference:n,maxSuggestions:u})}return l.resolve()},t.prototype.createDefaultSymbol=function(e,t){if("point"===t){var r=e;return new w({color:e.color,size:r.size,outline:{color:r.outline.color,width:r.outline.width}})}if("polyline"===t){var o=e;return new _({color:o.color,width:o.width})}if("polygon"===t){var s=e;return new S({color:s.color,outline:{color:s.outline.color,width:s.outline.width}})}},t.prototype._cancelSuggestions=function(){var e=this;this._suggestPromises.forEach(function(t){t.cancel(e.declaredClass+": cancelling request")}),this._suggestPromises.length=0},t.prototype._updateActiveSource=function(){var e=this.activeSourceIndex,t=this.sources.getItemAt(e)||null;this._set("activeSource",t)},t.prototype._getPlaceHolderText=function(e){var t=this.sources.getItemAt(e),r=this.allPlaceholder,o=void 0===r?T.allPlaceholder:r;return e===z?o:t?t.placeholder:""},t.prototype._setPlaceholder=function(e){this._set("placeholder",this._getPlaceHolderText(e))},t.prototype._setDefaultActiveSourceIndex=function(){var e=1===this.sources.length,t=e||!this.searchAllEnabled;this.activeSourceIndex=t?0:z},t.prototype._getSourcePopupTemplate=function(e){var t=e.featureLayer;return t?A(e,"popupTemplate")?e.popupTemplate:t.popupTemplate:void 0},t.prototype._getSourceIndexOfResult=function(e){var t=this.results,r=null;return t.some(function(t){var o=t.results;return o.some(function(o){return o===e?(r=t.sourceIndex,!0):void 0})}),r},t.prototype._goToSearchResult=function(e,t){var r=this.view,o=r&&e&&!!t,s={animate:o},i="3d"===r.type?r.goTo({target:t,tilt:0},s):r.goTo({target:t},s);return o&&(this._viewAnimation=i),i},t.prototype._ready=function(e){if(this._viewReadyPromise&&this._viewReadyPromise.cancel(),e){var t=e.always();return this._viewReadyPromise=t,t}return l.resolve()},t.prototype._getDefaultSymbol=function(e){var t=this.get("view.map.basemap.id"),r=e&&e.feature&&e.feature.geometry&&e.feature.geometry.type;if(r){var o=p.getSchemes({theme:"default",basemap:t||"topo",geometryType:r}),s=o&&o.primaryScheme;if(s)return s.color&&A(s,"opacity")&&(s.color.a=s.opacity),this.createDefaultSymbol(s,r)}return L.resultSymbol},t}(P.declared(s,u));return C.ALL_INDEX=z,o([P.property({readOnly:!0})],C.prototype,"activeSource",void 0),o([P.property()],C.prototype,"activeSourceIndex",void 0),o([P.property()],C.prototype,"allPlaceholder",void 0),o([P.property()],C.prototype,"autoNavigate",void 0),o([P.property()],C.prototype,"autoSelect",void 0),o([P.property({readOnly:!0})],C.prototype,"defaultSource",void 0),o([P.property()],C.prototype,"locationToAddressDistance",void 0),o([P.property()],C.prototype,"maxInputLength",void 0),o([P.property()],C.prototype,"maxResults",void 0),o([P.property()],C.prototype,"maxSuggestions",void 0),o([P.property()],C.prototype,"minSuggestCharacters",void 0),o([P.property({readOnly:!0})],C.prototype,"placeholder",void 0),o([P.property({dependsOn:["view.popup"],readOnly:!0})],C.prototype,"popup",null),o([P.property()],C.prototype,"popupOpenOnSelect",void 0),o([P.property()],C.prototype,"popupTemplate",void 0),o([P.property()],C.prototype,"popupEnabled",void 0),o([P.property()],C.prototype,"resultGraphicEnabled",void 0),o([P.property({readOnly:!0})],C.prototype,"resultGraphic",void 0),o([P.property({readOnly:!0})],C.prototype,"results",void 0),o([P.property({readOnly:!0})],C.prototype,"selectedSuggestion",void 0),o([P.property()],C.prototype,"searchAllEnabled",void 0),o([P.property({readOnly:!0})],C.prototype,"selectedResult",void 0),o([P.property()],C.prototype,"searchTerm",null),o([P.property({type:O})],C.prototype,"sources",void 0),o([P.property()],C.prototype,"suggestionDelay",void 0),o([P.property({readOnly:!0})],C.prototype,"suggestions",void 0),o([P.property()],C.prototype,"view",void 0),o([P.property()],C.prototype,"zoomScale",void 0),C=o([P.subclass("esri.widgets.Search.SearchViewModel")],C)});