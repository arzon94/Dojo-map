// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/Accessor","../../core/Collection","../../core/HandleRegistry","./support/ActiveLayerInfo","../../core/watchUtils","../../core/accessorSupport/decorators"],function(e,t,r,i,n,a,s,o,y,l){var d={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},c=a.ofType(o),h=(function(){function e(){}return e}(),["esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.MapImageLayer","esri.layers.TileLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.ImageryLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer"]),p="view.basemapView.baseLayerViews",u="view.groundView.layerViews",f="view.layerViews",L="view.basemapView.referenceLayerViews",v=[p,u,f,L],_=function(e){function t(t){var r=e.call(this,t)||this;return r._handles=new s,r._layerViewByLayerId={},r._layerInfosByLayerViewId={},r._activeLayerInfosByLayerViewId={},r.activeLayerInfos=new c,r.basemapLegendVisible=!1,r.groundLegendVisible=!1,r.layerInfos=[],r.view=null,r}return r(t,e),t.prototype.initialize=function(){this._handles.add(y.init(this,"view",this._viewHandles),d.view)},t.prototype.destroy=function(){this._destroyViewActiveLayerInfos(),this._handles.destroy(),this._handles=null,this.view=null},Object.defineProperty(t.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!0,configurable:!0}),t.prototype._viewHandles=function(){this._handles.remove(d.state),this.view&&this._handles.add(y.init(this,"state",this._stateHandles),d.state)},t.prototype._stateHandles=function(){this._resetAll(),"ready"===this.state&&this._watchPropertiesAndAllLayerViews()},t.prototype._resetAll=function(){this._handles.remove([d.allLayerViews,d.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()},t.prototype._destroyViewActiveLayerInfos=function(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)},t.prototype._destroyViewActiveLayerInfo=function(e){this._handles.remove(e),delete this._activeLayerInfosByLayerViewId[e]},t.prototype._watchPropertiesAndAllLayerViews=function(){var e=this.view.allLayerViews;e.length&&this._refresh(),this._handles.add(e.on("change",this._allLayerViewsChangeHandle.bind(this)),d.allLayerViews),this._handles.add(y.watch(this,"layerInfos, basemapLegendVisible, groundLegendVisible",this._propertiesChangeHandle.bind(this)),d.legendProperties)},t.prototype._allLayerViewsChangeHandle=function(e){var t=this;e.removed.forEach(function(e){return t._destroyViewActiveLayerInfo(e.uid)}),this._refresh()},t.prototype._propertiesChangeHandle=function(){this._destroyViewActiveLayerInfos(),this._refresh()},t.prototype._refresh=function(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)},t.prototype._sortActiveLayerInfos=function(e){var t={};this.view.allLayerViews.forEach(function(e,r){return t[e.layer.uid]=r}),e.sort(function(e,r){var i=t[e.layer.uid]||0,n=t[r.layer.uid]||0;return n-i})},t.prototype._generateLayerViews=function(){var e=[];return v.filter(this._filterLayerViews,this).map(this.get,this).filter(function(e){return null!=e}).forEach(this._collectLayerViews("layerViews",e)),e},t.prototype._filterLayerViews=function(e){var t=!this.basemapLegendVisible&&(e===p||e===L),r=!this.groundLegendVisible&&e===u;return!t&&!r},t.prototype._collectLayerViews=function(e,t){var r=function(i){return i&&i.forEach(function(i){t.push(i),r(i[e])}),t};return r},t.prototype._filterLayerViewsByLayerInfos=function(e){var t=this,r=this.layerInfos;return r&&r.length?r.some(function(r){return t._hasLayerInfo(r,e)}):!0},t.prototype._hasLayerInfo=function(e,t){var r=this._isLayerUIDMatching(e.layer,t.layer.uid);return r&&(this._layerInfosByLayerViewId[t.uid]=e),r},t.prototype._isLayerUIDMatching=function(e,t){return e&&(e.uid===t||this._hasLayerUID(e.layers,t))},t.prototype._hasLayerUID=function(e,t){var r=this;return e&&e.some(function(e){return r._isLayerUIDMatching(e,t)})},t.prototype._isLayerViewSupported=function(e){return h.indexOf(e.layer.declaredClass)>-1?(this._layerViewByLayerId[e.layer.uid]=e,!0):!1},t.prototype._generateActiveLayerInfo=function(e){var t=this;return this._isLayerActive(e)?void this._buildActiveLayerInfo(e):(this._handles.remove(e.uid),void this._handles.add(y.watch(e,"suspended, layer.legendEnabled",function(){return t._layerActiveHandle(e)}),e.uid))},t.prototype._layerActiveHandle=function(e){this._isLayerActive(e)&&(this._handles.remove(e.uid),this._buildActiveLayerInfo(e))},t.prototype._isLayerActive=function(e){return!e.suspended&&e.get("layer.legendEnabled")},t.prototype._buildActiveLayerInfo=function(e){var t=this,r=e.layer,i=e.uid,n=this._layerInfosByLayerViewId[i],a=this._activeLayerInfosByLayerViewId[i];if(!a){var s=n&&void 0!==n.title;a=new o({layer:r,title:s?n.title:r.title}),this._activeLayerInfosByLayerViewId[i]=a}if(!a.parent){var l=r.parent,d=l&&this._layerViewByLayerId[l.uid];a.parent=d&&this._activeLayerInfosByLayerViewId[d.uid]}if(!this._handles.has(i)){var c=y.watch(r,"title",function(r){return t._titleHandle(r,a,e)}),h=y.watch(r,"legendEnabled",function(r){return t._legendEnabledHandle(r,a,e)}),p=y.watch(r,"renderer, opacity",function(){return t._constructLegendElements(a,e)}),u=y.watch(e,"suspended",function(r){return t._suspendedHandle(r,a,e)}),f=y.whenTrue(this.view,"stationary",function(){return t._scaleHandle(a,e)});this._handles.add([c,h,p,u,f],i)}this._addActiveLayerInfo(a,e)},t.prototype._titleHandle=function(e,t,r){t.title=e,this._constructLegendElements(t,r)},t.prototype._legendEnabledHandle=function(e,t,r){e?this._addActiveLayerInfo(t,r):this._removeActiveLayerInfo(t)},t.prototype._suspendedHandle=function(e,t,r){e?this._removeActiveLayerInfo(t):this._addActiveLayerInfo(t,r)},t.prototype._scaleHandle=function(e,t){e.scale!==this.view.scale&&this._constructLegendElements(e,t)},t.prototype._addActiveLayerInfo=function(e,t){if(this._isLayerActive(t)&&-1===this.activeLayerInfos.indexOf(e)){var r=e.parent;r?-1===r.children.indexOf(e)&&(r.children.push(e),this._sortActiveLayerInfos(r.children)):(this.activeLayerInfos.add(e),this._sortActiveLayerInfos(this.activeLayerInfos))}},t.prototype._removeActiveLayerInfo=function(e){var t=e.parent;if(t){var r=t.children.indexOf(e);-1!==r&&t.children.splice(r,1)}else this.activeLayerInfos.remove(e)},t.prototype._constructLegendElements=function(e,t){var r=t.layer;e.scale=this.view.scale,r.featureCollections?e.buildLegendElementsForFeatureCollections(r.featureCollections):r.renderer?e.buildLegendElementsForRenderer():r.url&&e.buildLegendElementsForTools()},t}(l.declared(n));return i([l.property({type:c})],_.prototype,"activeLayerInfos",void 0),i([l.property()],_.prototype,"basemapLegendVisible",void 0),i([l.property()],_.prototype,"groundLegendVisible",void 0),i([l.property()],_.prototype,"layerInfos",void 0),i([l.property({dependsOn:["view.ready"],readOnly:!0})],_.prototype,"state",null),i([l.property()],_.prototype,"view",void 0),_=i([l.subclass("esri.widgets.Legend.LegendViewModel")],_)});