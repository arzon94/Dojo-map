// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/declareExtendsHelper","./core/tsSupport/decorateHelper","./core/accessorSupport/decorators","dojo/_base/lang","./support/basemapDefinitions","./core/Collection","./core/collectionUtils","./core/Evented","./core/JSONSupport","./core/Loadable","./core/promiseUtils","./core/requireUtils","./core/urlUtils","./core/Logger","./portal/Portal","./portal/PortalItem","./layers/Layer"],function(e,r,t,o,a,i,n,s,l,p,u,c,y,f,h,d,m,b,L){var g=0,v=s.ofType(L),w=d.getLogger("esri.Basemap"),I=S=function(r){function o(e){var t=r.call(this)||this;t.id=null,t.portalItem=null,t.resourceInfo=null,t.thumbnailUrl=null,t.title="Basemap",t.id=Date.now().toString(16)+"-basemap-"+g++,t.baseLayers=new s,t.referenceLayers=new s;var o=function(e){"elevation"===e.type&&w.error("Layer '"+e.title+", id:"+e.id+"' of type '"+e.type+"' is not supported as a basemap layer and will therefore be ignored.")};return t.baseLayers.on("after-add",function(e){return o(e.item)}),t.referenceLayers.on("after-add",function(e){return o(e.item)}),t}return t(o,r),o.prototype.initialize=function(){var e=this;this.otherwise(function(r){w.error("#load()","Failed to load basemap (title: '"+e.title+"', id: '"+e.id+"')",r)}),this.resourceInfo&&this.read(this.resourceInfo)},Object.defineProperty(o.prototype,"baseLayers",{set:function(e){this._set("baseLayers",l.referenceSetter(e,this._get("baseLayers"),v))},enumerable:!0,configurable:!0}),o.prototype.writeBaseLayers=function(e,r,t,o){var a=[];return e?(o=i.mixin({},o,{layerContainerType:"basemap"}),this.baseLayers.forEach(function(e){if(e.write){var r={};e.write(r,o)&&a.push(r)}}),this.referenceLayers.forEach(function(e){if(e.write){var r={isReference:!0};e.write(r,o)&&a.push(r)}}),void(r.baseMapLayers=a)):a},Object.defineProperty(o.prototype,"referenceLayers",{set:function(e){this._set("referenceLayers",l.referenceSetter(e,this._get("referenceLayers"),v))},enumerable:!0,configurable:!0}),o.prototype.writeTitle=function(e,r){r.title=e||"Basemap"},o.prototype.load=function(){return this.addResolvingPromise(this._loadFromSource()),this},o.prototype.clone=function(){var e={id:this.id,title:this.title};return this.resourceInfo||this.portalItem?(e.portalItem=this.portalItem,e.resourceInfo=this.resourceInfo):(e.baseLayers=this.baseLayers.slice(),e.referenceLayers=this.referenceLayers.slice()),new S(e)},o.prototype.read=function(e,r){return!r||"web-scene"!==r.origin&&"web-map"!==r.origin||(this._layerOrigin=r.origin),r&&r.portal&&(this._layerPortal=r.portal),this.inherited(arguments)},o.prototype.write=function(e,r){return e=e||{},r&&r.origin||(r=i.mixin({origin:"web-map"},r)),this.inherited(arguments,[e,r]),!this.loaded&&this.resourceInfo&&this.resourceInfo.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.baseMapLayers.map(function(e){var r=i.clone(e);return r.url&&h.isProtocolRelative(r.url)&&(r.url="https:"+r.url),r.templateUrl&&h.isProtocolRelative(r.templateUrl)&&(r.templateUrl="https:"+r.templateUrl),r})),e},o.prototype._loadFromSource=function(){var e=this.resourceInfo,r=this.portalItem;return e?this._loadFromJSON(e):r?this._loadFromItem(r):y.resolve(null)},o.prototype._loadFromJSON=function(r,t){var o=this,a=this.portalItem&&this.portalItem.portal||this._layerPortal||null;return f.when(e,"./portal/support/layersCreator").then(function(e){var i=[];if(r.baseMapLayers&&Array.isArray(r.baseMapLayers)){var n={context:{origin:o._layerOrigin||"web-map",layerContainerType:"basemap",url:t,portal:a},defaultLayerType:"DefaultTileLayer"},s=e.populateOperationalLayers(o.baseLayers,r.baseMapLayers.filter(function(e){return!e.isReference}),n);i.push.apply(i,s);var l=e.populateOperationalLayers(o.referenceLayers,r.baseMapLayers.filter(function(e){return e.isReference}),n);i.push.apply(i,l)}return y.eachAlways(i)}).then(function(){})},o.prototype._loadFromItem=function(e){var r=this;return e.load().then(function(e){return e.fetchData()}).then(function(t){var o=h.urlToObject(e.itemUrl);return r.resourceInfo=t.baseMap,r.read(r.resourceInfo,{origin:"web-map",portal:e.portal||m.getDefault(),url:o}),r.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||m.getDefault(),url:o}),r._loadFromJSON(r.resourceInfo,o)})},o.fromJSON=function(e){return e?new S({resourceInfo:e}):null},o.fromId=function(e){var r=n[e];return r?S.fromJSON(r):null},o}(a.declared(u,p,c));o([a.property({type:v,json:{write:{ignoreOrigin:!0}}}),a.cast(l.castForReferenceSetter)],I.prototype,"baseLayers",null),o([a.writer("baseLayers")],I.prototype,"writeBaseLayers",null),o([a.property({json:{origins:{webScene:{write:!0}}}})],I.prototype,"id",void 0),o([a.property({type:b})],I.prototype,"portalItem",void 0),o([a.property({type:v}),a.cast(l.castForReferenceSetter)],I.prototype,"referenceLayers",null),o([a.property()],I.prototype,"resourceInfo",void 0),o([a.property()],I.prototype,"thumbnailUrl",void 0),o([a.property()],I.prototype,"title",void 0),o([a.writer("title")],I.prototype,"writeTitle",null),I=S=o([a.subclass("esri.Basemap")],I);var S;return I});
