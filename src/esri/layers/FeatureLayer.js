// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

//  copyright

/**
       * The copyright text as defined by the map service.
       *
       * @type {string}
       */

define(["require","dojo/_base/lang","dojo/io-query","../Graphic","../PopupTemplate","../request","../core/kebabDictionary","../core/MultiOriginJSONSupport","../core/Collection","../core/Error","../core/Logger","../core/lang","../core/HandleRegistry","../core/promiseUtils","../core/requireUtils","../core/urlUtils","../geometry/Extent","../geometry/SpatialReference","../geometry/support/normalizeUtils","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/support/jsonUtils","../symbols/support/ElevationInfo","../renderers/SimpleRenderer","../renderers/UniqueValueRenderer","../renderers/support/arcadeUtils","../renderers/support/jsonUtils","../renderers/support/styleUtils","../tasks/support/FeatureSet","../tasks/support/Query","./Layer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/ArcGISService","./graphics/sources/MemorySource","./support/Field","./support/fieldUtils","./support/FeatureType","./support/FeatureTemplate","./support/LabelClass","./support/labelingInfo","./support/arcgisLayerUrl","./support/commonProperties"],function(e,r,t,i,s,n,a,o,u,l,d,p,c,y,h,f,m,g,b,v,F,w,I,_,S,D,O,j,T,x,A,C,E,B,R,P,Q,q,U,M,L,G,V,k,z){var N=a({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),W="FeatureLayer",Z=d.getLogger("esri.layers.FeatureLayer"),J=function(e,r){var t=x.fromJSON(r.featureSet);return new Q({layer:this,items:t&&t.features||[]})},H=C.createSubclass([E,B,R,P,o],{declaredClass:"esri.layers.FeatureLayer",viewModulePaths:{"2d":"../views/2d/layers/FeatureLayerView2D","3d":"../views/3d/layers/FeatureLayerView3D"},constructor:function(){this._handles=new c},normalizeCtorArgs:function(e,t){return"string"==typeof e?r.mixin({},{url:e},t):e},load:function(){var e,r=this.source&&(Array.isArray(this.source)||this.source.isInstanceOf&&this.source.isInstanceOf(u));e=this.portalItem&&r?y.resolve():this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]}).always(function(){return this.url&&null==this.layerId&&/FeatureServer\/*$/i.test(this.url)?this._fetchFirstLayerId().then(function(e){null!=e&&(this.layerId=e)}.bind(this)):void 0}.bind(this)).then(function(){if(!this.url&&!this._hasMemorySource())throw new l("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this.createGraphicsSource().then(this._initLayerProperties.bind(this))}.bind(this)),this.addResolvingPromise(e)},_handles:null,properties:{advancedQueryCapabilities:{json:{origins:{service:{read:{source:["advancedQueryCapabilities","supportsStatistics","supportsAdvancedQueries"],reader:function(e,r){return this._readAdvancedQueryCapabilities(r)}}}},read:{source:["layerDefinition.supportsAdvancedQueries","layerDefinition.supportsStatistics"],reader:function(e,r){return this._readAdvancedQueryCapabilities(r.layerDefinition)}}}},featureReduction:{json:{origins:{webScene:{read:{source:"layerDefinition.featureReduction"},write:{target:"layerDefinition.featureReduction"}}}}},allowGeometryUpdates:{json:{origins:{service:{read:{reader:function(e){return this._readAllowGeometryUpdates(e)}}}},read:{source:"layerDefinition.allowGeometryUpdates",reader:function(e){return this._readAllowGeometryUpdates(e)}}}},allRenderers:{readOnly:!0,dependsOn:["loaded","renderer","fields"],get:function(){return this._getAllRenderers(this.renderer)}},capabilities:{json:{origins:{service:{read:{source:["advancedQueryCapabilities","supportsStatistics","supportsAdvancedQueries","hasAttachments","hasM","hasZ","supportsCalculate","supportsTruncate","supportsValidateSql","supportsCoordinatesQuantization","useStandardizedQueries","ownershipBasedAccessControlForFeatures","allowGeometryUpdates","supportsApplyEditsWithGlobalIds","supportsRollbackOnFailureParameter","allowUpdateWithoutMValues","supportsAttachmentsByUploadId"],reader:function(e,r){return this._readCapabilities(e,r)}}}},read:{source:["layerDefinition.capabilities","layerDefinition.advancedQueryCapabilities","layerDefinition.supportsStatistics","layerDefinition.supportsAdvancedQueries","layerDefinition.hasAttachments","layerDefinition.hasM","layerDefinition.hasZ","layerDefinition.supportsCalculate","layerDefinition.supportsTruncate","layerDefinition.supportsValidateSql","layerDefinition.supportsCoordinatesQuantization","layerDefinition.useStandardizedQueries","layerDefinition.ownershipBasedAccessControlForFeatures","layerDefinition.allowGeometryUpdates","layerDefinition.supportsApplyEditsWithGlobalIds","layerDefinition.supportsRollbackOnFailureParameter","layerDefinition.allowUpdateWithoutMValues","layerDefinition.supportsAttachmentsByUploadId"],reader:function(e,r){return this._readCapabilities(r.layerDefinition.capabilities,r.layerDefinition)}}},dependsOn:["loaded"],get:function(){var e=this._get("capabilities");return!e&&this.loaded&&this._hasMemorySource()&&(e={data:{supportsAttachment:!1,supportsM:!1,supportsZ:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!0,supportsDelete:!0,supportsEditing:!0,supportsQuery:!0,supportsUpdate:!0},query:{supportsStatistics:!1,supportsCentroid:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!0,supportsGeometryProperties:!1,supportsOrderBy:!1,supportsPagination:!1,supportsQuantization:!1,supportsResultType:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsQueryByOthers:!1},queryRelated:{supportsPagination:!1,supportsCount:!1,supportsOrderBy:!1},editing:{supportsGeometryUpdate:!0,supportsGlobalId:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1}}),e}},copyright:{value:null,json:{origins:{service:{read:{source:"copyrightText"}}},read:{source:"layerDefinition.copyrightText"}}},displayField:{value:null,json:{origins:{service:{read:{source:"displayField"}}},read:{source:"layerDefinition.displayField"}}},definitionExpression:{value:null,json:{origins:{service:{read:!1,write:!1}},read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}},defaultSymbol:{json:{read:I.read}},elevationInfo:{type:_,value:null,json:{origins:{service:{read:{source:"elevationInfo"},write:{target:"elevationInfo",enabled:!1}}},read:{source:"layerDefinition.elevationInfo"},write:{target:"layerDefinition.elevationInfo"}}},fields:{value:null,type:[q],json:{origins:{service:{read:!0}},read:{source:"layerDefinition.fields"}}},fullExtent:{value:null,type:m,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}},gdbVersion:null,generalizeForScale:4e3,geometryType:{json:{origins:{service:{read:N.fromJSON}},read:{source:"layerDefinition.geometryType",reader:N.fromJSON}}},hasAttachments:{value:!1,readOnly:!0,get:function(){return!this._hasMemorySource()&&this._get("hasAttachments")},json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasAttachments"}}},hasM:{value:!1,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}},hasZ:{value:!1,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}},id:{json:{origins:{service:{read:!1},portalItem:{read:!1}}}},isTable:{value:!1,readOnly:!0,json:{origins:{service:{read:{source:"type",reader:function(e){return"Table"===e}}}},read:{source:"layerDefinition.type",reader:function(e){return"Table"===e}}}},labelsVisible:{value:!1,json:{read:{source:["showLabels"],reader:function(e,r){return!!r.showLabels}},write:function(e,r){r.showLabels=!!e}}},labelingInfo:{value:null,type:[G],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:V.reader},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:V.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}},layerId:{json:{origins:{service:{read:{source:["id"],reader:function(e,r){return r.id}}}},read:!1}},legendEnabled:{value:!0,json:{read:{source:["showLegend"],reader:function(e,r){return null!=r.showLegend?r.showLegend:!0}},write:function(e,r){r.showLegend=!!e}}},maxRecordCount:{value:null,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.maxRecordCount"}}},minScale:{json:{origins:{service:{read:{source:["minScale","effectiveMinScale"],reader:function(e,r){return r.effectiveMinScale||e}},write:{target:["minScale"],enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},maxScale:{json:{origins:{service:{read:{source:["maxScale","effectiveMaxScale"],reader:function(e,r){return r.effectiveMaxScale||e}},write:{target:"maxScale",enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},objectIdField:{json:{origins:{service:{read:{source:["objectIdField","fields"],reader:function(e,r){return this._readObjectIdField(r)}}}},read:{source:["layerDefinition.objectIdField","layerDefinition.fields"],reader:function(e,r){return this._readObjectIdField(r.layerDefinition)}}}},operationalLayerType:"ArcGISFeatureLayer",outFields:{value:null,dependsOn:["requiredFields"],get:function(){var e=this._get("outFields"),r=this.requiredFields;return e?-1===e.indexOf("*")&&r.forEach(function(r){-1===e.indexOf(r)&&e.push(r)}):e=r,this.loaded&&(e=e.filter(function(e){return"*"===e||!!this.getField(e)},this),e=e.map(function(e){return"*"===e?e:this.getField(e).name},this)),e},set:function(e){var r=this.requiredFields;e?-1===e.indexOf("*")&&r.forEach(function(r){-1===e.indexOf(r)&&e.push(r)}):e=r,this.loaded&&(e=e.filter(function(e){return"*"===e||!!this.getField(e)},this),e=e.map(function(e){return"*"===e?e:this.getField(e).name},this)),this._set("outFields",e)}},parsedUrl:{dependsOn:["layerId"],get:function(){var e=this.url?f.urlToObject(this.url):null;return null!=this.layerId&&null!=e&&(e.path=f.join(e.path,this.layerId.toString())),e}},popupEnabled:{value:!0,json:{read:{source:["disablePopup"],reader:function(e,r){return null!=r.disablePopup?!r.disablePopup:!0}},write:function(e,r){e||(r.disablePopup=!0)}}},popupTemplate:{value:null,type:s,json:{read:{source:["popupInfo"],reader:function(e,r){return r.popupInfo?s.fromJSON(r.popupInfo):null}},write:function(e,r){e&&(r.popupInfo=e.toJSON())}}},relationships:null,renderer:{set:function(e){var r=this._getAllRenderers(e);U.fixRendererFields(r,this.fields),this._set("renderer",e)},json:{origins:{service:{read:{source:["drawingInfo.renderer","defaultSymbol","type"],reader:function(e,r,t){return this._readRenderer(null,r,t)}},write:{target:"drawingInfo.renderer",enabled:!1}}},read:{source:["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol","layerDefinition.type"],reader:function(e,r,t){return this._readRenderer(null,r.layerDefinition,t)}},write:{target:"layerDefinition.drawingInfo.renderer"}}},requiredFields:{dependsOn:["allRenderers"],get:function(){var e=this.timeInfo,t=[this.objectIdField,this.typeIdField,this.editFieldsInfo&&this.editFieldsInfo.creatorField,e&&e.startTimeField,e&&e.endTimeField,this.trackIdField],i=U.rendererFields,s=[];return this.allRenderers.forEach(function(e){i.forEach(function(i){t.push(r.getObject(i,!1,e))}),e.valueExpression&&(s=s.concat(O.extractFieldNames(e.valueExpression))),e.visualVariables&&e.visualVariables.forEach(function(e){U.visualVariableFields.forEach(function(r){t.push(e[r])}),e.valueExpression&&(s=s.concat(O.extractFieldNames(e.valueExpression)))},this)},this),t=t.concat(s),t=t.concat(this.dataAttributes),t.filter(function(e,r,t){return!!e&&t.indexOf(e)===r&&"function"!=typeof e})}},returnM:!1,returnZ:!1,screenSizePerspectiveEnabled:z.screenSizePerspectiveEnabled,source:{json:{origins:{portalItem:{read:{source:["featureSet"],reader:J}},webMap:{read:{source:["featureSet"],reader:J}}}},cast:function(e){return e&&(Array.isArray(e)||e.isInstanceOf&&e.isInstanceOf(u))?new Q({layer:this,items:e}):e},set:function(e){var r=this._get("source");r!==e&&(r&&r.isInstanceOf&&r.isInstanceOf(Q)&&this._resetMemorySource(r),e&&e.isInstanceOf&&e.isInstanceOf(Q)&&this._initMemorySource(e),this._set("source",e))}},supportsCoordinatesQuantization:!1,serviceDefinitionExpression:{json:{origins:{service:{read:{source:["definitionExpression"],reader:function(e,r){return r.definitionExpression}}}}}},spatialReference:{json:{origins:{service:{read:{source:"extent",reader:function(e){return e&&e.spatialReference?g.fromJSON(e.spatialReference):void 0}}}},read:{source:"layerDefinition.extent",reader:function(e){return e&&e.spatialReference?g.fromJSON(e.spatialReference):void 0}}}},templates:{type:[L],json:{read:function(e,r){var t=r.editFieldsInfo,i=t&&t.creatorField,s=t&&t.editorField;return e=e&&e.map(function(e){return L.fromJSON(e)}),this._fixTemplates(e,i),this._fixTemplates(e,s),e}}},title:{json:{origins:{portalItem:{read:{source:["layerDefinition.title","layerDefinition.name","title"],reader:function(e,r){var t=r.layerDefinition&&r.layerDefinition.name,i=r.title||r.layerDefinition&&r.layerDefinition.title;return t?this._readTitleFromName(t):"item-title"===this.sublayerTitleMode&&i?i:void 0}}},service:{read:{source:"name",reader:function(e,r){return this._readTitleFromName(e)}}}}}},sublayerTitleMode:{type:String,value:"item-title"},trackIdField:{json:{read:{source:["timeInfo.trackIdField"],reader:function(e,r){return r.timeInfo.trackIdField}}}},type:{value:"feature",json:{read:!1}},typeIdField:{json:{origins:{service:{read:function(e,r){return this._readTypeIdField(e,r)}}},read:{source:"layerDefinition.typeIdField",reader:function(e,r){return this._readTypeIdField(e,r.layerDefinition)}}}},types:{json:{origins:{service:{read:function(e,r){return this._readTypes(e,r)}}},read:{source:"layerDefinition.types",reader:function(e,r){return this._readTypes(e,r.layerDefinition)}}}},url:{set:function(e){var r=f.urlToObject(e),i=k.parse(r.path);if(i&&null!=i.sublayer){null==this.layerId&&(this.layerId=i.sublayer);var s=t.objectToQuery(r.query);e=i.url.path,s&&(e=e+"?"+s)}this._set("url",e)},json:{write:function(e,r){if(e&&f.isProtocolRelative(e)&&(e="https:"+e),e&&(e=f.normalize(e),r.url=e),null!=this.layerId){var i=f.urlToObject(e);i&&(r.url=f.join(i.path,""+this.layerId),i.query&&Object.keys(i.query)&&(r.url+="?"+t.objectToQuery(i.query)))}}}},userIsAdmin:!1,version:{json:{origins:{service:{read:{source:["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"],reader:function(e,r){return this._readVersion(r)}}},portalItem:{read:!1}},read:{source:["layerDefinition.currentVersion","layerDefinition.capabilities","layerDefinition.drawingInfo","layerDefinition.hasAttachments","layerDefinition.htmlPopupType","layerDefinition.typeIdField","layerDefinition.types"],reader:function(e,r){return this._readVersion(r.layerDefinition)}}}},visible:{json:{origins:{portalItem:{read:{source:["visibility","layerDefinition.defaultVisibility"],reader:function(e,r){return r.layerDefinition&&null!=r.layerDefinition.defaultVisibility?!!r.layerDefinition.defaultVisibility:null!=r.visibility?!!r.visibility:void 0}},write:{target:"layerDefinition.defaultVisibility"}}}}}},applyEdits:function(e){return this.load().then(function(){return this.source.applyEdits?this._processApplyEditsParams(e).then(function(e){return this.source.applyEdits(e).then(function(e){var r=function(e){var r=function(e){return!e.error},t=function(e){return p.clone(e)};return e.filter(r).map(t)},t={addedFeatures:r(e.addFeatureResults),updatedFeatures:r(e.updateFeatureResults),deletedFeatures:r(e.deleteFeatureResults)};return(t.addedFeatures.length||t.updatedFeatures.length||t.deletedFeatures.length)&&this.emit("edits",t),e}.bind(this))}.bind(this)):y.reject(new l(W,"Layer source does not support applyEdits capability"))}.bind(this))},createGraphicsSource:function(){if(this._hasMemorySource())return this.emit("graphics-source-create",{graphicsSource:this.source}),y.resolve(this.source);var r="FeatureLayerSource";return h.when(e,"./graphics/sources/"+r).then(function(e){return new e({layer:this})}.bind(this)).then(function(e){return this.emit("graphics-source-create",{graphicsSource:e}),e}.bind(this))},createGraphicsController:function(t){var s,n=t.layerView,a=u.ofType(i),o=this.source,l=o&&o.isInstanceOf&&o.isInstanceOf(u),d=r.mixin(t.options||{},{layer:this,layerView:n,graphics:l?o:new a});return s=l?"./graphics/controllers/MemoryController":"2d"===n.view.type?"./graphics/controllers/AutoController2D":"./graphics/controllers/SnapshotController",h.when(e,s).then(function(e){return new e(d)}.bind(this)).then(function(e){return this.emit("graphics-controller-create",{graphicsController:e}),e}.bind(this))},createQuery:function(){var e=new A,r=this.get("capabilities.data");return e.returnGeometry=!0,e.returnZ=r&&r.supportsZ&&this.returnZ||null,e.returnM=r&&r.supportsM&&this.returnM||null,e.outFields=this.outFields,e.where=this.definitionExpression||"1=1",e.multipatchOption="multipatch"===this.geometryType?"xyFootprint":null,e},getFieldDomain:function(e,r){var t,i,s=r&&r.feature,n=s&&s.attributes,a=this.typeIdField&&n&&n[this.typeIdField];return null!=a&&this.types&&this.types.some(function(r){return r.id==a?(t=r.domains&&r.domains[e],t&&"inherited"===t.type&&(t=this._getLayerDomain(e),i=!0),!0):!1},this),i||t||(t=this._getLayerDomain(e)),t},getField:function(e,r){return U.getField(e,r||this.fields)},graphicChanged:function(e){this.emit("graphic-update",e)},queryFeatures:function(e){var r=this;return this.load().then(function(){return e=e||r.createQuery(),r.source.queryFeatures?r.source.queryFeatures(e):y.reject(new l(W,"Layer source does not support queryFeatures capability"))}).then(function(t){if(e.returnJSON)return t;if(t&&t.features){var i=r.popupTemplate;t.features.forEach(function(e){e.popupTemplate=i,e.layer=r})}return t})},queryObjectIds:function(e){var r=this;return this.load().then(function(){return e=e||r.createQuery(),r.source.queryObjectIds?r.source.queryObjectIds(e):y.reject(new l(W,"Layer source does not support queryObjectIds capability"))})},queryFeatureCount:function(e){var r=this;return this.load().then(function(){return e=e||r.createQuery(),r.source.queryFeatureCount?r.source.queryFeatureCount(e):y.reject(new l(W,"Layer source does not support queryFeatureCount capability"))})},queryExtent:function(e){var r=this;return this.load().then(function(){return e=e||r.createQuery(),r.source.queryExtent?r.source.queryExtent(e):y.reject(new l(W,"Layer source does not support queryExtent capability"))})},read:function(e,r){switch(r&&r.origin){case"web-map":this.inherited(arguments,[{outFields:["*"]},r]);break;case"web-scene":this.inherited(arguments,[{mode:H.MODE_SNAPSHOT,returnZ:!0,outFields:["*"]},r])}var t=e.featureCollection;if(t){var i=t.layers;i&&1===i.length&&(this.inherited(arguments,[i[0],r]),null!=t.showLegend&&this.inherited(arguments,[{showLegend:t.showLegend},r]))}return this.inherited(arguments,[e,r]),this},write:function(e,r){if(r&&"web-scene"===r.origin&&r.messages){if(!this.url)return r.messages.push(new l("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' require a url to a service to be written to web scenes",{layer:this})),null;if(this.isTable)return r.messages.push(new l("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a Table source cannot written to web scenes",{layer:this})),null}return this.inherited(arguments)},_getLayerDomain:function(e){var r;return this.fields&&this.fields.some(function(t){return t.name===e&&(r=t.domain),!!r}),r},_fetchFirstLayerId:function(){return n(this.url,{query:{f:"json"},callbackParamName:"callback",responseType:"json"}).then(function(e){return e.data&&Array.isArray(e.data.layers)&&e.data.layers.length>0?e.data.layers[0].id:void 0})},_initLayerProperties:function(e){return this.source||(this.source=e),e.url&&(this.url=e.url),e.layerDefinition&&this.read(e.layerDefinition,{origin:"service",url:this.parsedUrl}),this._verifySource(),this._verifyFields(),this._addSymbolUrlTokens(),U.fixRendererFields(this._getAllRenderers(this.renderer),this.fields),this.watch("token",function(){this._addSymbolUrlTokens()}.bind(this)),T.loadStyleRenderer(this,{origin:"service"})},_findUrlBasedSymbols:function(){var e=this.renderer;if(!e)return[];var r=[];e.symbol&&r.push(e.symbol),e.defaultSymbol&&r.push(e.defaultSymbol);var t=e.classBreakInfos||e.uniqueValueInfos;return t&&t.forEach(function(e){e.symbol&&r.push(e.symbol)}),r.filter(function(e){return!!e.url})},_addSymbolUrlTokens:function(){var e=this.token;if(!this._hasMemorySource()&&e){var r=this._findUrlBasedSymbols();r.forEach(function(r){var t=r.url;if(t&&-1!==t.search(/https?\:/i)&&!/[?&]token=/.test(t)){var i=-1===t.indexOf("?")?"?":"&";r.url=t+i+"token="+e}})}},_getAllRenderers:function(e){var r=[];if(e){var t=[e,e.trackRenderer,e.observationRenderer,e.latestObservationRenderer];t.forEach(function(e){e&&(r.push(e),e.rendererInfos&&e.rendererInfos.forEach(function(e){e.renderer&&r.push(e.renderer)}))})}return r},_verifyFields:function(){var e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||-1!==e.search(/\/FeatureServer\//i)||this.fields&&this.fields.some(function(e){return"geometry"===e.type})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")},_fixTemplates:function(e,r){e&&e.forEach(function(e){var t=e.prototype&&e.prototype.attributes;t&&r&&delete t[r]})},_verifySource:function(){if(this._hasMemorySource()){if(this.url)throw new l("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url");var e=["geometryType","fields","objectIdField"],r=e.every(function(e){return this.hasOwnProperty(e)},this);if(!r)throw new l("feature-layer:missing-property","FeatureLayer created as feature collection requires properties: "+e.join(),{requiredProperties:e})}else{if(this.isTable)throw new l("feature-layer:source-type-not-supported","The table feature service type is not yet supported",{sourceType:"Table"});if(!this.url)throw new l("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}},_initMemorySource:function(e){e.forEach(function(e){e.layer=this}.bind(this)),this._handles.add([e.on("after-add",function(e){e.item.layer=this}.bind(this)),e.on("after-remove",function(e){e.item.layer=null}.bind(this))],"fl-source")},_resetMemorySource:function(e){e.forEach(function(e){e.layer=null}.bind(this)),this._handles.remove("fl-source")},_hasMemorySource:function(){return!(this.url||!this.source)},_readTitleFromName:function(e){var r=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return this.url?k.titleFromUrlAndName(this.url,e):e;var t=e||this.url&&k.parse(this.url).title;if(t)return"item-title-and-service-name"===this.sublayerTitleMode&&r&&(t=r+" - "+t),k.cleanTitle(t)},_readAdvancedQueryCapabilities:function(e){return e.advancedQueryCapabilities||{supportsPagination:!1,supportsQueryWithDistance:!1,supportsReturningQueryExtent:!1,supportsStatistics:e.supportsStatistics,supportsOrderBy:e.supportsAdvancedQueries,supportsDistinct:e.supportsAdvancedQueries}},_readAllowGeometryUpdates:function(e){return null==e?!0:e},_readCapabilities:function(e,r){return{data:this._readDataCapabilities(r),operations:this._readOperationsCapabilities(e,r),query:this._readQueryCapabilities(r),queryRelated:this._readQueryRelatedCapabilities(r),editing:this._readEditingCapabilities(r)}},_readBoolean:function(e,r,t){return!!(e&&e.hasOwnProperty(r)?e[r]:t)},_readDataCapabilities:function(e){return{supportsAttachment:this._readBoolean(e,"hasAttachments",!1),supportsM:this._readBoolean(e,"hasM",!1),supportsZ:this._readBoolean(e,"hasZ",!1)}},_readOperationsCapabilities:function(e,r){e=e?e.toLowerCase().split(",").map(function(e){return e.trim()}):[];var t=-1!==e.indexOf("editing"),i=t&&-1!==e.indexOf("create"),s=t&&-1!==e.indexOf("delete"),n=t&&-1!==e.indexOf("update");return t&&!(i||s||n)&&(i=s=n=!0),{supportsCalculate:this._readBoolean(r,"supportsCalculate",!1),supportsTruncate:this._readBoolean(r,"supportsTruncate",!1),supportsValidateSql:this._readBoolean(r,"supportsValidateSql",!1),supportsAdd:i,supportsDelete:s,supportsEditing:t,supportsQuery:-1!==e.indexOf("query"),supportsUpdate:n}},_readQueryCapabilities:function(e){var r=e.advancedQueryCapabilities,t=e.ownershipBasedAccessControlForFeatures;return{supportsStatistics:this._readBoolean(r,"supportsStatistics",e.supportsStatistics),supportsCentroid:this._readBoolean(r,"supportsReturningGeometryCentroid",!1),supportsDistance:this._readBoolean(r,"supportsQueryWithDistance",!1),supportsDistinct:this._readBoolean(r,"supportsDistinct",e.supportsAdvancedQueries),supportsExtent:this._readBoolean(r,"supportsReturningQueryExtent",!1),supportsGeometryProperties:this._readBoolean(r,"supportsReturningGeometryProperties",!1),supportsOrderBy:this._readBoolean(r,"supportsOrderBy",e.supportsAdvancedQueries),supportsPagination:this._readBoolean(r,"supportsPagination",!1),supportsQuantization:this._readBoolean(e,"supportsCoordinatesQuantization",!1),supportsResultType:this._readBoolean(r,"supportsQueryWithResultType",!1),supportsSqlExpression:this._readBoolean(r,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:this._readBoolean(e,"useStandardizedQueries",!1),supportsQueryByOthers:this._readBoolean(t,"allowOthersToQuery",!0)}},_readQueryRelatedCapabilities:function(e){var r=e.advancedQueryCapabilities,t=this._readBoolean(r,"supportsAdvancedQueryRelated",!1);return{supportsPagination:this._readBoolean(r,"supportsQueryRelatedPagination",!1),supportsCount:t,supportsOrderBy:t}},_readEditingCapabilities:function(e){var r=e.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:this._readBoolean(e,"allowGeometryUpdates",!0),supportsGlobalId:this._readBoolean(e,"supportsApplyEditsWithGlobalIds",!1),supportsRollbackOnFailure:this._readBoolean(e,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:this._readBoolean(e,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:this._readBoolean(e,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:this._readBoolean(r,"allowAnonymousToDelete",!0),supportsDeleteByOthers:this._readBoolean(r,"allowOthersToDelete",!0),supportsUpdateByAnonymous:this._readBoolean(r,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:this._readBoolean(r,"allowOthersToUpdate",!0)}},_readObjectIdField:function(e){if(e.objectIdField)return e.objectIdField;if(e.fields)for(var r=0;r<e.fields.length;r++){var t=e.fields[r];if("esriFieldTypeOID"===t.type)return t.name}},_readRenderer:function(e,r,t){var i;if(e=r.drawingInfo&&r.drawingInfo.renderer||void 0)e=j.read(e,r,t)||void 0,e||Z.error("Failed to create renderer",{rendererDefinition:r.drawingInfo.renderer,layer:this,context:t});else if(r.defaultSymbol)I.read(r.defaultSymbol,r,t),r.types&&r.types.length?(e=new D({defaultSymbol:i,field:r.typeIdField}),r.types.forEach(function(r){e.addUniqueValueInfo(r.id,I.read(r.symbol,r,t))})):e=new S({symbol:i});else if("Table"!==r.type){switch(r.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":i=new v;break;case"esriGeometryPolyline":i=new F;break;case"esriGeometryPolygon":i=new w}e=i&&new S({symbol:i})}return e},_readTypeIdField:function(e,r){if(e){var t=this.getField(e,r.fields);t&&(e=t.name)}return e},_readTypes:function(e,r){var t=r.editFieldsInfo,i=t&&t.creatorField,s=t&&t.editorField;return e&&e.map(function(e){return e=new M(e),this._fixTemplates(e.templates,i),this._fixTemplates(e.templates,s),e},this)},_readVersion:function(e){return e.currentVersion?e.currentVersion:e.hasOwnProperty("capabilities")||e.hasOwnProperty("drawingInfo")||e.hasOwnProperty("hasAttachments")||e.hasOwnProperty("htmlPopupType")||e.hasOwnProperty("relationships")||e.hasOwnProperty("timeInfo")||e.hasOwnProperty("typeIdField")||e.hasOwnProperty("types")?10:9.3},_processApplyEditsParams:function(e){var t="'addFeatures', 'updateFeatures' or 'deleteFeatures' parameter is required",s="feature-layer:missing-parameters";if(!e)return y.reject(new l(s,t));if(e=r.mixin({},e),e.addFeatures=e.addFeatures||[],e.updateFeatures=e.updateFeatures||[],e.deleteFeatures=e.deleteFeatures||[],e.addFeatures.length||e.updateFeatures.length||e.deleteFeatures.length){var n=function(e){var r=new i;return r.geometry=e.geometry,r.attributes=e.attributes,r};return e.addFeatures=e.addFeatures.map(n),e.updateFeatures=e.updateFeatures.map(n),this._normalizeGeometries(e).then(function(e){return y.resolve(e)})}return y.reject(new l(s,t))},_normalizeGeometries:function(e){var r=e.addFeatures,t=e.updateFeatures,i=function(e){return e.geometry},s=r.concat(t).map(i);return b.normalizeCentralMeridian(s).then(function(i){var s=r.length,n=t.length;return i.slice(0,s).forEach(function(r,t){e.addFeatures[t].geometry=r}),i.slice(s,s+n).forEach(function(r,t){e.updateFeatures[t].geometry=r}),e})}});return H});