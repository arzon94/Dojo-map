// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","../Viewpoint","../Basemap","../support/basemapUtils","../core/JSONSupport","../core/lang","../core/Logger","../core/Collection","../core/collectionUtils","../core/promiseUtils","./Environment","./Lighting","./support/Description","./support/Title","./support/Thumbnail","dojo/_base/lang","dojo/promise/all","../views/3d/lib/glMatrix"],function(e,t,i,n,r,o,a,s,p,l,u,c,h,m,y,v,d,g,f,b,w,L){var _=0,T=M=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.id="",t}return i(t,e),t.prototype.clone=function(){return new M({id:this.id})},t}(r.declared(p));n([r.property({type:String,json:{write:!0}})],T.prototype,"id",void 0),T=M=n([r.subclass()],T);var S=c.ofType(T),A=u.getLogger("esri.webscene.Slide"),C=function(e){function t(t){var i=e.call(this,t)||this;return i._currentAnimation=null,i.id=Date.now().toString(16)+"-slide-"+_++,i.title=new g["default"],i.description=new d["default"],i.thumbnail=new f["default"],i.viewpoint=null,i.basemap=null,i.environment=new y,i.visibleLayers=new S,i}return i(t,e),t.prototype.readBasemap=function(e,t,i){if(!t.baseMap)return null;var n=new a;return n.resourceInfo=t.baseMap,n.read(t.baseMap,i),n},t.prototype.writeBasemap=function(e,t,i,n){t.baseMap||(t.baseMap={}),e.write(t.baseMap,n)},t.prototype.castBasemap=function(e){return s.ensureType(e)},Object.defineProperty(t.prototype,"visibleLayers",{set:function(e){this._set("visibleLayers",h.referenceSetter(e,this._get("visibleLayers"),S))},enumerable:!0,configurable:!0}),t.prototype.castVisibleLayers=function(e){return e&&"function"==typeof e.map?e.map(function(e){return"string"==typeof e?{id:e}:e.id?{id:e.id}:(A.warn('Invalid visible layer, expected { id }, Layer or "id"'),e)}):e},t.prototype.clone=function(){var e=this.constructor;return new e({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})},t.prototype._updateVisibleLayersFrom=function(e){var t=this,i=[];return m.eachAlways(this._allLayers(e.map).map(function(t){return e.whenLayerView(t).then(function(e){e.visible&&i.push(new T({id:e.layer.id}))})}).toArray()).then(function(){t.visibleLayers.removeAll(),t.visibleLayers.addMany(i)})},t.prototype.updateFrom=function(e,t){var i=this;return t=b.mixin({screenshot:b.mixin({format:"jpeg",quality:80,width:120,height:75},t&&t.screenshot)},t),e.then(function(){return i.viewpoint=e.viewpoint.clone(),i.environment.lighting=v.prototype.clone.apply(e.environment.lighting),i.basemap=e.map.basemap&&e.map.basemap.clone()||null,i._updateVisibleLayersFrom(e)}).then(function(){return e.takeScreenshot(t.screenshot)}).then(function(e){return i.thumbnail=new f["default"]({url:e.dataURL}),i})},t.prototype.applyTo=function(e,t){var i=this,n=b.mixin({animate:!0},t);return this._applyBasemap(e).then(function(){return w([i._applyViewpoint(e,n),i._applyLayerVisibility(e,n)])}).then(function(){return i})},t.prototype._applyBasemap=function(e){var t=this;return this.basemap?this.basemap.load().always(function(){e.map.basemap=s.clonePreservingTiledLayers(t.basemap,e.map.basemap)}):m.resolve()},t.prototype._allLayers=function(e){var t=new c;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t},t.prototype._collectLayers=function(e,t){var i=this;e.layers.forEach(function(e){t.add(e);var n=e;n.layers&&i._collectLayers(n,t)})},t.prototype._applyLayerVisibility=function(e,t){var i=this;if(this.visibleLayers){var n=this._allLayers(e.map);return t.applyToLayerViews?m.eachAlways(n.map(function(t){return e.whenLayerView(t).then(function(e){e.visible=i.visibleLayers.some(function(t){var i=t.id;return i===e.layer.id})})}).toArray()):(n.forEach(function(e){return e.visible=i.visibleLayers.some(function(t){var i=t.id;return i===e.id})}),m.resolve())}},t.prototype._applyViewpoint=function(e,t){if(this.viewpoint){if(this.viewpoint.camera.fov=e.camera.fov,t.animate)return this.get("environment.lighting.date")?this._animateToLighting(e,t).then(function(){}):(e.environment.lighting=this.environment.lighting.clone(),e.goTo(this.viewpoint,t).then(function(){}));e.viewpoint=this.viewpoint,e.environment.lighting=this.environment.lighting.clone()}return m.resolve()},t.prototype._animateToLighting=function(e,t){var i,n=this;"global"===e.viewingMode&&(i=this._animateLightingWithCamera(e)),this._currentAnimation&&(this._currentAnimation.stop(),this._currentAnimation=null),e.environment.lighting.cameraTrackingEnabled=!1,e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,null!=this.environment.lighting.displayUTCOffset&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset);var r=e.goTo(this.viewpoint,t);return this._currentAnimation=r,this._currentAnimation.always(function(){i&&i.remove(),n._currentAnimation===r&&(e.environment.lighting.cameraTrackingEnabled=!0)}),this._currentAnimation.then(function(){e.environment.lighting=n.environment.lighting.clone()}),this._currentAnimation},t.prototype._getTime=function(e){var t=e.getTime(),i=3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds();return[t,i]},t.prototype._setTime=function(e,t,i){return e.setTime(t),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e},t.prototype._animateLightingWithCamera=function(e){var t=this,i=L.vec3d,n=new Date(e.environment.lighting.date.toString()),r=this._getTime(n),o=r[0],a=r[1],s=this._getTime(this.environment.lighting.date),p=s[0],l=s[1],u=e.renderCoordsHelper,c=[0,0,0];u.toRenderCoords(e.camera.position,c);var h=[0,0,0];u.toRenderCoords(this.viewpoint.camera.position,h);var m=[0,0,0],y=new Date;return e.watch("camera",function(n){u.toRenderCoords(n.position,m);var r=i.dist2(c,m),s=i.dist2(h,m),v=0;r+s!==0&&(v=r/(r+s));var d=o+(p-o)*v,g=a+(l-a)*v;e.environment.lighting.date=t._setTime(y,d,g)})},t.createFrom=function(e,t){var i=new this;return i.updateFrom(e,t)},t.sanitizeJSON=function(e){var t;t=void 0!==e.visibleLayers&&Array.isArray(e.visibleLayers)?l.clone(e.visibleLayers):[];var i={id:e.id||"",title:e.title||{text:""},thumbnail:e.thumbnail||{url:""},viewpoint:e.viewpoint,baseMap:e.baseMap,visibleLayers:t};return void 0!==e.description&&(i.description=e.description),void 0!==e.environment&&(i.environment=y.sanitizeJSON(e.environment)),i},t}(r.declared(p));n([r.property({json:{write:!0}})],C.prototype,"id",void 0),n([r.property({type:g["default"],json:{write:!0}})],C.prototype,"title",void 0),n([r.property({type:d["default"],json:{write:!0}})],C.prototype,"description",void 0),n([r.property({type:f["default"],json:{write:!0}})],C.prototype,"thumbnail",void 0),n([r.property({type:o,json:{write:!0}})],C.prototype,"viewpoint",void 0),n([r.property({json:{write:{target:"baseMap"}}})],C.prototype,"basemap",void 0),n([r.reader("basemap",["baseMap"])],C.prototype,"readBasemap",null),n([r.writer("basemap")],C.prototype,"writeBasemap",null),n([r.cast("basemap")],C.prototype,"castBasemap",null),n([r.property({type:S,json:{write:!0}})],C.prototype,"visibleLayers",null),n([r.cast("visibleLayers")],C.prototype,"castVisibleLayers",null),n([r.property({type:y,json:{write:!0}})],C.prototype,"environment",void 0),C=n([r.subclass("esri.webscene.Slide")],C);var M;return C});