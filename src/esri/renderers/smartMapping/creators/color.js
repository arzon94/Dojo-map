// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","dojo/i18n!../../nls/smartMapping","dojo/_base/lang","../../../core/lang","../statistics/summaryStatistics","../symbology/color","../../../core/numberUtils","../../support/utils","../../ClassBreaksRenderer","../../../core/promiseUtils","../../../views/SceneView","./support/utils","../support/utils"],function(e,r,a,o,l,i,n,t,s,u,c,d,m,p){function y(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return c.reject(m.createError("color-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var r=o.mixin({},e);return r.layer=p.createLayerAdapter(r.layer),r.layer?r.layer.load().then(function(){var e=r.layer.geometryType;if("mesh"!==e&&r.worldScale){if("polyline"===e||"polygon"===e)return c.reject(m.createError("color-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers"));if(!(r.view instanceof d))return c.reject(m.createError("color-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"))}var a=p.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression}),o=m.verifyBasicFieldValidity(r.layer,a,"color-visual-variable:invalid-parameters");return o?c.reject(o):r}):c.reject(m.createError("color-visual-variable:invalid-parameters","'layer' must be one of these types: "+j))}function f(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return c.reject(m.createError("color-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var r=o.mixin({},e);return r.symbolType=r.symbolType||"2d",r.layer=p.createLayerAdapter(r.layer),r.layer?r.layer.load().then(function(){var e=r.layer.geometryType,a=r.symbolType.indexOf("3d")>-1;if("mesh"===e)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace";else{if(a&&("polyline"===e||"polygon"===e))return c.reject(m.createError("color-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(r.symbolType.indexOf("3d-volumetric")>-1&&!(r.view instanceof d))return c.reject(m.createError("color-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'"))}var o=p.getFieldsList({field:r.field,normalizationField:r.normalizationField,valueExpression:r.valueExpression}),l=m.verifyBasicFieldValidity(r.layer,o,"color-continuous-renderer:invalid-parameters");return l?c.reject(l):r}):c.reject(m.createError("color-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+j))}function v(e){var r=o.mixin({},e),a=r.symbolType.indexOf("3d-volumetric")>-1;delete r.symbolType,delete r.defaultSymbolEnabled,delete r.colorMixMode;var l=r;return l.worldScale=a,l}function b(e,r,a){var o=e.colorScheme,l=e.basemap;if(o)o=n.cloneScheme(o);else{var i=n.getSchemes({theme:a||e.theme||w,basemap:e.basemap,geometryType:r,worldScale:e.worldScale,view:e.view});o=i&&i.primaryScheme,l=i&&i.basemapId}return{scheme:o,basemapId:l}}function h(e,r,a){for(var o=(r-e)/(a-1),l=[e],i=1;a-2>=i;i++)l.push(e+i*o);return l.push(r),t.round(l,{strictBounds:!0})}function x(e,r,a){var o=a.layer,l=a.field,i="function"==typeof l,t=l&&!i?o.getField(l):null,u=t&&t.type===V,d=o.geometryType,p=b(a,d),y=p.scheme,f=5;if(!y)return c.reject(m.createError("color-visual-variable:insufficient-info","Unable to find color scheme"));var v=m.createColors(y.colors,f);if(v.length<f)return c.reject(m.createError("color-visual-variable:insufficient-info","Color scheme does not have enough colors"));var x=m.getDefaultDataRange(e,u,!0),E=y.id.indexOf("seq-")>-1,S=x?h(x[0],x[1],5):m.createStopValues(e,E),g=[0,2,4],w=m.createColors(v,f),T={type:"color",field:l,valueExpression:a.valueExpression,normalizationField:r,stops:s.createColorStops({values:S,isDate:u,dateFormatOptions:u?s.timelineDateFormatOptions:null,colors:w,labelIndexes:g}),legendOptions:a.legendOptions};return c.resolve({basemapId:p.basemapId,visualVariable:T,statistics:e,defaultValuesUsed:!!x,colorScheme:n.cloneScheme(y),authoringInfo:{visualVariables:[{type:"color",minSliderValue:e.min,maxSliderValue:e.max,theme:y.theme}]}})}function E(e,r,o,i){var t=i.layer,c=i.field,d=t.geometryType,p=null==i.defaultSymbolEnabled?!0:i.defaultSymbolEnabled,y=n.cloneScheme(e.colorScheme),f=new u({classBreakInfos:[{minValue:-T,maxValue:T,symbol:m.createSymbol(y,y.noDataColor,d,i.symbolType,i.colorMixMode)}],defaultLabel:p?a.other:null,defaultSymbol:p?m.createSymbol(y,y.noDataColor,d,i.symbolType,i.colorMixMode):null,field:c,normalizationType:r,normalizationField:o,valueExpression:i.valueExpression,visualVariables:[s.cloneColorVariable(e.visualVariable)],authoringInfo:l.clone(e.authoringInfo)});return{renderer:f,visualVariable:s.cloneColorVariable(e.visualVariable),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,colorScheme:n.cloneScheme(e.colorScheme),basemapId:e.basemapId}}function S(e){return y(e).then(function(e){var r,a=e.normalizationField,o=a?"field":void 0;return r=e.statistics?c.resolve(e.statistics):i({layer:e.layer,field:e.field,valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere,normalizationType:o,normalizationField:a,minValue:e.minValue,maxValue:e.maxValue}),r.then(function(r){return x(r,a,e)})})}function g(e){return f(e).then(function(e){return S(v(e)).then(function(r){var a=e.normalizationField,o=a?"field":void 0;return E(r,o,a,e)})})}Object.defineProperty(r,"__esModule",{value:!0});var V="date",w="high-to-low",T=Math.pow(2,53)-1,j=p.supportedLayerTypes.join(", ");r.createVisualVariable=S,r.createContinuousRenderer=g});