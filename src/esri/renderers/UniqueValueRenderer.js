// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","../core/lang","../core/urlUtils","../core/Logger","../core/Error","../core/arrayUtils","../portal/Portal","../symbols/WebStyleSymbol","../symbols/support/jsonUtils","../symbols/support/symbolUtils","./Renderer","./support/arcadeUtils","./support/diffUtils"],function(e,t,r,o,l,n,i,u,s,a,p,f,d,y,c,m,v){var h=u.getLogger("esri.renderers.UniqueValueRenderer"),b=g=function(e){function t(t){var r=e.call(this)||this;return r._valueInfoMap={},r._isDefaultSymbolDerived=!1,r.type="uniqueValue",r.field=null,r.field2=null,r.field3=null,r.valueExpression=null,r.valueExpressionTitle=null,r.legendOptions=null,r.defaultLabel=null,r.fieldDelimiter=null,r.portal=null,r.styleOrigin=null,r.diff={uniqueValueInfos:function(e,t){if(e||t){if(!e||!t)return{type:"complete",oldValue:e,newValue:t};for(var r=!1,o={type:"collection",added:[],removed:[],changed:[],unchanged:[]},l=function(l){var n=a.find(e,function(e){return e.value===t[l].value});n?v.diff(n,t[l])?(o.changed.push({type:"complete",oldValue:n,newValue:t[l]}),r=!0):(o.unchanged.push({oldValue:n,newValue:t[l]}),r=!0):(o.added.push(t[l]),r=!0)},n=0;n<t.length;n++)l(n);for(var i=function(l){var n=a.find(t,function(t){return t.value===e[l].value});n||(o.removed.push(e[l]),r=!0)},n=0;n<e.length;n++)i(n);return r?o:void 0}}},r._set("uniqueValueInfos",[]),r}return r(t,e),t.prototype.writeValueExpression=function(e,t,r,o){o&&"web-scene"===o.origin?e&&o.messages&&o.messages.push(new s("property:unsupported",this.declaredClass+".valueExpression is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:"valueExpression",context:o})):t.valueExpression=e},t.prototype.writeValueExpressionTitle=function(e,t,r,o){o&&"web-scene"===o.origin?e&&o.messages&&o.messages.push(new s("property:unsupported",this.declaredClass+".valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:"valueExpressionTitle",context:o})):t.valueExpressionTitle=e},Object.defineProperty(t.prototype,"compiledFunc",{get:function(){return m.createFunction(this.valueExpression)},enumerable:!0,configurable:!0}),t.prototype.readLegendOptions=function(e){return n.clone(e)},t.prototype.writeLegendOptions=function(e,t,r,o){o&&"web-scene"===o.origin?e&&o.messages&&o.messages.push(new s("property:unsupported",this.declaredClass+".legendOptions is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:"legendOptions",context:o})):t.legendOptions=n.clone(e)},Object.defineProperty(t.prototype,"defaultSymbol",{set:function(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)},enumerable:!0,configurable:!0}),t.prototype.readDefaultSymbol=function(e,t,r){return d.read(e,t,r)},t.prototype.writeDefaultSymbol=function(e,t,r,o){if(!this._isDefaultSymbolDerived){var l=d.write(e,{},o);l&&(t.defaultSymbol=l)}},t.prototype.readPortal=function(e,t,r){return r.portal||p.getDefault()},t.prototype.readStyleOrigin=function(e,t,r){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){var o=i.read(t.styleUrl,r);return Object.freeze({styleUrl:o})}},t.prototype.writeStyleOrigin=function(e,t,r,o){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=i.write(e.styleUrl,o))},Object.defineProperty(t.prototype,"uniqueValueInfos",{set:function(e){return this.styleOrigin?void h.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e.slice(0)),void this._updateValueInfoMap())},enumerable:!0,configurable:!0}),t.prototype.readUniqueValueInfos=function(e,t,r){return Array.isArray(e)?e.map(function(e){return e=n.clone(e),e.symbol=d.read(e.symbol,t,r),e}):void 0},t.prototype.writeUniqueValueInfos=function(e,t,r,o){this.styleOrigin||(t.uniqueValueInfos=(this.uniqueValueInfos||[]).map(function(e){return e=n.clone(e),e.symbol&&(e.symbol=d.write(e.symbol,{},o)),e.value=e.value+"",n.fixJson(e)}))},t.prototype.addUniqueValueInfo=function(e,t){if(this.styleOrigin)return void h.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");var r;r="object"==typeof e?e:{value:e,symbol:t},this.uniqueValueInfos.push(r),this._valueInfoMap[r.value+""]=r},t.prototype.removeUniqueValueInfo=function(e){if(this.styleOrigin)return void h.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");for(var t=0;t<this.uniqueValueInfos.length;t++){var r=this.uniqueValueInfos[t];if(r.value+""==e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}},t.prototype.getUniqueValueInfo=function(e,t){var r,o=this.field,l=e.attributes;if(this.valueExpression)r=m.executeFunction(this.compiledFunc,m.createExecContext(e,m.getViewInfo(t)));else if(this.field2){var n=this.field2,i=this.field3,u=[];o&&u.push(l[o]),n&&u.push(l[n]),i&&u.push(l[i]),r=u.join(this.fieldDelimiter||"")}else r=o&&"function"==typeof o?o(e):l[o];return this._valueInfoMap[r+""]},t.prototype.getSymbol=function(e,t){var r=this.getUniqueValueInfo(e,t);return r&&r.symbol||this.defaultSymbol},t.prototype.clone=function(){var e=new g({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:n.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:n.clone(this.visualVariables),legendOptions:n.clone(this.legendOptions),authoringInfo:n.clone(this.authoringInfo)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);var t=n.clone(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(n.clone(this.styleOrigin))),Object.freeze(t)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e},t.prototype.collectRequiredFields=function(e){this.inherited(arguments),[this.field,this.field2,this.field3].forEach(function(t){t&&(e[t]=!0)})},t.prototype.populateFromStyle=function(){var e=this;return y.fetchStyle(this.styleOrigin,{portal:this.portal}).then(function(t){var r=[];return e._valueInfoMap={},t&&t.data&&Array.isArray(t.data.items)&&t.data.items.forEach(function(o){var l=new f({styleUrl:t.styleUrl,styleName:t.styleName,portal:e.portal,name:o.name});e.defaultSymbol||o.name!==t.data.defaultItem||(e.defaultSymbol=l,e._isDefaultSymbolDerived=!0);var n={value:o.name,symbol:l};r.push(n),e._valueInfoMap[o.name]=n}),e._set("uniqueValueInfos",Object.freeze(r)),!e.defaultSymbol&&e.uniqueValueInfos.length&&(e.defaultSymbol=e.uniqueValueInfos[0].symbol,e._isDefaultSymbolDerived=!0),e})},t.prototype._updateValueInfoMap=function(){var e=this;this._valueInfoMap={},this.uniqueValueInfos.forEach(function(t){return e._valueInfoMap[t.value+""]=t})},t.fromPortalStyle=function(e,t){var r=new g(t&&t.properties);r._set("styleOrigin",Object.freeze({styleName:e})),r._set("portal",t&&t.portal||p.getDefault());var o=r.populateFromStyle();return o.otherwise(function(t){h.error("#fromPortalStyle('"+e+"'[, ...])","Failed to create unique value renderer from style name",t)}),o},t.fromStyleUrl=function(e,t){var r=new g(t&&t.properties);r._set("styleOrigin",Object.freeze({styleUrl:e}));var o=r.populateFromStyle();return o.otherwise(function(t){h.error("#fromStyleUrl('"+e+"'[, ...])","Failed to create unique value renderer from style URL",t)}),o},t}(l.declared(c));o([l.property()],b.prototype,"type",void 0),o([l.property({json:{read:{source:"field1"},write:{target:"field1"}}})],b.prototype,"field",void 0),o([l.property({json:{write:!0}})],b.prototype,"field2",void 0),o([l.property({json:{write:!0}})],b.prototype,"field3",void 0),o([l.property({json:{write:!0}})],b.prototype,"valueExpression",void 0),o([l.writer("valueExpression")],b.prototype,"writeValueExpression",null),o([l.property({json:{write:!0}})],b.prototype,"valueExpressionTitle",void 0),o([l.writer("valueExpressionTitle")],b.prototype,"writeValueExpressionTitle",null),o([l.property({dependsOn:["valueExpression"]})],b.prototype,"compiledFunc",null),o([l.property({json:{write:!0}})],b.prototype,"legendOptions",void 0),o([l.reader("legendOptions")],b.prototype,"readLegendOptions",null),o([l.writer("legendOptions")],b.prototype,"writeLegendOptions",null),o([l.property({json:{write:!0}})],b.prototype,"defaultLabel",void 0),o([l.property()],b.prototype,"defaultSymbol",null),o([l.reader("defaultSymbol")],b.prototype,"readDefaultSymbol",null),o([l.writer("defaultSymbol")],b.prototype,"writeDefaultSymbol",null),o([l.property({json:{write:!0}})],b.prototype,"fieldDelimiter",void 0),o([l.property({type:p,readOnly:!0})],b.prototype,"portal",void 0),o([l.reader("portal",["styleName"])],b.prototype,"readPortal",null),o([l.property({readOnly:!0,json:{write:!0}})],b.prototype,"styleOrigin",void 0),o([l.reader("styleOrigin",["styleName","styleUrl"])],b.prototype,"readStyleOrigin",null),o([l.writer("styleOrigin")],b.prototype,"writeStyleOrigin",null),o([l.property()],b.prototype,"uniqueValueInfos",null),o([l.reader("uniqueValueInfos")],b.prototype,"readUniqueValueInfos",null),o([l.writer("uniqueValueInfos")],b.prototype,"writeUniqueValueInfos",null),o([l.property({dependsOn:["field","field2","field3"],readOnly:!0})],b.prototype,"requiredFields",void 0),b=g=o([l.subclass("esri.renderers.UniqueValueRenderer")],b);var g;return b});