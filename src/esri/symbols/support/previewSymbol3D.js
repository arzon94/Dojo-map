// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.4/esri/copyright.txt for details.

define(["require","exports","../../core/Logger","../../core/promiseUtils","../../core/Error","../../core/screenUtils","./symbolUtils","./gfxUtils","./renderUtils","./previewUtils"],function(e,a,r,t,l,s,i,o,n,h){function p(e){var a=e.outline,r=e.get("material.color"),t=r&&r.toRgba().toString();if(!a)return"fill"===e.type&&"255,255,255,1"===t?{color:"#bdc3c7",width:.75}:null;var l=s.pt2px(a.size)||0,i=null!=a.color?a.color.toRgba():"255,255,255,1";return{color:"rgba("+i+")",width:Math.min(l,D)}}function u(e,a){var r=a&&a.resource,l=r&&r.href;return l&&"object"!==a.type?t.resolve(i.getIconHref(e,a)):e.thumbnail&&e.thumbnail.url?t.resolve(e.thumbnail.url):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?i.fetchStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal}).always(function(e){return e&&e.thumbnail&&e.thumbnail.url||E}):t.resolve(E)}function c(e,a){var r=.75;return Math.min(Math.max(e+255*a*r,0),255)}function m(e,a){if(!e.material||!e.material.color){var r=o.defaultThematicColor.r,t=c(r,a);return[t,t,t,100]}for(var l=e.material.color.toRgb(),s=0;3>s;s++)l[s]=c(l[s],a);return l.push(e.material.color.a),l}function f(e){return e.outline?p(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function v(e,a){if(!e.material)return{};for(var r=e.material.color.toRgb(),t="rgba(",l=0;3>l;l++)t+=c(r[l],a)+",";t+=e.material.color.a+");";var i=e.size?s.pt2px(e.size):.75;return{color:t,width:Math.min(i,D)}}function d(e,a,r){var t=.75*r;return{type:"linear",x1:t?.25*t:0,y1:t?.5*t:0,x2:t||4,y2:t?.5*t:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function y(e){var a=e.depth,r=e.height,t=e.width;return t&&a&&r&&t===a&&r>t}function b(e,a,r,t){var l=e&&e.type,s="icon"===l,i="object"===l,o=[];if(s){var n=e,u=0,c=0,v=r,y=r;switch(a){case"circle":o.push({shape:{type:"circle",cx:0,cy:0,r:.5*r},fill:m(n,0),stroke:p(n)});break;case"square":o.push({shape:{type:"path",path:[{command:"M",values:[u,y]},{command:"L",values:[u,c]},{command:"L",values:[v,c]},{command:"L",values:[v,y]},{command:"Z",values:[]}]},fill:m(n,0),stroke:p(n)});break;case"cross":o.push({shape:{type:"path",path:[{command:"M",values:[.5*v,c]},{command:"L",values:[.5*v,y]},{command:"M",values:[u,.5*y]},{command:"L",values:[v,.5*y]},{command:"E",values:[]}]},stroke:f(n)});break;case"x":o.push({shape:{type:"path",path:[{command:"M",values:[u,c]},{command:"L",values:[v,y]},{command:"M",values:[v,c]},{command:"L",values:[u,y]},{command:"E",values:[]}]},stroke:f(n)});break;case"kite":o.push({shape:{type:"path",path:[{command:"M",values:[u,.5*y]},{command:"L",values:[.5*v,c]},{command:"L",values:[v,.5*y]},{command:"L",values:[.5*v,y]},{command:"Z",values:[]}]},fill:m(n,0),stroke:p(n)})}}else if(i){var b=e;switch(a){case"cone":var g=m(b,0),x=m(b,-.6),w=t?I:r,M=d(g,x,w),k=h.getConeShapes(r,t);o.push({shape:k[0],fill:M}),o.push({shape:k[1],fill:M});break;case"inverted-cone":var S=m(b,0),L=m(b,-.6),z=d(S,L,r),E=h.getInvertedConeShapes(r);o.push({shape:E[0],fill:z}),o.push({shape:E[1],fill:S});break;case"cube":var U=h.getCubeShapes(r,t);o.push({shape:U[0],fill:m(b,0)}),o.push({shape:U[1],fill:m(b,-.3)}),o.push({shape:U[2],fill:m(b,-.5)});break;case"cylinder":var C=m(b,0),D=m(b,-.6),j=t?I:r,O=d(C,D,j),P=h.getCylinderShapes(r,t);o.push({shape:P[0],fill:O}),o.push({shape:P[1],fill:O}),o.push({shape:P[2],fill:m(b,0)});break;case"diamond":var R=h.getDiamondShapes(r);o.push({shape:R[0],fill:m(b,-.3)}),o.push({shape:R[1],fill:m(b,0)}),o.push({shape:R[2],fill:m(b,-.3)}),o.push({shape:R[3],fill:m(b,-.7)});break;case"sphere":var T=m(b,0),q=m(b,-.6),A=d(T,q);A.x1=0,A.y1=0,A.x2=.25*r,A.y2=.25*r,o.push({shape:{type:"circle",cx:0,cy:0,r:.5*r},fill:A});break;case"tetrahedron":var H=h.getTetrahedronShapes(r);o.push({shape:H[0],fill:m(b,-.3)}),o.push({shape:H[1],fill:m(b,0)}),o.push({shape:H[2],fill:m(b,-.6)})}}return o}function g(e,a){var r,l=a&&a.size?s.pt2px(a.size):null,i=a&&a.maxSize?s.pt2px(a.maxSize):null,o=a&&a.disableUpsampling,h=e.symbolLayers,c=[],m=0,f=0,v=h.getItemAt(h.length-1);return v&&"icon"===v.type&&(r=v.size&&s.pt2px(v.size)),h.forEach(function(v,d){var g=v&&v.type,x="icon"===g,w="object"===g,M=v,k=x?M.size&&s.pt2px(M.size):0,S=l||k?Math.ceil(Math.min(l||k,i||C)):U;if(x||w){var L=p(v),z=L?L.width:0;if(v&&v.resource&&v.resource.href){var E=u(e,v).then(function(e){return n.tintImageWithColor(e,S,v.get("material.color"),o)}).then(function(e){var a=e.width,r=e.height;return m=Math.max(m,a+2*z),f=Math.max(f,r+2*z),[{shape:{type:"image",width:a,height:r,src:e.url},fill:null,stroke:null}]});c.unshift(E)}else{var D=v.get("resource.primitive"),j=D?D:x?"circle":"sphere",O=S;x&&(O=d<h.length-1&&l?S*(k/r):S);var P=a&&"tall"===a.symbolConfig||(w?y(v):!1);m=Math.max(m,P?I:O+2*z),f=Math.max(f,O+2*z),c.unshift(t.resolve(b(v,j,O,P)))}}}),t.eachAlways(c).then(function(e){var r=[];return e.forEach(function(e){e.value?r.push(e.value):e.error&&O.warn("error while building swatchInfo!",e.error)}),n.renderSymbol(r,[m,f],{node:a&&a.node,scale:!1})})}function x(e,a){var r,l=e.symbolLayers,o=[],p=i.isVolumetricSymbol(e),u=a&&a.size?s.pt2px(a.size):null,c=a&&a.maxSize?s.pt2px(a.maxSize):null,f=c||D,d=0,y=0;return l.forEach(function(e,a){var t=e&&e.type,l="line"===t,s="path"===t;if(l||s){var i=v(e,0),n=i&&i.width||0,p=[];if(l){0===a&&(r=n);var c=Math.min(u||n,f),b=0===a?c:u?c*(n/r):c,g=b>U?2*b:j;y=Math.max(y,b),d=Math.max(d,g),i.width=b,p.push({shape:{type:"path",path:[{command:"M",values:[0,.5*y]},{command:"L",values:[d,.5*y]},{command:"E",values:[]}]},stroke:i})}else{var x=Math.min(u||U,f),w=m(e,0),M=m(e,-.2),k=v(e,-.4),S=1;k.width=S,p.push({shape:h.shapes.pathSymbol3DLayer[0],fill:M,stroke:k}),p.push({shape:h.shapes.pathSymbol3DLayer[1],fill:w,stroke:k}),y=Math.max(y,x+2*S),d=y}o.push(p)}}),t.resolve(n.renderSymbol(o,[d,y],{node:a&&a.node,scale:p}))}function w(e,a){var r=e.type,l=r===z,i=e.symbolLayers,o=a&&a.size?s.pt2px(a.size):null,u=a&&a.maxSize?s.pt2px(a.maxSize):null,c=o||U,f=[],d=0,y=0;return i.forEach(function(e){var a=e.type,r="fill"===a,t="line"===a,s="extrude"===e.type,i=[];if(!l||r){var o=h.shapes.fill[0];if(r){var n=p(e),b=n&&n.width||0;d=Math.max(d,U+b),y=Math.max(y,U+b),i.push({shape:o,fill:m(e,0),stroke:n})}else if(t){var g=v(e,0),x=g&&g.width||0,w={stroke:g,shape:o};d=Math.max(d,U+x),y=Math.max(y,U+x),i.push(w)}else if(s){var M=v(e,-.4),k=m(e,0),S=m(e,-.2),L=Math.min(c,u||C),z=h.getExtrudeSymbolShapes(L);M.width=1,i.push({shape:z[0],fill:S,stroke:M}),i.push({shape:z[1],fill:S,stroke:M}),i.push({shape:z[2],fill:k,stroke:M});var E=U,D=.7*U+.5*L;d=Math.max(d,E+2*M.width),y=Math.max(y,D+2*M.width)}f.push(i)}}),t.resolve(n.renderSymbol(f,[d,y],{node:a&&a.node,scale:!1}))}function M(e,a){var r=e;if(0===r.symbolLayers.length)return t.reject(new l("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var s=null;switch(e.type){case k:s=g(r,a);break;case S:s=x(r,a);break;case L:case z:s=w(r,a)}return s?s:t.reject(new l("symbolPreview: swatchInfo3D","symbol not supported."))}Object.defineProperty(a,"__esModule",{value:!0});var k="point-symbol-3d",S="line-symbol-3d",L="polygon-symbol-3d",z="mesh-symbol-3d",E=e.toUrl("../../images/Legend/legend3dsymboldefault.png"),U=22,C=120,D=80,j=40,I=20,O=r.getLogger("esri.symbols.support.previewSymbol3D");a.previewSymbol3D=M});